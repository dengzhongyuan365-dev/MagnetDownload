# ç£åŠ›é“¾æ¥ä¸‹è½½å®Œæ•´æµç¨‹

> **é—®é¢˜**ï¼šå®ç°ç£åŠ›é“¾æ¥ä¸‹è½½ï¼ŒBencode æ˜¯å¿…éœ€çš„å—ï¼Ÿ
> 
> **ç­”æ¡ˆ**ï¼š**æ˜¯çš„ï¼Œç»å¯¹å¿…éœ€ï¼**

---

## ğŸ”„ å®Œæ•´çš„ä¸‹è½½æµç¨‹

### æµç¨‹å›¾ï¼ˆMermaidï¼‰

```mermaid
flowchart TD
    Start([ç”¨æˆ·è¾“å…¥ç£åŠ›é“¾æ¥]) --> Parse[æ­¥éª¤1: è§£æç£åŠ›é“¾æ¥]
    Parse --> |InfoHash| DHT[æ­¥éª¤2: DHTæŸ¥æ‰¾Peer éœ€è¦Bencode]
    DHT --> |Peeråˆ—è¡¨| Connect[æ­¥éª¤3: è¿æ¥Peer]
    Connect --> Metadata[æ­¥éª¤4: è·å–å…ƒæ•°æ® éœ€è¦Bencode]
    Metadata --> Download[æ­¥éª¤5: ä¸‹è½½æ–‡ä»¶æ•°æ®]
    Download --> End([ä¸‹è½½å®Œæˆ])
    
    style Parse fill:#e1f5ff
    style DHT fill:#ffe1e1
    style Connect fill:#e1f5ff
    style Metadata fill:#ffe1e1
    style Download fill:#e1f5ff
    style Start fill:#d4edda
    style End fill:#d4edda
```

### æ—¶åºå›¾ï¼ˆMermaidï¼‰

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Parser as MagnetUriParser
    participant DHT as DHTClient
    participant Bencode as Bencode
    participant UDP as UdpClient
    participant DHTNode as DHTèŠ‚ç‚¹
    participant Peer as PeerèŠ‚ç‚¹
    participant PeerMgr as PeerManager
    
    User->>Parser: ç£åŠ›é“¾æ¥
    Parser->>Parser: è§£æ URI
    Parser-->>User: InfoHash
    
    User->>DHT: find_peers(InfoHash)
    DHT->>Bencode: encode(æŸ¥è¯¢æ¶ˆæ¯)
    Bencode-->>DHT: Bencode æ•°æ®
    DHT->>UDP: send(æŸ¥è¯¢)
    UDP->>DHTNode: UDP æ•°æ®åŒ…
    
    DHTNode->>UDP: å“åº”æ•°æ®åŒ…
    UDP->>DHT: æ¥æ”¶å“åº”
    DHT->>Bencode: decode(å“åº”)
    Bencode-->>DHT: Peer åˆ—è¡¨
    DHT-->>User: Peer åˆ—è¡¨
    
    User->>PeerMgr: connect(Peer)
    PeerMgr->>Peer: TCP è¿æ¥
    PeerMgr->>Peer: BitTorrent æ¡æ‰‹
    PeerMgr->>Peer: è¯·æ±‚å…ƒæ•°æ®
    
    Peer->>PeerMgr: å…ƒæ•°æ®(Bencode)
    PeerMgr->>Bencode: decode(å…ƒæ•°æ®)
    Bencode-->>PeerMgr: æ–‡ä»¶ä¿¡æ¯
    PeerMgr-->>User: æ–‡ä»¶ä¿¡æ¯
    
    User->>PeerMgr: å¼€å§‹ä¸‹è½½
    loop ä¸‹è½½æ¯ä¸ª Piece
        PeerMgr->>Peer: è¯·æ±‚ Piece
        Peer->>PeerMgr: Piece æ•°æ®
        PeerMgr->>PeerMgr: éªŒè¯å“ˆå¸Œ
        PeerMgr->>PeerMgr: å†™å…¥æ–‡ä»¶
    end
    
    PeerMgr-->>User: ä¸‹è½½å®Œæˆ
```

---

## ğŸ“Š æ¨¡å—ä¾èµ–å…³ç³»

### æ¶æ„å›¾ï¼ˆMermaidï¼‰

```mermaid
graph TB
    subgraph APP[åº”ç”¨å±‚]
        DM[DownloadManager]
    end
    
    subgraph BIZ[ä¸šåŠ¡å±‚]
        PM[PeerManager]
        DHT[DHTClient]
        Parser[MagnetUriParser]
    end
    
    subgraph PROTO[åè®®å±‚]
        Bencode[Bencode å¿…éœ€]
        BT[BitTorrent]
    end
    
    subgraph NET[ç½‘ç»œå±‚]
        UDP[UdpClient]
        TCP[TcpConnection]
    end
    
    subgraph BASE[åŸºç¡€å±‚]
        ELM[EventLoopManager]
        Logger[Logger]
    end
    
    DM --> PM
    DM --> DHT
    DM --> Parser
    
    PM --> BT
    PM --> TCP
    PM --> Bencode
    
    DHT --> Bencode
    DHT --> UDP
    
    BT --> Bencode
    
    UDP --> ELM
    TCP --> ELM
    
    PM --> Logger
    DHT --> Logger
    
    style Bencode fill:#ffe1e1,stroke:#ff0000,stroke-width:3px
    style DM fill:#e1f5ff
    style PM fill:#e1f5ff
    style DHT fill:#e1f5ff
    style Parser fill:#e1f5ff
```

### ä¾èµ–å…³ç³»è¯¦è§£

```mermaid
graph LR
    A[DownloadManager] -->|ä½¿ç”¨| B[PeerManager]
    A -->|ä½¿ç”¨| C[DHTClient]
    A -->|ä½¿ç”¨| D[MagnetUriParser]
    
    B -->|ä½¿ç”¨| E[Bencode]
    B -->|ä½¿ç”¨| F[TcpConnection]
    
    C -->|ä½¿ç”¨| E
    C -->|ä½¿ç”¨| G[UdpClient]
    
    E -.->|æ ¸å¿ƒä¾èµ–| H[DHTåè®®]
    E -.->|æ ¸å¿ƒä¾èµ–| I[å…ƒæ•°æ®è§£æ]
    
    G -->|ä½¿ç”¨| J[EventLoopManager]
    F -->|ä½¿ç”¨| J
    
    style E fill:#ffe1e1,stroke:#ff0000,stroke-width:3px
    style H fill:#fff3cd
    style I fill:#fff3cd
```

### æœ€å°å¯å·¥ä½œç³»ç»Ÿ

è¦å®ç°ç£åŠ›é“¾æ¥ä¸‹è½½ï¼Œ**æœ€å°‘éœ€è¦**ï¼š

```
âœ… MagnetUriParser  - è§£æç£åŠ›é“¾æ¥
âœ… Bencode          - ç¼–è§£ç  DHT æ¶ˆæ¯å’Œå…ƒæ•°æ®
âœ… UdpClient        - UDP é€šä¿¡
âœ… DHTClient        - æŸ¥æ‰¾ Peer
âœ… TcpConnection    - è¿æ¥ Peer
âœ… PeerManager      - ç®¡ç† Peer å’Œä¸‹è½½æ•°æ®
```

