# ä»»åŠ¡æ‹†åˆ†ä¸è°ƒåº¦ç­–ç•¥

> **æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•å°†ç£åŠ›é“¾æ¥ä¸‹è½½æ‹†åˆ†æˆå¯è°ƒåº¦çš„ä»»åŠ¡ï¼Ÿ

---

## ğŸ“‹ ç›®å½•

1. [ä»»åŠ¡å±‚æ¬¡ç»“æ„](#1-ä»»åŠ¡å±‚æ¬¡ç»“æ„)
2. [å•ä¸ªç£åŠ›é“¾æ¥çš„ä»»åŠ¡æ‹†åˆ†](#2-å•ä¸ªç£åŠ›é“¾æ¥çš„ä»»åŠ¡æ‹†åˆ†)
3. [å¤šä¸ªç£åŠ›é“¾æ¥çš„ä»»åŠ¡ç®¡ç†](#3-å¤šä¸ªç£åŠ›é“¾æ¥çš„ä»»åŠ¡ç®¡ç†)
4. [ä»»åŠ¡ä¼˜å…ˆçº§åˆ†é…](#4-ä»»åŠ¡ä¼˜å…ˆçº§åˆ†é…)
5. [ä»»åŠ¡è°ƒåº¦ç­–ç•¥](#5-ä»»åŠ¡è°ƒåº¦ç­–ç•¥)
6. [å®é™…ä»£ç ç¤ºä¾‹](#6-å®é™…ä»£ç ç¤ºä¾‹)

---

## 1. ä»»åŠ¡å±‚æ¬¡ç»“æ„

### 1.1 ä¸‰å±‚ä»»åŠ¡æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ä¸‹è½½ä»»åŠ¡ (DownloadTask)                 â”‚
â”‚              ä¸€ä¸ªç£åŠ›é“¾æ¥ = ä¸€ä¸ªä¸‹è½½ä»»åŠ¡                  â”‚
â”‚                    TaskId: "task_001"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ åŒ…å«
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  é˜¶æ®µä»»åŠ¡ (PhaseTask)                    â”‚
â”‚        è§£æã€DHTæŸ¥è¯¢ã€è¿æ¥ã€ä¸‹è½½ã€æ ¡éªŒç­‰é˜¶æ®µ              â”‚
â”‚     PhaseId: "task_001_phase_dht"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ åŒ…å«
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŸå­ä»»åŠ¡ (AtomicTask)                   â”‚
â”‚        å‘é€æ¶ˆæ¯ã€æ¥æ”¶æ•°æ®ã€å†™æ–‡ä»¶ç­‰ä¸å¯åˆ†å‰²æ“ä½œ           â”‚
â”‚     AtomicId: "task_001_phase_dht_send_001"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä»»åŠ¡ç±»å‹å®šä¹‰

```cpp
// ä¸‹è½½ä»»åŠ¡ï¼ˆé¡¶å±‚ï¼‰
struct DownloadTask {
    TaskId id;                          // å”¯ä¸€æ ‡è¯†
    std::string magnet_uri;             // ç£åŠ›é“¾æ¥
    std::string save_path;              // ä¿å­˜è·¯å¾„
    DownloadState state;                // å½“å‰çŠ¶æ€
    std::vector<PhaseTask> phases;      // åŒ…å«çš„é˜¶æ®µä»»åŠ¡
    DownloadProgress progress;          // ä¸‹è½½è¿›åº¦
};

// é˜¶æ®µä»»åŠ¡ï¼ˆä¸­å±‚ï¼‰
struct PhaseTask {
    PhaseId id;
    PhaseType type;                     // è§£æ/DHT/è¿æ¥/ä¸‹è½½/æ ¡éªŒ
    TaskPriority priority;              // ä¼˜å…ˆçº§
    std::vector<AtomicTask> atomic_tasks; // åŸå­ä»»åŠ¡
    PhaseState state;
};

// åŸå­ä»»åŠ¡ï¼ˆåº•å±‚ï¼‰
struct AtomicTask {
    AtomicId id;
    TaskPriority priority;
    std::function<void()> execute;      // æ‰§è¡Œå‡½æ•°
    TaskState state;
};
```

---

## 2. å•ä¸ªç£åŠ›é“¾æ¥çš„ä»»åŠ¡æ‹†åˆ†

### 2.1 å®Œæ•´çš„ä»»åŠ¡åˆ†è§£æµç¨‹

```
ç”¨æˆ·è¾“å…¥ï¼šmagnet:?xt=urn:btih:HASH&dn=file.mp4
    â†“
åˆ›å»º DownloadTask (task_001)
    â†“
æ‹†åˆ†ä¸º 5 ä¸ªé˜¶æ®µä»»åŠ¡ (PhaseTask)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 1ï¼šè§£æç£åŠ›é“¾æ¥ (PARSE)                             â”‚
â”‚ Priority: CRITICAL                                      â”‚
â”‚                                                         â”‚
â”‚ AtomicTask 1.1: è§£æ URI æ ¼å¼                           â”‚
â”‚ AtomicTask 1.2: æå– InfoHash                           â”‚
â”‚ AtomicTask 1.3: æå–æ–‡ä»¶åå’Œ Tracker                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 2ï¼šDHT ç½‘ç»œæŸ¥è¯¢ (DHT_QUERY)                         â”‚
â”‚ Priority: HIGH                                          â”‚
â”‚                                                         â”‚
â”‚ AtomicTask 2.1: è¿æ¥å¼•å¯¼èŠ‚ç‚¹                             â”‚
â”‚ AtomicTask 2.2: å‘é€ find_node è¯·æ±‚                     â”‚
â”‚ AtomicTask 2.3: å¤„ç† find_node å“åº”                     â”‚
â”‚ AtomicTask 2.4: å‘é€ get_peers è¯·æ±‚                     â”‚
â”‚ AtomicTask 2.5: å¤„ç† get_peers å“åº”                     â”‚
â”‚ AtomicTask 2.6: æ”¶é›† Peer åˆ—è¡¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 3ï¼šè¿æ¥ Peer å¹¶è·å–å…ƒæ•°æ® (METADATA)                â”‚
â”‚ Priority: HIGH                                          â”‚
â”‚                                                         â”‚
â”‚ å¯¹æ¯ä¸ª Peer (å¹¶å‘):                                     â”‚
â”‚   AtomicTask 3.1: å»ºç«‹ TCP è¿æ¥                         â”‚
â”‚   AtomicTask 3.2: å‘é€æ¡æ‰‹æ¶ˆæ¯                          â”‚
â”‚   AtomicTask 3.3: æ¥æ”¶æ¡æ‰‹å“åº”                          â”‚
â”‚   AtomicTask 3.4: è¯·æ±‚å…ƒæ•°æ®åˆ†ç‰‡                        â”‚
â”‚   AtomicTask 3.5: æ¥æ”¶å…ƒæ•°æ®åˆ†ç‰‡                        â”‚
â”‚   AtomicTask 3.6: ç»„è£…å®Œæ•´å…ƒæ•°æ®                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 4ï¼šä¸‹è½½æ–‡ä»¶æ•°æ® (DOWNLOAD)                          â”‚
â”‚ Priority: NORMAL                                        â”‚
â”‚                                                         â”‚
â”‚ å¯¹æ¯ä¸ªåˆ†ç‰‡ (å¹¶å‘):                                       â”‚
â”‚   AtomicTask 4.1: é€‰æ‹©ä¸‹è½½åˆ†ç‰‡                          â”‚
â”‚   AtomicTask 4.2: é€‰æ‹© Peer                             â”‚
â”‚   AtomicTask 4.3: å‘é€ request æ¶ˆæ¯                     â”‚
â”‚   AtomicTask 4.4: æ¥æ”¶ piece æ•°æ®                       â”‚
â”‚   AtomicTask 4.5: æ ¡éªŒåˆ†ç‰‡å“ˆå¸Œ                          â”‚
â”‚   AtomicTask 4.6: å†™å…¥ç£ç›˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ 5ï¼šæœ€ç»ˆæ ¡éªŒå’Œæ¸…ç† (FINALIZE)                        â”‚
â”‚ Priority: NORMAL                                        â”‚
â”‚                                                         â”‚
â”‚ AtomicTask 5.1: æ ¡éªŒæ‰€æœ‰åˆ†ç‰‡å®Œæ•´æ€§                       â”‚
â”‚ AtomicTask 5.2: å…³é—­æ‰€æœ‰è¿æ¥                            â”‚
â”‚ AtomicTask 5.3: æ›´æ–°ä»»åŠ¡çŠ¶æ€                            â”‚
â”‚ AtomicTask 5.4: é€šçŸ¥ç”¨æˆ·å®Œæˆ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä»»åŠ¡çŠ¶æ€è½¬æ¢

```
DownloadTask çŠ¶æ€æœºï¼š

CREATED â†’ PARSING â†’ DHT_QUERYING â†’ CONNECTING â†’ DOWNLOADING â†’ FINALIZING â†’ COMPLETED
   â†“         â†“           â†“              â†“            â†“             â†“            â†“
 FAILED   FAILED      FAILED         FAILED       FAILED        FAILED      SUCCESS

å¯æš‚åœçŠ¶æ€ï¼šDOWNLOADING
å¯æ¢å¤çŠ¶æ€ï¼šDOWNLOADING
å¯å–æ¶ˆçŠ¶æ€ï¼šä»»ä½•çŠ¶æ€
```

---

## 3. å¤šä¸ªç£åŠ›é“¾æ¥çš„ä»»åŠ¡ç®¡ç†

### 3.1 å¤šä»»åŠ¡å¹¶å‘æ¨¡å‹

```
ç”¨æˆ·è¾“å…¥ 3 ä¸ªç£åŠ›é“¾æ¥ï¼š
    magnet_uri_1 (ç”µå½±)
    magnet_uri_2 (éŸ³ä¹)
    magnet_uri_3 (æ–‡æ¡£)
    â†“
DownloadManager åˆ›å»º 3 ä¸ª DownloadTask
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DownloadTask Queue                         â”‚
â”‚                                                         â”‚
â”‚  task_001 (ç”µå½±) â”€â”                                     â”‚
â”‚  task_002 (éŸ³ä¹) â”€â”¼â”€> å¹¶å‘æ‰§è¡Œ                          â”‚
â”‚  task_003 (æ–‡æ¡£) â”€â”˜                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ¯ä¸ª DownloadTask ç‹¬ç«‹æ‹†åˆ†ä¸ºé˜¶æ®µä»»åŠ¡
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TaskScheduler (å…¨å±€è°ƒåº¦å™¨)                  â”‚
â”‚                                                         â”‚
â”‚  æ‰€æœ‰ DownloadTask çš„æ‰€æœ‰ AtomicTask ç»Ÿä¸€è°ƒåº¦            â”‚
â”‚                                                         â”‚
â”‚  ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š                                            â”‚
â”‚    CRITICAL: [task_001_parse, task_002_parse, ...]     â”‚
â”‚    HIGH:     [task_001_dht, task_002_dht, ...]         â”‚
â”‚    NORMAL:   [task_001_download, task_002_download]    â”‚
â”‚    LOW:      [task_001_stats, task_002_stats]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
EventLoopManager æ‰§è¡Œä»»åŠ¡
```

### 3.2 èµ„æºåˆ†é…ç­–ç•¥

**å¹¶å‘é™åˆ¶**ï¼š
```cpp
struct ResourceLimits {
    size_t max_concurrent_downloads = 3;      // æœ€å¤šåŒæ—¶ä¸‹è½½ 3 ä¸ªæ–‡ä»¶
    size_t max_peers_per_download = 50;       // æ¯ä¸ªä¸‹è½½æœ€å¤š 50 ä¸ª Peer
    size_t max_total_connections = 150;       // å…¨å±€æœ€å¤š 150 ä¸ªè¿æ¥
    size_t max_disk_io_tasks = 10;            // æœ€å¤š 10 ä¸ªç£ç›˜ I/O ä»»åŠ¡
};
```

**èµ„æºåˆ†é…ç®—æ³•**ï¼š
```
1. ä¼˜å…ˆåˆ†é…ç»™é«˜ä¼˜å…ˆçº§ä»»åŠ¡
2. å…¬å¹³åˆ†é…ï¼šæ¯ä¸ªæ´»è·ƒä»»åŠ¡è‡³å°‘åˆ†é…æœ€å°èµ„æº
3. åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®ä»»åŠ¡è¿›åº¦åŠ¨æ€åˆ†é…
```

### 3.3 ä»»åŠ¡é—´åè°ƒ

```cpp
class DownloadManager {
private:
    // æ‰€æœ‰ä¸‹è½½ä»»åŠ¡
    std::unordered_map<TaskId, DownloadTask> tasks_;
    
    // èµ„æºç®¡ç†
    ResourceManager resource_manager_;
    
    // å…¨å±€è°ƒåº¦å™¨
    TaskScheduler& scheduler_;
    
public:
    // æ·»åŠ æ–°ä»»åŠ¡
    TaskId add_download(const std::string& magnet_uri) {
        auto task = create_download_task(magnet_uri);
        tasks_[task.id] = task;
        
        // æ‹†åˆ†å¹¶è°ƒåº¦ä»»åŠ¡
        decompose_and_schedule(task);
        
        return task.id;
    }
    
    // æ‹†åˆ†ä»»åŠ¡
    void decompose_and_schedule(DownloadTask& task) {
        // é˜¶æ®µ 1ï¼šè§£æï¼ˆç«‹å³æ‰§è¡Œï¼‰
        schedule_parse_phase(task);
        
        // é˜¶æ®µ 2-5ï¼šæ ¹æ®å‰ä¸€é˜¶æ®µç»“æœåŠ¨æ€è°ƒåº¦
        // ä½¿ç”¨å›è°ƒé“¾æ¥å„é˜¶æ®µ
    }
};
```

---

## 4. ä»»åŠ¡ä¼˜å…ˆçº§åˆ†é…

### 4.1 ä¼˜å…ˆçº§åˆ†é…è§„åˆ™

```cpp
enum class TaskPriority {
    CRITICAL = 0,  // ç”¨æˆ·äº¤äº’ã€ç´§æ€¥é”™è¯¯
    HIGH     = 1,  // DHT æŸ¥è¯¢ã€Peer è¿æ¥
    NORMAL   = 2,  // æ•°æ®ä¸‹è½½ã€æ–‡ä»¶å†™å…¥
    LOW      = 3   // ç»Ÿè®¡ã€æ—¥å¿—ã€æ¸…ç†
};

// ä¼˜å…ˆçº§åˆ†é…ç­–ç•¥
TaskPriority assign_priority(const AtomicTask& task) {
    switch (task.phase_type) {
        case PhaseType::PARSE:
            return TaskPriority::CRITICAL;  // è§£æå¿…é¡»ç«‹å³å®Œæˆ
            
        case PhaseType::DHT_QUERY:
            return TaskPriority::HIGH;      // DHT æŸ¥è¯¢å½±å“åç»­æµç¨‹
            
        case PhaseType::METADATA:
            return TaskPriority::HIGH;      // å…ƒæ•°æ®è·å–æ˜¯å…³é”®è·¯å¾„
            
        case PhaseType::DOWNLOAD:
            // æ ¹æ®ç”¨æˆ·è®¾ç½®å’Œä»»åŠ¡çŠ¶æ€åŠ¨æ€è°ƒæ•´
            if (task.is_user_priority) {
                return TaskPriority::HIGH;
            }
            return TaskPriority::NORMAL;
            
        case PhaseType::FINALIZE:
            return TaskPriority::NORMAL;
            
        case PhaseType::STATISTICS:
            return TaskPriority::LOW;       // ç»Ÿè®¡ä¸å½±å“åŠŸèƒ½
    }
}
```

### 4.2 åŠ¨æ€ä¼˜å…ˆçº§è°ƒæ•´

```cpp
// è€åŒ–æœºåˆ¶ï¼šé˜²æ­¢ä½ä¼˜å…ˆçº§ä»»åŠ¡é¥¥é¥¿
void TaskScheduler::age_tasks() {
    auto now = std::chrono::steady_clock::now();
    
    for (auto& task : pending_tasks_) {
        auto wait_time = now - task.created_time;
        
        // ç­‰å¾…è¶…è¿‡ 5 ç§’ï¼Œæå‡ä¼˜å…ˆçº§
        if (wait_time > std::chrono::seconds(5)) {
            if (task.priority < TaskPriority::CRITICAL) {
                task.priority = static_cast<TaskPriority>(
                    static_cast<int>(task.priority) - 1
                );
            }
        }
    }
}
```

---

## 5. ä»»åŠ¡è°ƒåº¦ç­–ç•¥

### 5.1 è°ƒåº¦ç®—æ³•

```cpp
class TaskScheduler {
public:
    void schedule() {
        while (running_) {
            // 1. ä»ä¼˜å…ˆçº§é˜Ÿåˆ—è·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡
            auto task = get_highest_priority_task();
            
            // 2. æ£€æŸ¥èµ„æºæ˜¯å¦å¯ç”¨
            if (!resource_manager_.can_execute(task)) {
                // èµ„æºä¸è¶³ï¼Œç­‰å¾…æˆ–é™çº§
                handle_resource_shortage(task);
                continue;
            }
            
            // 3. åˆ†é…èµ„æº
            resource_manager_.allocate(task);
            
            // 4. æäº¤åˆ° EventLoopManager æ‰§è¡Œ
            event_loop_manager_.post_to_least_loaded([task]() {
                task.execute();
            });
            
            // 5. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            update_statistics(task);
        }
    }
    
private:
    std::priority_queue<AtomicTask, 
                        std::vector<AtomicTask>,
                        TaskComparator> task_queue_;
};
```

### 5.2 ä»»åŠ¡ä¾èµ–å¤„ç†

```cpp
// ä»»åŠ¡ä¾èµ–å›¾
struct TaskDependency {
    AtomicTask task;
    std::vector<AtomicTask*> dependencies;  // ä¾èµ–çš„ä»»åŠ¡
    std::atomic<size_t> pending_count;      // æœªå®Œæˆçš„ä¾èµ–æ•°
};

// ä¾èµ–è§£æ
void schedule_with_dependencies(AtomicTask task) {
    auto deps = analyze_dependencies(task);
    
    if (deps.empty()) {
        // æ— ä¾èµ–ï¼Œç›´æ¥è°ƒåº¦
        scheduler_.post_task(task.priority, task.execute);
    } else {
        // æœ‰ä¾èµ–ï¼Œç­‰å¾…ä¾èµ–å®Œæˆ
        for (auto& dep : deps) {
            dep->on_complete([task, this]() {
                if (--task.pending_count == 0) {
                    // æ‰€æœ‰ä¾èµ–å®Œæˆï¼Œè°ƒåº¦ä»»åŠ¡
                    scheduler_.post_task(task.priority, task.execute);
                }
            });
        }
    }
}
```

---

## 6. å®é™…ä»£ç ç¤ºä¾‹

### 6.1 å•ä¸ªç£åŠ›é“¾æ¥çš„å®Œæ•´æ‹†åˆ†

```cpp
class DownloadManager {
public:
    TaskId start_download(const std::string& magnet_uri, 
                          const std::string& save_path) {
        // åˆ›å»ºä¸‹è½½ä»»åŠ¡
        auto task_id = generate_task_id();
        auto task = std::make_shared<DownloadTask>();
        task->id = task_id;
        task->magnet_uri = magnet_uri;
        task->save_path = save_path;
        task->state = DownloadState::CREATED;
        
        tasks_[task_id] = task;
        
        // å¼€å§‹ä»»åŠ¡æ‹†åˆ†å’Œè°ƒåº¦
        decompose_and_schedule(task);
        
        return task_id;
    }
    
private:
    void decompose_and_schedule(std::shared_ptr<DownloadTask> task) {
        // é˜¶æ®µ 1ï¼šè§£æç£åŠ›é“¾æ¥
        schedule_parse_phase(task);
    }
    
    void schedule_parse_phase(std::shared_ptr<DownloadTask> task) {
        scheduler_.post_task(TaskPriority::CRITICAL, [this, task]() {
            // åŸå­ä»»åŠ¡ 1.1: è§£æ URI
            auto magnet_info = magnet_parser_.parse(task->magnet_uri);
            
            if (!magnet_info) {
                task->state = DownloadState::FAILED;
                return;
            }
            
            task->magnet_info = *magnet_info;
            task->state = DownloadState::PARSING_COMPLETE;
            
            // è§£æå®Œæˆï¼Œè°ƒåº¦ä¸‹ä¸€é˜¶æ®µ
            schedule_dht_phase(task);
        });
    }
    
    void schedule_dht_phase(std::shared_ptr<DownloadTask> task) {
        task->state = DownloadState::DHT_QUERYING;
        
        // åŸå­ä»»åŠ¡ 2.1-2.6: DHT æŸ¥è¯¢
        scheduler_.post_task(TaskPriority::HIGH, [this, task]() {
            dht_client_.find_peers(
                task->magnet_info.info_hash,
                [this, task](std::vector<PeerInfo> peers) {
                    task->peers = peers;
                    task->state = DownloadState::DHT_COMPLETE;
                    
                    // DHT å®Œæˆï¼Œè°ƒåº¦è¿æ¥é˜¶æ®µ
                    schedule_connect_phase(task);
                }
            );
        });
    }
    
    void schedule_connect_phase(std::shared_ptr<DownloadTask> task) {
        task->state = DownloadState::CONNECTING;
        
        // å¯¹æ¯ä¸ª Peer å¹¶å‘è¿æ¥ï¼ˆåŸå­ä»»åŠ¡ 3.1-3.6ï¼‰
        for (const auto& peer : task->peers) {
            scheduler_.post_task(TaskPriority::HIGH, [this, task, peer]() {
                peer_manager_.connect_to_peer(
                    peer,
                    task->magnet_info.info_hash,
                    [this, task](PeerConnection::Ptr connection) {
                        if (!connection) return;
                        
                        // è·å–å…ƒæ•°æ®
                        connection->fetch_metadata([this, task](TorrentMetadata metadata) {
                            task->metadata = metadata;
                            task->state = DownloadState::METADATA_COMPLETE;
                            
                            // å…ƒæ•°æ®å®Œæˆï¼Œè°ƒåº¦ä¸‹è½½é˜¶æ®µ
                            schedule_download_phase(task);
                        });
                    }
                );
            });
        }
    }
    
    void schedule_download_phase(std::shared_ptr<DownloadTask> task) {
        task->state = DownloadState::DOWNLOADING;
        
        // åˆå§‹åŒ–åˆ†ç‰‡ç®¡ç†
        piece_manager_.initialize(task->metadata);
        
        // å¯¹æ¯ä¸ªåˆ†ç‰‡åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ˆåŸå­ä»»åŠ¡ 4.1-4.6ï¼‰
        for (size_t i = 0; i < task->metadata.piece_count; ++i) {
            scheduler_.post_task(TaskPriority::NORMAL, [this, task, i]() {
                download_piece(task, i);
            });
        }
    }
    
    void download_piece(std::shared_ptr<DownloadTask> task, size_t piece_index) {
        // é€‰æ‹© Peer
        auto peer = select_peer_for_piece(task, piece_index);
        
        // è¯·æ±‚åˆ†ç‰‡
        peer->request_piece(piece_index, [this, task, piece_index](std::vector<byte> data) {
            // æ ¡éªŒæ•°æ®
            if (data_verifier_.verify(piece_index, data, task->metadata)) {
                // å†™å…¥ç£ç›˜
                file_writer_.write_piece(piece_index, data, [this, task]() {
                    // æ›´æ–°è¿›åº¦
                    task->progress.completed_pieces++;
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                    if (task->progress.completed_pieces == task->metadata.piece_count) {
                        schedule_finalize_phase(task);
                    }
                });
            } else {
                // æ ¡éªŒå¤±è´¥ï¼Œé‡æ–°ä¸‹è½½
                scheduler_.post_task(TaskPriority::NORMAL, [this, task, piece_index]() {
                    download_piece(task, piece_index);
                });
            }
        });
    }
    
    void schedule_finalize_phase(std::shared_ptr<DownloadTask> task) {
        scheduler_.post_task(TaskPriority::NORMAL, [this, task]() {
            // æœ€ç»ˆæ ¡éªŒ
            if (verify_complete_file(task)) {
                task->state = DownloadState::COMPLETED;
                notify_user(task->id, "ä¸‹è½½å®Œæˆ");
            } else {
                task->state = DownloadState::FAILED;
                notify_user(task->id, "æ ¡éªŒå¤±è´¥");
            }
        });
    }
};
```

### 6.2 å¤šä¸ªç£åŠ›é“¾æ¥çš„å¹¶å‘ç®¡ç†

```cpp
// ç”¨æˆ·æ·»åŠ  3 ä¸ªä¸‹è½½ä»»åŠ¡
auto task1 = download_manager.start_download("magnet:?xt=...", "./downloads/");
auto task2 = download_manager.start_download("magnet:?xt=...", "./downloads/");
auto task3 = download_manager.start_download("magnet:?xt=...", "./downloads/");

// DownloadManager å†…éƒ¨å¤„ç†
class DownloadManager {
private:
    // æ‰€æœ‰ä»»åŠ¡å…±äº«åŒä¸€ä¸ªè°ƒåº¦å™¨
    TaskScheduler& scheduler_;
    
    // èµ„æºç®¡ç†å™¨æ§åˆ¶å¹¶å‘
    ResourceManager resource_manager_;
    
    void enforce_resource_limits() {
        // é™åˆ¶å¹¶å‘ä¸‹è½½æ•°
        size_t active_downloads = count_active_downloads();
        if (active_downloads >= resource_manager_.max_concurrent_downloads) {
            // æš‚åœæ–°ä»»åŠ¡ï¼Œç­‰å¾…èµ„æºé‡Šæ”¾
            pause_new_tasks();
        }
        
        // é™åˆ¶æ€»è¿æ¥æ•°
        size_t total_connections = count_total_connections();
        if (total_connections >= resource_manager_.max_total_connections) {
            // å…³é—­éƒ¨åˆ†ä½ä¼˜å…ˆçº§è¿æ¥
            close_low_priority_connections();
        }
    }
};
```

---

## 7. æ€»ç»“

### ä»»åŠ¡æ‹†åˆ†çš„æ ¸å¿ƒæ€æƒ³

1. **ä¸‰å±‚æ¨¡å‹**ï¼šDownloadTask â†’ PhaseTask â†’ AtomicTask
2. **é˜¶æ®µåˆ’åˆ†**ï¼šè§£æ â†’ DHT â†’ è¿æ¥ â†’ ä¸‹è½½ â†’ æ ¡éªŒ
3. **å¹¶å‘æ‰§è¡Œ**ï¼šå¤šä¸ª DownloadTask å¹¶å‘ï¼Œæ¯ä¸ª Task å†…éƒ¨ä¹Ÿå¹¶å‘
4. **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šå…³é”®è·¯å¾„é«˜ä¼˜å…ˆçº§ï¼Œæ•°æ®ä¼ è¾“æ™®é€šä¼˜å…ˆçº§
5. **èµ„æºæ§åˆ¶**ï¼šå…¨å±€èµ„æºé™åˆ¶ï¼Œé˜²æ­¢è¿‡è½½

### å…³é”®è®¾è®¡ç‚¹

- **ä»»åŠ¡ç²’åº¦**ï¼šAtomicTask æ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°æ‰§è¡Œå•å…ƒ
- **ä¾èµ–ç®¡ç†**ï¼šé˜¶æ®µé—´æœ‰ä¾èµ–ï¼Œé˜¶æ®µå†…å¯å¹¶å‘
- **åŠ¨æ€è°ƒåº¦**ï¼šæ ¹æ®æ‰§è¡Œç»“æœåŠ¨æ€åˆ›å»ºåç»­ä»»åŠ¡
- **èµ„æºå…¬å¹³**ï¼šå¤šä»»åŠ¡é—´å…¬å¹³åˆ†é…èµ„æº
- **ä¼˜å…ˆçº§è€åŒ–**ï¼šé˜²æ­¢ä½ä¼˜å…ˆçº§ä»»åŠ¡é¥¥é¥¿

è¿™å°±æ˜¯ç£åŠ›é“¾æ¥ä¸‹è½½çš„å®Œæ•´ä»»åŠ¡æ‹†åˆ†å’Œè°ƒåº¦ç­–ç•¥ï¼ğŸ¯
