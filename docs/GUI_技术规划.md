# MagnetDownload GUI 技术规划方案

## 📋 目录

1. [项目目标](#项目目标)
2. [技术选型对比](#技术选型对比)
3. [功能模块设计](#功能模块设计)
4. [架构设计](#架构设计)
5. [前后端接口设计](#前后端接口设计)
6. [UI/UX 设计方案](#ui-ux-设计方案)
7. [实施计划](#实施计划)
8. [技术难点和风险](#技术难点和风险)
9. [性能优化策略](#性能优化策略)
10. [后续扩展规划](#后续扩展规划)

---

## 1. 项目目标 <a id="项目目标"></a>

### 1.1 核心目标
为 MagnetDownload 开发一个**现代化、用户友好的图形界面**，提供与迅雷、qBittorrent 相媲美的使用体验。

### 1.2 关键需求
✅ **磁力链接解析**：输入磁力链接后，自动获取元数据并展示文件列表  
✅ **选择性下载**：支持用户选择要下载的文件（单文件/多文件种子）  
✅ **多任务管理**：同时管理多个下载任务  
✅ **实时进度显示**：下载速度、进度条、ETA、Peers/Seeds 数量  
✅ **任务控制**：暂停、恢复、删除、优先级调整  
✅ **详细信息展示**：Peer 列表、Pieces 可视化、Tracker 状态  
✅ **设置管理**：下载路径、限速、连接数等配置  

### 1.3 非功能需求
- **性能**：流畅运行，任务列表更新延迟 < 200ms
- **稳定性**：7x24 小时运行不崩溃
- **跨平台**：Windows/Linux/macOS 支持
- **可扩展性**：易于添加新功能（如 RSS 订阅、远程控制）

---

## 2. 技术选型对比 <a id="技术选型对比"></a>

### 2.1 GUI 框架对比

| 方案 | 优点 | 缺点 | 适用场景 | 评分 |
|------|------|------|----------|------|
| **CEF + Vue 3** | ✅ 现代化 UI<br>✅ 开发效率高<br>✅ 丰富组件库<br>✅ 热更新 | ❌ 体积较大(~150MB)<br>❌ 内存占用高(~200MB) | 对用户体验要求高，可接受体积 | ⭐⭐⭐⭐⭐ |
| **CEF + React** | ✅ 生态最强<br>✅ 组件丰富 | ❌ 体积大<br>❌ 内存占用高 | 复杂交互应用 | ⭐⭐⭐⭐ |
| **Qt Widgets** | ✅ 原生性能<br>✅ 体积小(~20MB)<br>✅ 低内存 | ❌ UI 不够现代<br>❌ 开发效率低<br>❌ 样式定制困难 | 企业级工具软件 | ⭐⭐⭐ |
| **Qt WebEngine** | ✅ 原生 + Web 混合<br>✅ 体积中等 | ❌ Qt 6 要求高<br>❌ Web 部分性能不如 CEF | Qt 项目想加入 Web 界面 | ⭐⭐⭐ |
| **Electron** | ✅ 成熟方案<br>✅ 社区大 | ❌ Node.js 集成复杂<br>❌ 与 C++ 通信麻烦 | JavaScript 为主的项目 | ⭐⭐⭐ |

### 2.2 推荐方案：**CEF + Vue 3 + TypeScript + Element Plus**

#### 理由
1. **开发效率最高**：Vue 3 + Element Plus 提供开箱即用的组件，1-2 周就能完成 MVP
2. **UI 现代化**：可以做出媲美 Web 应用的精美界面
3. **技术栈成熟**：Vue 3 生态完善，文档齐全
4. **易于维护**：TypeScript 提供类型安全，代码可维护性强
5. **CEF 与 C++ 集成简单**：通过 HTTP API + WebSocket 通信即可

#### 替代方案
- **如果对体积敏感**：Qt Widgets（传统桌面应用风格）
- **如果团队熟悉 React**：CEF + React（开发周期可能多 1 周）

---

## 3. 功能模块设计 <a id="功能模块设计"></a>

### 3.1 模块划分

```
┌─────────────────────────────────────────────────┐
│                   MagnetDownload GUI             │
├─────────────────────────────────────────────────┤
│  1. 添加任务模块 (Add Task Module)               │
│     - 磁力链接输入                                │
│     - 种子文件上传                                │
│     - 元数据解析和预览                            │
│     - 文件选择器                                  │
│     - 保存路径选择                                │
├─────────────────────────────────────────────────┤
│  2. 任务列表模块 (Task List Module)               │
│     - 分类视图（全部/下载中/已完成/暂停/失败）     │
│     - 任务卡片（进度、速度、状态）                 │
│     - 批量操作（开始、暂停、删除）                 │
│     - 排序和筛选                                  │
│     - 右键菜单                                    │
├─────────────────────────────────────────────────┤
│  3. 任务详情模块 (Task Detail Module)             │
│     - 概览（名称、大小、InfoHash、Tracker）       │
│     - 文件列表（路径、大小、进度、选择状态）       │
│     - Peers 列表（IP、客户端、速度、进度）         │
│     - Pieces 可视化地图                           │
│     - 实时日志输出                                │
├─────────────────────────────────────────────────┤
│  4. 统计面板模块 (Statistics Module)              │
│     - 全局速度曲线图（实时更新）                   │
│     - 累计下载/上传量                             │
│     - 分享率统计                                  │
│     - 网络连接状态                                │
├─────────────────────────────────────────────────┤
│  5. 设置模块 (Settings Module)                    │
│     - 下载设置（路径、连接数、限速）               │
│     - 网络设置（端口、DHT、UPnP、代理）            │
│     - UI 设置（主题、语言）                       │
│     - 高级设置（缓存、日志级别）                   │
├─────────────────────────────────────────────────┤
│  6. 系统托盘模块 (System Tray Module)             │
│     - 最小化到托盘                                │
│     - 快捷操作菜单                                │
│     - 下载完成通知                                │
└─────────────────────────────────────────────────┘
```

### 3.2 核心功能详细设计

#### 3.2.1 添加任务模块

**功能流程**：
```
用户输入磁力链接
    ↓
前端发送解析请求 (POST /api/parse)
    ↓
后端启动临时任务获取元数据
    ↓
前端轮询或 WebSocket 推送元数据
    ↓
显示文件列表（支持全选/反选/按类型筛选）
    ↓
用户选择文件和保存路径
    ↓
前端发送创建任务请求 (POST /api/tasks)
    ↓
任务加入下载队列
```

**UI 元素**：
- 输入框：磁力链接 / 种子文件上传按钮
- 加载指示器：解析中动画
- 文件列表：Tree 结构展示（支持文件夹折叠）
- 文件过滤器：视频/音频/文档/其他
- 保存路径：目录选择器 + 历史记录下拉
- 高级选项：折叠面板（连接数、限速等）

**交互细节**：
- 粘贴磁力链接后自动识别并触发解析
- 文件列表支持按大小排序
- 默认保存路径记忆上次选择
- 快捷键支持（Ctrl+V 粘贴、Enter 确认）

---

#### 3.2.2 任务列表模块

**视图模式**：
1. **列表视图**（默认）：紧凑展示，适合多任务
2. **卡片视图**：详细信息，适合少量任务

**任务状态**：
- 🔵 **获取元数据中** (metadata_fetching)
- 🟢 **下载中** (downloading)
- 🟡 **已暂停** (paused)
- ✅ **已完成** (completed)
- 🔴 **失败** (failed)
- 🔄 **校验中** (checking)

**显示信息**：
```
┌────────────────────────────────────────────────┐
│ 📦 Big Buck Bunny.mp4               [⋮]       │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 45.5%        │
│ ↓ 716 KB/s  ↑ 50 KB/s  | 125.8 MB / 276.8 MB │
│ Peers: 15/8 | ETA: 3m 30s | 健康度: ████░     │
└────────────────────────────────────────────────┘
```

**右键菜单**：
- 开始 / 暂停 / 恢复
- 删除任务（保留文件 / 删除文件）
- 设置优先级（高 / 普通 / 低）
- 打开文件夹
- 复制磁力链接
- 查看详情

**批量操作**：
- 全选 / 反选
- 批量暂停 / 恢复
- 批量删除

---

#### 3.2.3 任务详情模块

**标签页结构**：

**Tab 1: 概览**
- 基本信息：名称、InfoHash、大小、创建时间
- Tracker 列表：URL、状态、Peers 数量、上次响应时间
- 统计：已下载、已上传、分享率、浪费（废弃数据）

**Tab 2: 文件**
```
文件树结构：
└─ Big Buck Bunny/
   ├─ Big Buck Bunny.mp4  [✓] ━━━━━ 45.5%  276.5 MB
   ├─ poster.jpg          [✓] ━━━━━ 100%    140 KB
   └─ subtitles/
      ├─ en.srt           [✓] ━━━━━ 100%    143 KB
      └─ zh.srt           [ ] ━━━━━ 0%      152 KB
```
- 支持运行时修改文件选择（已下载的不可取消）
- 右键菜单：打开、重命名、设置优先级

**Tab 3: Peers**
```
┌─────────────┬───────────┬──────────┬──────────┬─────────┐
│ IP:Port     │ 客户端    │ 进度     │ ↓ 速度   │ ↑ 速度  │
├─────────────┼───────────┼──────────┼──────────┼─────────┤
│ 1.2.3.4:6881│ qBit 4.5  │ 100%     │ 102 KB/s │ 0       │
│ 5.6.7.8:6882│ μTorrent  │ 67%      │ 89 KB/s  │ 12 KB/s │
└─────────────┴───────────┴──────────┴──────────┴─────────┘
```
- 显示国家旗帜图标
- 标记 Seeder（绿色）/ Leecher（黄色）
- 右键：封禁 IP、复制 IP

**Tab 4: Pieces 地图**
```
Pieces 可视化（类似 qBittorrent）：
■■■■■■■■■■░░░░░░▓▓░░░░░░░░░░░░░░░░░░░░  480 / 1055
■ 已完成  ░ 未下载  ▓ 下载中
```
- 鼠标悬停显示 Piece 索引和来源 Peer
- 点击 Piece 查看详细信息

**Tab 5: 日志**
```
[2026-01-14 12:34:56] INFO: Task started
[2026-01-14 12:34:58] INFO: Connected to peer 1.2.3.4:6881
[2026-01-14 12:35:00] WARNING: Piece #120 hash mismatch, re-downloading
[2026-01-14 12:35:02] INFO: Download speed: 716 KB/s
```
- 支持日志级别过滤（DEBUG / INFO / WARNING / ERROR）
- 支持搜索和导出

---

#### 3.2.4 统计面板模块

**全局统计卡片**：
```
┌─────────────┬─────────────┬─────────────┐
│ 总下载量     │ 总上传量     │ 分享率      │
│ 1.5 TB      │ 750 GB      │ 0.50        │
└─────────────┴─────────────┴─────────────┘

┌─────────────┬─────────────┬─────────────┐
│ 本次下载     │ 本次上传     │ 活跃任务    │
│ 276 MB      │ 50 KB       │ 2 / 5       │
└─────────────┴─────────────┴─────────────┘
```

**实时速度曲线图**（ECharts）：
```
    ↑ 速度 (MB/s)
  2 │     ╱╲
  1 │   ╱    ╲    ╱╲
  0 │─────────────────→ 时间
       下载速度 ━━━  上传速度 ━ ━
```
- X 轴：最近 60 秒
- Y 轴：自适应范围
- 支持暂停更新

**最近活动日志**：
- 显示最近 10 条重要事件（任务完成、错误等）

---

#### 3.2.5 设置模块

**下载设置**：
- 默认保存路径（浏览器选择 + 自定义输入）
- 最大同时下载任务数（1-10）
- 最大连接数（50-500）
- 全局下载限速（0 = 无限制，单位 KB/s）
- 全局上传限速
- 完成后操作（无 / 关闭程序 / 休眠 / 关机）

**网络设置**：
- 监听端口（默认 6881，范围 1024-65535）
- 启用 DHT
- 启用 UPnP / NAT-PMP
- 代理设置（HTTP / SOCKS5）
- 代理仅用于 Tracker

**UI 设置**：
- 主题（亮色 / 暗色 / 跟随系统）
- 语言（中文 / English）
- 启动时最小化到托盘
- 关闭按钮最小化到托盘（而非退出）

**高级设置**：
- 磁盘缓存大小（默认 64 MB）
- 日志级别（ERROR / WARNING / INFO / DEBUG）
- 日志文件路径
- 实验性功能开关

---

## 4. 架构设计 <a id="架构设计"></a>

### 4.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                     CEF Browser                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │            Vue 3 Web UI (TypeScript)              │  │
│  │  ┌──────────┬──────────┬──────────┬─────────┐    │  │
│  │  │ 任务列表  │ 任务详情  │ 统计面板  │ 设置   │    │  │
│  │  └──────────┴──────────┴──────────┴─────────┘    │  │
│  │                                                    │  │
│  │  ┌──────────────────────────────────────────┐    │  │
│  │  │  Pinia Store (状态管理)                   │    │  │
│  │  │  - TasksStore  - SettingsStore            │    │  │
│  │  │  - StatsStore  - UIStore                  │    │  │
│  │  └──────────────────────────────────────────┘    │  │
│  │                                                    │  │
│  │  ┌──────────────┬───────────────────────────┐    │  │
│  │  │ API Client   │ WebSocket Client          │    │  │
│  │  │ (Axios)      │ (实时更新)                 │    │  │
│  │  └──────────────┴───────────────────────────┘    │  │
│  └─────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP API + WebSocket
                     │ (localhost:8080)
┌────────────────────▼────────────────────────────────────┐
│              C++ Backend (MagnetDownload)               │
│  ┌─────────────────────────────────────────────────┐   │
│  │         WebApiServer (HTTP + WebSocket)         │   │
│  │  - RESTful API Handler                          │   │
│  │  - WebSocket Broadcaster                        │   │
│  │  - CORS Support                                 │   │
│  └────────────────────┬────────────────────────────┘   │
│                       │                                 │
│  ┌────────────────────▼────────────────────────────┐   │
│  │          DownloadManager (多任务管理)           │   │
│  │  - Task CRUD                                    │   │
│  │  - Task Scheduler                               │   │
│  │  - Global Statistics                            │   │
│  └────────────────────┬────────────────────────────┘   │
│                       │                                 │
│  ┌────────────────────▼────────────────────────────┐   │
│  │   DownloadController (单任务逻辑, 已有代码)     │   │
│  │  - DhtClient  - TrackerClient  - PeerManager    │   │
│  │  - PieceManager  - FileStorage                  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              ASIO IO Context                    │   │
│  │  (统一事件循环)                                  │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 4.2 关键组件职责

#### 4.2.1 前端组件

| 组件 | 职责 |
|------|------|
| **Vue 3 UI** | 渲染界面，处理用户交互 |
| **Pinia Store** | 全局状态管理（任务列表、设置等） |
| **API Client** | 封装 HTTP 请求，提供类型安全的接口 |
| **WebSocket Client** | 接收服务器推送的实时更新 |
| **Router** | 页面路由管理 |
| **Components** | 可复用的 UI 组件（任务卡片、进度条等） |

#### 4.2.2 后端组件

| 组件 | 职责 |
|------|------|
| **WebApiServer** | HTTP 服务器，处理 RESTful API 请求，管理 WebSocket 连接 |
| **DownloadManager** | 多任务管理器，创建/删除/控制 DownloadController 实例 |
| **DownloadController** | 单任务下载逻辑（已有代码，无需修改） |
| **TaskScheduler** | 任务调度，控制并发下载数量 |
| **SettingsManager** | 持久化设置（JSON 文件） |
| **StatisticsCollector** | 收集全局统计数据 |

### 4.3 通信协议

#### 4.3.1 HTTP API（RESTful）

**用途**：前端主动请求数据或执行操作

**特点**：
- 同步操作（添加任务、修改设置等）
- 请求-响应模式
- 使用 JSON 格式

#### 4.3.2 WebSocket

**用途**：服务器主动推送实时更新

**推送内容**：
- 任务进度更新（每秒）
- 全局速度更新（每秒）
- 任务状态变化（立即）
- 错误通知（立即）

**订阅机制**：
```json
// 客户端订阅特定任务
{
  "type": "subscribe",
  "task_ids": ["abc123", "def456"]
}

// 服务器推送更新
{
  "type": "task_update",
  "task_id": "abc123",
  "data": {
    "progress": 46.2,
    "download_speed": 728064,
    "peers": 16
  }
}
```

### 4.4 数据流

#### 4.4.1 添加任务流程

```
用户输入磁力链接
    ↓
前端: POST /api/parse
    ↓
后端: DownloadManager::parseMagnet()
    ↓
后端: 创建临时 DownloadController 获取元数据
    ↓
后端: 通过 WebSocket 推送元数据 (status: metadata_fetching)
    ↓
前端: 显示文件列表，用户选择
    ↓
前端: POST /api/tasks
    ↓
后端: DownloadManager::addTask()
    ↓
后端: 创建 DownloadController 实例并启动
    ↓
后端: 通过 WebSocket 推送任务状态 (status: downloading)
    ↓
前端: 跳转到任务列表，显示下载进度
```

#### 4.4.2 实时更新流程

```
后端: DownloadManager 定时器（每秒触发）
    ↓
后端: 遍历所有任务，收集当前状态
    ↓
后端: 对比上次状态，找出变化的任务
    ↓
后端: 通过 WebSocket 广播变化
    ↓
前端: WebSocket 接收消息
    ↓
前端: Pinia Store 更新状态
    ↓
前端: Vue 响应式更新 UI
```

---

## 5. 前后端接口设计 <a id="前后端接口设计"></a>

### 5.1 RESTful API 接口

#### 5.1.1 任务管理

**GET /api/tasks** - 获取任务列表
```
Query:
  - status?: string (可选：downloading, paused, completed, failed)

Response: 200 OK
{
  "tasks": [
    {
      "id": "abc123",
      "info_hash": "dd8255ec...",
      "name": "Big Buck Bunny",
      "status": "downloading",
      "total_size": 276824064,
      "downloaded": 125829120,
      "progress": 45.5,
      "download_speed": 716800,
      "upload_speed": 51200,
      "eta": 210,
      "peers": 15,
      "seeds": 8,
      "created_at": "2026-01-14T12:00:00Z",
      "selected_files": [0, 1, 2]
    }
  ]
}
```

**GET /api/tasks/{id}** - 获取任务详情
```
Response: 200 OK
{
  "basic": { /* TaskInfo 同上 */ },
  "files": [
    {
      "index": 0,
      "path": "Big Buck Bunny.mp4",
      "size": 276539842,
      "progress": 45.5,
      "selected": true
    }
  ],
  "trackers": [
    "http://tracker.opentrackr.org:1337/announce"
  ],
  "peers": [
    {
      "ip": "1.2.3.4",
      "port": 6881,
      "country": "US",
      "client": "qBittorrent 4.5.0",
      "progress": 100.0,
      "download_speed": 102400,
      "upload_speed": 0
    }
  ],
  "pieces": {
    "total": 1055,
    "completed": 480,
    "downloading": 25,
    "bitmap": "base64_encoded_data..."
  }
}
```

**POST /api/tasks** - 添加任务
```
Request:
{
  "magnet_uri": "magnet:?xt=urn:btih:...",
  "save_path": "E:\\Downloads",
  "selected_files": [0, 2, 5]  // 可选，不提供则全部下载
}

Response: 201 Created
{
  "task_id": "abc123"
}
```

**POST /api/tasks/{id}/action** - 控制任务
```
Request:
{
  "action": "pause" | "resume" | "remove" | "recheck"
}

Response: 200 OK
{
  "success": true
}
```

**PUT /api/tasks/{id}/priority** - 设置优先级
```
Request:
{
  "priority": "high" | "normal" | "low"
}

Response: 200 OK
```

**PUT /api/tasks/{id}/files** - 修改文件选择
```
Request:
{
  "selected_files": [0, 1, 3]
}

Response: 200 OK
```

#### 5.1.2 磁力链接解析

**POST /api/parse** - 解析磁力链接（预览）
```
Request:
{
  "magnet_uri": "magnet:?xt=urn:btih:..."
}

Response: 200 OK (立即返回，元数据通过 WebSocket 推送)
{
  "task_id": "temp_xyz",  // 临时任务 ID，用于接收元数据
  "status": "metadata_fetching"
}

// WebSocket 推送（元数据获取完成后）
{
  "type": "metadata_ready",
  "task_id": "temp_xyz",
  "data": {
    "info_hash": "dd8255ec...",
    "name": "Big Buck Bunny",
    "total_size": 276824064,
    "files": [
      { "path": "Big Buck Bunny.mp4", "size": 276539842 },
      { "path": "poster.jpg", "size": 140846 }
    ]
  }
}
```

#### 5.1.3 设置管理

**GET /api/settings** - 获取设置
```
Response: 200 OK
{
  "download": {
    "default_save_path": "E:\\Downloads",
    "max_connections": 200,
    "max_download_speed": 0,
    "max_upload_speed": 0
  },
  "network": {
    "listen_port": 6881,
    "dht_enabled": true,
    "upnp_enabled": true
  },
  "ui": {
    "theme": "dark",
    "language": "zh-CN"
  }
}
```

**PUT /api/settings** - 更新设置
```
Request: (同上)

Response: 200 OK
```

#### 5.1.4 统计信息

**GET /api/statistics** - 获取全局统计
```
Response: 200 OK
{
  "total_downloaded": 1073741824,
  "total_uploaded": 536870912,
  "share_ratio": 0.5,
  "session_downloaded": 276824064,
  "session_uploaded": 51200,
  "global_download_speed": 716800,
  "global_upload_speed": 51200,
  "active_tasks": 2,
  "total_tasks": 5
}
```

### 5.2 WebSocket 消息格式

#### 5.2.1 客户端 → 服务器

**订阅任务更新**
```json
{
  "type": "subscribe",
  "task_ids": ["abc123", "def456"]
}
```

**取消订阅**
```json
{
  "type": "unsubscribe",
  "task_ids": ["abc123"]
}
```

#### 5.2.2 服务器 → 客户端

**任务更新（增量）**
```json
{
  "type": "task_update",
  "task_id": "abc123",
  "timestamp": 1705219200,
  "data": {
    "progress": 46.2,
    "downloaded": 127926272,
    "download_speed": 728064,
    "upload_speed": 51200,
    "peers": 16,
    "seeds": 8,
    "eta": 205
  }
}
```

**全局统计更新**
```json
{
  "type": "global_stats",
  "timestamp": 1705219200,
  "data": {
    "global_download_speed": 1536000,
    "global_upload_speed": 102400,
    "active_tasks": 3
  }
}
```

**任务状态变化**
```json
{
  "type": "task_status_change",
  "task_id": "abc123",
  "old_status": "downloading",
  "new_status": "completed",
  "message": "Download completed successfully"
}
```

**错误通知**
```json
{
  "type": "error",
  "task_id": "abc123",
  "error_code": "TRACKER_FAILURE",
  "message": "All trackers failed to respond"
}
```

---

## 6. UI/UX 设计方案 <a id="ui-ux-设计方案"></a>

### 6.1 设计原则

1. **简洁优先**：避免信息过载，隐藏高级功能
2. **响应式设计**：支持不同窗口大小
3. **一致性**：统一的配色、图标、交互方式
4. **可访问性**：支持键盘快捷键、高对比度模式

### 6.2 配色方案

#### 亮色主题
- **主色**：#409EFF (Element Plus 蓝)
- **成功**：#67C23A (绿)
- **警告**：#E6A23C (橙)
- **错误**：#F56C6C (红)
- **背景**：#FFFFFF
- **次级背景**：#F5F7FA
- **文本**：#303133

#### 暗色主题
- **主色**：#409EFF
- **背景**：#1E1E1E
- **次级背景**：#2B2B2B
- **文本**：#E4E7ED

### 6.3 布局方案

#### 侧边栏布局（推荐）
```
┌──────────┬─────────────────────────────────────────┐
│          │  [搜索框]        [+添加]  [⚙]  [-][□][×]│
│  Logo    ├─────────────────────────────────────────┤
│          │                                          │
│ ──────── │   任务列表 / 任务详情 / 统计 / 设置      │
│ 📥 全部   │                                          │
│ ⬇ 下载中  │   (主内容区域)                           │
│ ✅ 已完成 │                                          │
│ ⏸ 暂停   │                                          │
│ ❌ 失败   │                                          │
│          │                                          │
│ ──────── │                                          │
│ 📊 统计   │                                          │
│ ⚙ 设置   │                                          │
│          │                                          │
│          ├─────────────────────────────────────────┤
│          │ 全局速度: ↓ 2.1 MB/s  ↑ 500 KB/s       │
└──────────┴─────────────────────────────────────────┘
```

### 6.4 关键交互设计

#### 添加任务流程
1. 点击 "+添加" 按钮 → 打开对话框
2. 粘贴磁力链接 → 自动识别并显示加载动画
3. 元数据加载完成 → 展开文件列表
4. 用户选择文件和路径 → 点击"开始下载"
5. 对话框关闭 → 任务出现在列表中

#### 任务列表交互
- **单击任务** → 右侧显示详情面板
- **双击任务** → 打开文件夹
- **右键任务** → 弹出上下文菜单
- **拖拽任务** → 调整优先级顺序
- **悬停任务** → 显示更多操作按钮

---

## 7. 实施计划 <a id="实施计划"></a>

### 7.1 分阶段实施

#### **Phase 1: 基础架构搭建**（1-2 周）

**后端**：
- [ ] 实现 `DownloadManager` 类（多任务管理）
- [ ] 实现 `WebApiServer` 类（HTTP 服务器 + RESTful API）
- [ ] 实现基础 API 接口（添加任务、获取任务列表、控制任务）
- [ ] 实现 WebSocket 基础框架（连接管理、消息广播）

**前端**：
- [ ] 搭建 Vue 3 + Vite + TypeScript 项目
- [ ] 集成 Element Plus UI 库
- [ ] 创建基础路由（任务列表、设置）
- [ ] 实现 API Client 和 WebSocket Client
- [ ] 实现 Pinia Store（TasksStore、SettingsStore）

**CEF 集成**：
- [ ] 配置 CEF 项目（CMake）
- [ ] 实现 CEF App 和 Handler
- [ ] 加载本地 Vue 项目（开发时代理到 Vite，生产时嵌入打包文件）

**里程碑**：能够在 CEF 窗口中显示 Vue 界面，后端能够响应基本的 API 请求。

---

#### **Phase 2: 核心功能实现**（2-3 周）

**后端**：
- [ ] 完善所有 RESTful API 接口
- [ ] 实现 WebSocket 实时推送（任务进度、全局统计）
- [ ] 实现磁力链接解析接口（预览）
- [ ] 实现设置持久化（JSON 文件）
- [ ] 实现全局统计收集

**前端**：
- [ ] 实现任务列表页面（支持筛选、排序）
- [ ] 实现任务卡片组件（进度条、速度、状态）
- [ ] 实现添加任务对话框（磁力链接解析、文件选择）
- [ ] 实现 WebSocket 实时更新（进度条自动刷新）
- [ ] 实现右键菜单和批量操作

**里程碑**：能够添加任务、查看任务列表、控制任务（暂停/恢复/删除），进度实时更新。

---

#### **Phase 3: 详情页和统计**（1-2 周）

**前端**：
- [ ] 实现任务详情页面（5 个 Tab）
  - [ ] 概览 Tab（基本信息、Tracker）
  - [ ] 文件 Tab（文件树、选择控制）
  - [ ] Peers Tab（表格展示、国家旗帜）
  - [ ] Pieces Tab（可视化地图）
  - [ ] 日志 Tab（实时日志、过滤）
- [ ] 实现统计面板（全局统计、速度曲线图）
- [ ] 集成 ECharts 图表

**里程碑**：能够查看任务的详细信息，包括 Peers、Pieces 状态等。

---

#### **Phase 4: 设置和优化**（1-2 周）

**前端**：
- [ ] 实现设置页面（下载设置、网络设置、UI 设置）
- [ ] 实现主题切换（亮色/暗色）
- [ ] 实现国际化（中文/英文）
- [ ] 优化性能（虚拟滚动、懒加载）

**后端**：
- [ ] 实现系统托盘（最小化、快捷菜单）
- [ ] 实现下载完成通知
- [ ] 性能优化（WebSocket 消息合并、增量更新）

**里程碑**：功能完整，性能稳定，支持主题和语言切换。

---

#### **Phase 5: 打磨和发布**（1 周）

- [ ] UI/UX 细节优化
- [ ] Bug 修复
- [ ] 编写用户文档
- [ ] 制作安装包（NSIS for Windows）
- [ ] 测试和发布

---

### 7.2 技术难点攻关

| 难点 | 解决方案 | 预计耗时 |
|------|----------|----------|
| CEF 与 C++ 集成 | 参考 CEF 官方示例，使用 IPC 通信 | 3 天 |
| HTTP 服务器实现 | 使用 Boost.Beast 或轻量级库 Crow | 2 天 |
| WebSocket 实现 | 使用 Boost.Beast WebSocket | 2 天 |
| 元数据解析异步处理 | 创建临时 DownloadController，完成后销毁 | 1 天 |
| Pieces 可视化 | Canvas 绘制，优化大种子性能 | 2 天 |
| 实时更新性能 | 增量更新 + 消息合并 + 订阅机制 | 2 天 |

---

## 8. 技术难点和风险 <a id="技术难点和风险"></a>

### 8.1 技术难点

#### 8.1.1 CEF 集成和打包

**难点**：
- CEF 二进制文件体积大（~150 MB）
- 打包配置复杂（需要包含所有 CEF 依赖）
- 不同平台配置不同（Windows / Linux / macOS）

**解决方案**：
- 参考 [CEF Simple Sample](https://bitbucket.org/chromiumembedded/cef/src/master/tests/cefsimple/)
- 使用 CMake ExternalProject 自动下载 CEF
- 制作安装包时使用 NSIS（Windows）/ AppImage（Linux）

---

#### 8.1.2 WebSocket 实时推送性能

**难点**：
- 频繁更新（每秒数百次）可能导致性能问题
- 多个客户端连接时消息广播开销大

**解决方案**：
- **增量更新**：只推送变化的字段
- **消息合并**：同一任务的多次更新合并为一条消息
- **订阅机制**：客户端只订阅感兴趣的任务
- **节流**：任务列表页面降低更新频率（2 秒一次），详情页保持 1 秒

---

#### 8.1.3 元数据获取超时处理

**难点**：
- 用户预览磁力链接时，元数据可能需要几分钟才能获取
- 长时间加载会导致用户体验差

**解决方案**：
- **超时机制**：预览任务设置 2 分钟超时
- **进度提示**：显示当前进度（"正在连接 DHT...""已连接 5 个 Peers..."）
- **取消操作**：允许用户取消预览
- **缓存机制**：已解析的 InfoHash 缓存元数据（30 天）

---

#### 8.1.4 大种子的 Pieces 可视化

**难点**：
- 大种子可能有数万个 Pieces（如 50GB 文件 = 25600 Pieces）
- 全部绘制会导致性能问题

**解决方案**：
- **分块渲染**：将 Pieces 分组显示（如 100 个 Piece 合并为 1 个像素）
- **虚拟滚动**：只渲染可见区域
- **Canvas 优化**：使用离屏 Canvas + requestAnimationFrame

---

### 8.2 风险评估

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| CEF 打包失败 | 中 | 高 | 提前测试打包流程，参考成功案例 |
| WebSocket 性能瓶颈 | 中 | 中 | 实现增量更新和订阅机制 |
| 跨平台兼容性问题 | 中 | 中 | 使用虚拟机提前测试 Linux/macOS |
| 元数据获取慢 | 高 | 低 | 实现超时和进度提示 |
| 前端打包体积过大 | 低 | 低 | 使用 Tree Shaking 和代码分割 |

---

## 9. 性能优化策略 <a id="性能优化策略"></a>

### 9.1 前端优化

1. **虚拟滚动**：任务列表超过 100 项时启用虚拟滚动
2. **懒加载**：统计图表延迟加载，只在切换到统计页时初始化
3. **防抖/节流**：搜索输入、窗口 Resize 等操作节流
4. **WebSocket 消息批量处理**：接收到的消息先缓存，100ms 后统一更新 UI
5. **代码分割**：按路由分割代码，减少首次加载时间

### 9.2 后端优化

1. **增量更新**：只推送变化的任务数据
2. **任务状态缓存**：缓存上一次的任务状态，对比后只推送差异
3. **连接池复用**：HTTP 客户端使用连接池
4. **异步 I/O**：所有网络操作使用 ASIO 异步 I/O
5. **日志级别控制**：生产环境只记录 WARNING 以上日志

### 9.3 性能指标

| 指标 | 目标 | 测试方法 |
|------|------|----------|
| UI 渲染帧率 | ≥60 FPS | Chrome DevTools Performance |
| 任务列表更新延迟 | <200 ms | WebSocket 消息时间戳对比 |
| 内存占用 | <300 MB（10 个任务） | 任务管理器 |
| CPU 占用 | <5%（空闲），<20%（下载中） | 任务管理器 |
| 启动时间 | <3 秒 | 计时器 |

---

## 10. 后续扩展规划 <a id="后续扩展规划"></a>

### 10.1 短期扩展（3-6 个月）

- **RSS 订阅**：自动下载追剧
- **搜索功能**：集成 BT 种子搜索引擎
- **分类管理**：任务标签和分组
- **下载历史**：已完成任务的历史记录
- **速度调度**：根据时间段自动调整限速（如夜间全速）

### 10.2 中期扩展（6-12 个月）

- **远程控制**：Web 界面远程管理下载
- **移动端 App**：iOS/Android 客户端
- **插件系统**：支持第三方插件
- **云同步**：设置和任务列表云同步
- **种子制作**：创建和分享种子

### 10.3 长期愿景

- **去中心化存储集成**：支持 IPFS
- **流媒体播放**：边下边播
- **AI 推荐**：智能推荐相关资源
- **社区功能**：用户评论和评分

---

## 11. 总结

### 11.1 关键决策

| 决策点 | 选择 | 理由 |
|--------|------|------|
| GUI 框架 | CEF + Vue 3 | 开发效率高，UI 现代化 |
| UI 组件库 | Element Plus | 组件丰富，文档完善 |
| 通信方式 | HTTP API + WebSocket | RESTful 标准化，WebSocket 实时性好 |
| 后端架构 | DownloadManager + WebApiServer | 解耦合，易于扩展 |
| 状态管理 | Pinia | Vue 3 官方推荐，类型安全 |

### 11.2 开发时间估算

- **Phase 1（基础架构）**：1-2 周
- **Phase 2（核心功能）**：2-3 周
- **Phase 3（详情页和统计）**：1-2 周
- **Phase 4（设置和优化）**：1-2 周
- **Phase 5（打磨和发布）**：1 周

**总计**：6-10 周（约 1.5-2.5 个月）

### 11.3 资源需求

- **开发人员**：1-2 人（全栈，熟悉 C++ 和 Vue）
- **设计师**：0.5 人（UI/UX 设计，可兼职）
- **测试设备**：Windows、Linux、macOS 各一台

### 11.4 下一步行动

1. **确认技术方案**：与团队讨论并确定最终技术栈
2. **搭建开发环境**：配置 CEF、Vue 3、C++ 编译环境
3. **创建项目骨架**：初始化前后端项目结构
4. **制定详细的 API 文档**：明确前后端接口契约
5. **开始 Phase 1 开发**：后端 DownloadManager + 前端基础框架

---

## 附录

### A. 参考资源

- [CEF 官方文档](https://bitbucket.org/chromiumembedded/cef/wiki/Home)
- [Vue 3 官方文档](https://vuejs.org/)
- [Element Plus 文档](https://element-plus.org/)
- [qBittorrent 源码](https://github.com/qbittorrent/qBittorrent)
- [Boost.Beast 文档](https://www.boost.org/doc/libs/release/libs/beast/)

### B. 类似项目参考

- **qBittorrent**：Qt Widgets + Web UI（可参考其 Web API 设计）
- **Transmission**：GTK + Web UI（轻量级方案参考）
- **Motrix**：Electron（虽然用 Electron，但 UI 设计可参考）

---

**文档版本**：v1.0  
**创建日期**：2026-01-14  
**最后更新**：2026-01-14  
**作者**：AI Assistant
