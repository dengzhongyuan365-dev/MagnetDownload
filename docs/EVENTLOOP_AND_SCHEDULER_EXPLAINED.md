# EventLoopManager å’Œ TaskScheduler æ·±åº¦è§£æ

> **æ ¸å¿ƒé—®é¢˜**ï¼šè¿™ä¸¤ä¸ªæ¨¡å—åˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒä»¬ï¼Ÿå®ƒä»¬å¦‚ä½•å·¥ä½œï¼Ÿ

---

## ğŸ¤” ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸¤ä¸ªæ¨¡å—ï¼Ÿ

### 1.1 é—®é¢˜çš„èµ·æºï¼šå¼‚æ­¥ç¼–ç¨‹çš„æŒ‘æˆ˜

æƒ³è±¡ä½ è¦å®ç°ä¸€ä¸ªç£åŠ›ä¸‹è½½å™¨ï¼Œéœ€è¦åŒæ—¶åšå¾ˆå¤šäº‹æƒ…ï¼š

```
åŒæ—¶è¿›è¡Œçš„ä»»åŠ¡ï¼š
â”œâ”€ è¿æ¥ 100 ä¸ª Peer
â”œâ”€ ä» DHT ç½‘ç»œæŸ¥è¯¢èŠ‚ç‚¹
â”œâ”€ ä¸‹è½½ 1000 ä¸ªæ•°æ®åˆ†ç‰‡
â”œâ”€ å†™å…¥æ–‡ä»¶åˆ°ç£ç›˜
â”œâ”€ æ›´æ–° UI è¿›åº¦
â””â”€ å¤„ç†ç”¨æˆ·è¾“å…¥
```

**ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜**ï¼š

#### æ–¹æ¡ˆ Aï¼šå•çº¿ç¨‹åŒæ­¥
```cpp
// âŒ è¿™æ ·ä¼šé˜»å¡
connect_to_peer_1();  // ç­‰å¾…è¿æ¥...
connect_to_peer_2();  // ç­‰å¾…è¿æ¥...
// ç¬¬ä¸€ä¸ªè¿æ¥æ²¡å®Œæˆï¼Œç¬¬äºŒä¸ªæ ¹æœ¬å¼€å§‹ä¸äº†ï¼
```

#### æ–¹æ¡ˆ Bï¼šæ¯ä¸ªä»»åŠ¡ä¸€ä¸ªçº¿ç¨‹
```cpp
// âŒ çº¿ç¨‹å¤ªå¤šï¼Œèµ„æºæµªè´¹
std::thread t1([]{ connect_to_peer_1(); });
std::thread t2([]{ connect_to_peer_2(); });
// ... åˆ›å»º 100 ä¸ªçº¿ç¨‹ï¼Ÿ
// çº¿ç¨‹åˆ‡æ¢å¼€é”€å·¨å¤§ï¼Œå†…å­˜å ç”¨é«˜
```

#### æ–¹æ¡ˆ Cï¼šå¼‚æ­¥ + äº‹ä»¶å¾ªç¯ï¼ˆâœ… æˆ‘ä»¬çš„æ–¹æ¡ˆï¼‰
```cpp
// âœ… é«˜æ•ˆï¼šå°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡å¹¶å‘ä»»åŠ¡
io_context.post([]{ async_connect_to_peer_1(); });
io_context.post([]{ async_connect_to_peer_2(); });
// æ‰€æœ‰ä»»åŠ¡åœ¨äº‹ä»¶å¾ªç¯ä¸­å¼‚æ­¥æ‰§è¡Œ
```

### 1.2 EventLoopManager å’Œ TaskScheduler çš„è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä½ çš„åº”ç”¨ä»£ç                           â”‚
â”‚  "æˆ‘è¦ä¸‹è½½æ–‡ä»¶"  "æˆ‘è¦è¿æ¥ Peer"  "æˆ‘è¦æŸ¥è¯¢ DHT"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TaskScheduler                         â”‚
â”‚  "å¥½çš„ï¼Œè®©æˆ‘æŒ‰ä¼˜å…ˆçº§æ’é˜Ÿï¼Œé‡è¦çš„å…ˆåš"                     â”‚
â”‚  - DHT æŸ¥è¯¢ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰                                  â”‚
â”‚  - Peer è¿æ¥ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰                                 â”‚
â”‚  - æ—¥å¿—è®°å½•ï¼ˆä½ä¼˜å…ˆçº§ï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EventLoopManager                        â”‚
â”‚  "å¥½çš„ï¼Œè®©æˆ‘æŠŠä»»åŠ¡åˆ†é…åˆ°ä¸åŒçš„å·¥ä½œçº¿ç¨‹"                   â”‚
â”‚  - çº¿ç¨‹ 1ï¼šå¤„ç† DHT æŸ¥è¯¢                                 â”‚
â”‚  - çº¿ç¨‹ 2ï¼šå¤„ç† Peer è¿æ¥                                â”‚
â”‚  - çº¿ç¨‹ 3ï¼šå¤„ç†æ–‡ä»¶å†™å…¥                                  â”‚
â”‚  - çº¿ç¨‹ 4ï¼šå¤„ç†æ—¥å¿—è®°å½•                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Asio io_contextï¼ˆäº‹ä»¶å¾ªç¯æ ¸å¿ƒï¼‰             â”‚
â”‚  "æˆ‘è´Ÿè´£ç›‘å¬ç½‘ç»œäº‹ä»¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç®€å•æ¥è¯´**ï¼š
- **TaskScheduler**ï¼šäº¤é€šè­¦å¯Ÿ ğŸš¦ - å†³å®šè°å…ˆèµ°
- **EventLoopManager**ï¼šåœè½¦åœºç®¡ç†å‘˜ ğŸ…¿ï¸ - åˆ†é…åœè½¦ä½ï¼ˆçº¿ç¨‹ï¼‰
- **Asio io_context**ï¼šå®é™…çš„åœè½¦ä½ - çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„åœ°æ–¹

---

## ğŸ”„ äºŒã€EventLoopManager è¯¦è§£

### 2.1 ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰ï¼Ÿ

**æœ€ç®€å•çš„ç†è§£**ï¼šä¸€ä¸ªä¸åœè½¬çš„è½®å­ï¼Œä¸æ–­æ£€æŸ¥"æœ‰æ²¡æœ‰äº‹æƒ…è¦åš"ã€‚

```cpp
// æœ€ç®€å•çš„äº‹ä»¶å¾ªç¯æ¦‚å¿µ
while (true) {
    // 1. æ£€æŸ¥æœ‰æ²¡æœ‰ç½‘ç»œäº‹ä»¶ï¼ˆæ•°æ®åˆ°è¾¾ã€è¿æ¥å»ºç«‹ç­‰ï¼‰
    if (æœ‰ç½‘ç»œäº‹ä»¶) {
        å¤„ç†ç½‘ç»œäº‹ä»¶();
    }
    
    // 2. æ£€æŸ¥æœ‰æ²¡æœ‰å®šæ—¶å™¨åˆ°æœŸ
    if (æœ‰å®šæ—¶å™¨åˆ°æœŸ) {
        æ‰§è¡Œå®šæ—¶å™¨å›è°ƒ();
    }
    
    // 3. æ£€æŸ¥æœ‰æ²¡æœ‰ä»»åŠ¡è¦æ‰§è¡Œ
    if (æœ‰å¾…æ‰§è¡Œä»»åŠ¡) {
        æ‰§è¡Œä»»åŠ¡();
    }
}
```

**Asio çš„ io_context å°±æ˜¯è¿™æ ·ä¸€ä¸ªäº‹ä»¶å¾ªç¯**ï¼š

```cpp
asio::io_context io_ctx;

// æŠ•é€’ä»»åŠ¡
io_ctx.post([]{ 
    std::cout << "ä»»åŠ¡ 1 æ‰§è¡Œ\n"; 
});

io_ctx.post([]{ 
    std::cout << "ä»»åŠ¡ 2 æ‰§è¡Œ\n"; 
});

// å¯åŠ¨äº‹ä»¶å¾ªç¯ï¼ˆä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°æ²¡æœ‰ä»»åŠ¡ï¼‰
io_ctx.run();  // è¿™é‡Œä¼šé˜»å¡ï¼Œä¸æ–­å¤„ç†ä»»åŠ¡
```

### 2.2 ä¸ºä»€ä¹ˆéœ€è¦ EventLoopManagerï¼Ÿ

**é—®é¢˜**ï¼šä¸€ä¸ª io_context åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸ CPUã€‚

```cpp
// âŒ å•çº¿ç¨‹äº‹ä»¶å¾ªç¯
asio::io_context io_ctx;
io_ctx.run();  // åªç”¨äº† 1 ä¸ª CPU æ ¸å¿ƒ
```

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ›å»ºå¤šä¸ª io_contextï¼Œæ¯ä¸ªè¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹ã€‚

```cpp
// âœ… å¤šçº¿ç¨‹äº‹ä»¶å¾ªç¯
std::vector<asio::io_context> contexts(4);  // 4 ä¸ªäº‹ä»¶å¾ªç¯

// æ¯ä¸ª io_context åœ¨ç‹¬ç«‹çº¿ç¨‹è¿è¡Œ
for (auto& ctx : contexts) {
    threads.emplace_back([&ctx]{ 
        ctx.run();  // æ¯ä¸ªçº¿ç¨‹è¿è¡Œä¸€ä¸ªäº‹ä»¶å¾ªç¯
    });
}
```

**EventLoopManager å°±æ˜¯ç®¡ç†è¿™äº› io_context çš„ç®¡ç†å™¨**ã€‚

### 2.3 EventLoopManager çš„æ ¸å¿ƒåŠŸèƒ½

#### åŠŸèƒ½ 1ï¼šåˆ›å»ºå’Œç®¡ç†å¤šä¸ª io_context

```cpp
class EventLoopManager {
private:
    struct ThreadContext {
        std::unique_ptr<asio::io_context> io_context;  // äº‹ä»¶å¾ªç¯
        std::unique_ptr<std::thread> thread;           // å·¥ä½œçº¿ç¨‹
        std::atomic<size_t> task_count{0};             // å½“å‰ä»»åŠ¡æ•°
    };
    
    std::vector<std::unique_ptr<ThreadContext>> thread_contexts_;
};
```

**å¯è§†åŒ–**ï¼š
```
EventLoopManager
    â”œâ”€ ThreadContext 1
    â”‚   â”œâ”€ io_context 1  â†â”€ è¿è¡Œåœ¨çº¿ç¨‹ 1
    â”‚   â””â”€ task_count: 5
    â”‚
    â”œâ”€ ThreadContext 2
    â”‚   â”œâ”€ io_context 2  â†â”€ è¿è¡Œåœ¨çº¿ç¨‹ 2
    â”‚   â””â”€ task_count: 3
    â”‚
    â”œâ”€ ThreadContext 3
    â”‚   â”œâ”€ io_context 3  â†â”€ è¿è¡Œåœ¨çº¿ç¨‹ 3
    â”‚   â””â”€ task_count: 7
    â”‚
    â””â”€ ThreadContext 4
        â”œâ”€ io_context 4  â†â”€ è¿è¡Œåœ¨çº¿ç¨‹ 4
        â””â”€ task_count: 2
```

#### åŠŸèƒ½ 2ï¼šè´Ÿè½½å‡è¡¡ï¼ˆé€‰æ‹©æœ€ç©ºé—²çš„çº¿ç¨‹ï¼‰

```cpp
// å½“ä½ æŠ•é€’ä»»åŠ¡æ—¶ï¼Œé€‰æ‹©ä»»åŠ¡æœ€å°‘çš„ io_context
size_t EventLoopManager::select_least_loaded_context() const {
    size_t best_index = 0;
    size_t min_tasks = SIZE_MAX;
    
    // éå†æ‰€æœ‰çº¿ç¨‹ï¼Œæ‰¾ä»»åŠ¡æœ€å°‘çš„
    for (size_t i = 0; i < thread_contexts_.size(); ++i) {
        size_t task_count = thread_contexts_[i]->task_count.load();
        if (task_count < min_tasks) {
            min_tasks = task_count;
            best_index = i;
        }
    }
    
    return best_index;
}
```

**å¯è§†åŒ–è´Ÿè½½å‡è¡¡**ï¼š
```
æ–°ä»»åŠ¡åˆ°æ¥ â†’ é€‰æ‹©æœ€ç©ºé—²çš„çº¿ç¨‹

å½“å‰çŠ¶æ€ï¼š
çº¿ç¨‹ 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (8 ä¸ªä»»åŠ¡)
çº¿ç¨‹ 2: â–ˆâ–ˆâ–ˆ (3 ä¸ªä»»åŠ¡)  â† é€‰è¿™ä¸ªï¼
çº¿ç¨‹ 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (6 ä¸ªä»»åŠ¡)
çº¿ç¨‹ 4: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (5 ä¸ªä»»åŠ¡)

æŠ•é€’åï¼š
çº¿ç¨‹ 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (8 ä¸ªä»»åŠ¡)
çº¿ç¨‹ 2: â–ˆâ–ˆâ–ˆâ–ˆ (4 ä¸ªä»»åŠ¡)  â† æ–°ä»»åŠ¡åœ¨è¿™é‡Œ
çº¿ç¨‹ 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (6 ä¸ªä»»åŠ¡)
çº¿ç¨‹ 4: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (5 ä¸ªä»»åŠ¡)
```

#### åŠŸèƒ½ 3ï¼šç»Ÿä¸€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

```cpp
void EventLoopManager::start() {
    // å¯åŠ¨æ‰€æœ‰å·¥ä½œçº¿ç¨‹
    for (size_t i = 0; i < thread_contexts_.size(); ++i) {
        auto& ctx = thread_contexts_[i];
        ctx->thread = std::make_unique<std::thread>([this, i]() {
            // æ¯ä¸ªçº¿ç¨‹è¿è¡Œè‡ªå·±çš„ io_context
            thread_contexts_[i]->io_context->run();
        });
    }
}

void EventLoopManager::stop() {
    // ä¼˜é›…åœæ­¢æ‰€æœ‰çº¿ç¨‹
    for (auto& ctx : thread_contexts_) {
        ctx->work_guard.reset();  // å…è®¸ io_context é€€å‡º
    }
    
    for (auto& ctx : thread_contexts_) {
        if (ctx->thread->joinable()) {
            ctx->thread->join();  // ç­‰å¾…çº¿ç¨‹ç»“æŸ
        }
    }
}
```

### 2.4 å®é™…ä½¿ç”¨ç¤ºä¾‹

```cpp
// åˆ›å»º EventLoopManagerï¼ˆ4 ä¸ªå·¥ä½œçº¿ç¨‹ï¼‰
EventLoopManager loop_manager(4);

// å¯åŠ¨æ‰€æœ‰å·¥ä½œçº¿ç¨‹
loop_manager.start();

// æŠ•é€’ä»»åŠ¡ï¼ˆè‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼‰
loop_manager.post([]{ 
    std::cout << "ä»»åŠ¡ 1 åœ¨æŸä¸ªçº¿ç¨‹æ‰§è¡Œ\n"; 
});

loop_manager.post([]{ 
    std::cout << "ä»»åŠ¡ 2 åœ¨æŸä¸ªçº¿ç¨‹æ‰§è¡Œ\n"; 
});

// æŠ•é€’åˆ°è´Ÿè½½æœ€è½»çš„çº¿ç¨‹
loop_manager.post_to_least_loaded([]{ 
    std::cout << "ä»»åŠ¡ 3 åœ¨æœ€ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œ\n"; 
});

// ç¨‹åºç»“æŸæ—¶ä¼˜é›…åœæ­¢
loop_manager.stop();
```

### 2.5 EventLoopManager çš„ä»·å€¼

**æ²¡æœ‰ EventLoopManager**ï¼š
```cpp
// âŒ ä½ éœ€è¦æ‰‹åŠ¨ç®¡ç†æ‰€æœ‰è¿™äº›
std::vector<asio::io_context> contexts;
std::vector<std::thread> threads;
std::vector<work_guard> guards;

// æ‰‹åŠ¨å¯åŠ¨
for (auto& ctx : contexts) {
    guards.emplace_back(asio::make_work_guard(ctx));
    threads.emplace_back([&ctx]{ ctx.run(); });
}

// æ‰‹åŠ¨é€‰æ‹©çº¿ç¨‹ï¼ˆæ²¡æœ‰è´Ÿè½½å‡è¡¡ï¼‰
size_t index = rand() % contexts.size();  // éšæœºé€‰ï¼Ÿ
asio::post(contexts[index], task);

// æ‰‹åŠ¨åœæ­¢ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰
for (auto& guard : guards) guard.reset();
for (auto& thread : threads) thread.join();
```

**æœ‰äº† EventLoopManager**ï¼š
```cpp
// âœ… ç®€å•æ¸…æ™°
EventLoopManager manager(4);
manager.start();
manager.post(task);  // è‡ªåŠ¨è´Ÿè½½å‡è¡¡
manager.stop();      // ä¼˜é›…åœæ­¢
```

---

## ğŸ“‹ ä¸‰ã€TaskScheduler è¯¦è§£

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ TaskSchedulerï¼Ÿ

**é—®é¢˜**ï¼šä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½ä¸€æ ·é‡è¦ã€‚

```
åœºæ™¯ï¼šåŒæ—¶æœ‰è¿™äº›ä»»åŠ¡è¦æ‰§è¡Œ
â”œâ”€ ç”¨æˆ·ç‚¹å‡»"æš‚åœä¸‹è½½"æŒ‰é’®  â† å¿…é¡»ç«‹å³å“åº”ï¼
â”œâ”€ DHT æŸ¥è¯¢è¶…æ—¶ï¼Œéœ€è¦é‡è¯•   â† å¾ˆé‡è¦
â”œâ”€ ä¸‹è½½ä¸€ä¸ªæ•°æ®åˆ†ç‰‡         â† æ­£å¸¸ä¼˜å…ˆçº§
â””â”€ å†™ä¸€æ¡è°ƒè¯•æ—¥å¿—           â† ä¸ç€æ€¥
```

**å¦‚æœæ²¡æœ‰ä¼˜å…ˆçº§**ï¼š
```cpp
// âŒ æ‰€æœ‰ä»»åŠ¡æŒ‰åˆ°è¾¾é¡ºåºæ‰§è¡Œ
io_context.post([]{ å†™æ—¥å¿—(); });           // å…ˆåˆ°
io_context.post([]{ ç”¨æˆ·ç‚¹å‡»æš‚åœ(); });     // ååˆ°ï¼Œä½†è¦ç­‰æ—¥å¿—å†™å®Œï¼
```

**æœ‰äº†ä¼˜å…ˆçº§**ï¼š
```cpp
// âœ… é‡è¦ä»»åŠ¡å…ˆæ‰§è¡Œ
scheduler.post_task(Priority::CRITICAL, []{ ç”¨æˆ·ç‚¹å‡»æš‚åœ(); });  // ç«‹å³æ‰§è¡Œ
scheduler.post_task(Priority::LOW, []{ å†™æ—¥å¿—(); });             // ç­‰ä¸€ç­‰
```

### 3.2 TaskScheduler çš„æ ¸å¿ƒåŠŸèƒ½

#### åŠŸèƒ½ 1ï¼šä¼˜å…ˆçº§é˜Ÿåˆ—

```cpp
enum class TaskPriority {
    LOW = 0,       // æ—¥å¿—ã€ç»Ÿè®¡
    NORMAL = 1,    // æ•°æ®ä¼ è¾“
    HIGH = 2,      // DHT æŸ¥è¯¢ã€Peer è¿æ¥
    CRITICAL = 3   // ç”¨æˆ·äº¤äº’ã€ç´§æ€¥é”™è¯¯
};

class TaskScheduler {
private:
    // ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼šé«˜ä¼˜å…ˆçº§ä»»åŠ¡è‡ªåŠ¨æ’åœ¨å‰é¢
    std::priority_queue<
        std::shared_ptr<Task>,
        std::vector<std::shared_ptr<Task>>,
        TaskComparator  // æ¯”è¾ƒå™¨ï¼šä¼˜å…ˆçº§é«˜çš„åœ¨å‰
    > task_queue_;
};
```

**å¯è§†åŒ–ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼š
```
ä»»åŠ¡åˆ°è¾¾é¡ºåºï¼š
1. å†™æ—¥å¿— (LOW)
2. ç”¨æˆ·æš‚åœ (CRITICAL)
3. DHT æŸ¥è¯¢ (HIGH)
4. ä¸‹è½½åˆ†ç‰‡ (NORMAL)

ä¼˜å…ˆçº§é˜Ÿåˆ—è‡ªåŠ¨æ’åºåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æš‚åœ (CRITICAL) â”‚ â† æœ€å…ˆæ‰§è¡Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DHT æŸ¥è¯¢ (HIGH)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸‹è½½åˆ†ç‰‡ (NORMAL)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†™æ—¥å¿— (LOW)        â”‚ â† æœ€åæ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åŠŸèƒ½ 2ï¼šå»¶è¿Ÿä»»åŠ¡

```cpp
// 3 ç§’åæ‰§è¡Œä»»åŠ¡
scheduler.post_delayed_task(
    std::chrono::seconds(3),
    Priority::NORMAL,
    []{ std::cout << "3 ç§’åæ‰§è¡Œ\n"; }
);
```

**å®ç°åŸç†**ï¼š
```cpp
TaskId TaskScheduler::post_delayed_task(Duration delay, Priority priority, TaskFunction func) {
    // ä½¿ç”¨ Asio çš„å®šæ—¶å™¨
    auto timer = std::make_shared<asio::steady_timer>(
        loop_manager_.get_io_context(), 
        delay
    );
    
    auto task = std::make_shared<Task>(func, priority);
    
    // å®šæ—¶å™¨åˆ°æœŸåï¼Œå°†ä»»åŠ¡åŠ å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—
    timer->async_wait([this, task](const asio::error_code& ec) {
        if (!ec) {
            std::lock_guard<std::mutex> lock(queue_mutex_);
            task_queue_.push(task);
            queue_cv_.notify_one();  // é€šçŸ¥è°ƒåº¦çº¿ç¨‹
        }
    });
    
    return task->id();
}
```

#### åŠŸèƒ½ 3ï¼šå‘¨æœŸæ€§ä»»åŠ¡

```cpp
// æ¯ 5 ç§’æ‰§è¡Œä¸€æ¬¡
scheduler.post_periodic_task(
    std::chrono::seconds(5),
    Priority::LOW,
    []{ std::cout << "æ¯ 5 ç§’æ‰§è¡Œä¸€æ¬¡\n"; }
);
```

**å®ç°åŸç†**ï¼šé€’å½’è°ƒåº¦
```cpp
void TaskScheduler::schedule_periodic_task(Duration interval, Priority priority, TaskFunction func, TaskId id) {
    // æ‰§è¡Œä»»åŠ¡
    func();
    
    // å¦‚æœæ²¡è¢«å–æ¶ˆï¼Œå†æ¬¡è°ƒåº¦
    if (!is_task_cancelled(id)) {
        post_delayed_task(interval, priority, [this, interval, priority, func, id]() {
            schedule_periodic_task(interval, priority, func, id);
        });
    }
}
```

#### åŠŸèƒ½ 4ï¼šä»»åŠ¡å–æ¶ˆ

```cpp
// æŠ•é€’ä»»åŠ¡ï¼Œè·å– ID
TaskId id = scheduler.post_delayed_task(
    std::chrono::seconds(10),
    Priority::NORMAL,
    []{ /* ... */ }
);

// å–æ¶ˆä»»åŠ¡
scheduler.cancel_task(id);
```

### 3.3 TaskScheduler çš„å·¥ä½œæµç¨‹

```cpp
void TaskScheduler::scheduler_thread_func() {
    while (running_) {
        std::shared_ptr<Task> task;
        
        // 1. ä»ä¼˜å…ˆçº§é˜Ÿåˆ—å–å‡ºæœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡
        {
            std::unique_lock<std::mutex> lock(queue_mutex_);
            queue_cv_.wait(lock, [this]() {
                return !task_queue_.empty() || !running_;
            });
            
            if (!running_) break;
            
            task = task_queue_.top();  // å–å‡ºæœ€é«˜ä¼˜å…ˆçº§
            task_queue_.pop();
        }
        
        // 2. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
        if (is_task_cancelled(task->id())) {
            continue;
        }
        
        // 3. æäº¤ç»™ EventLoopManager æ‰§è¡Œ
        loop_manager_.post_to_least_loaded([task]() {
            task->execute();
        });
    }
}
```

**å¯è§†åŒ–å·¥ä½œæµç¨‹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   TaskScheduler                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚        ä¼˜å…ˆçº§é˜Ÿåˆ—                       â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚            â”‚
â”‚  â”‚  â”‚ Task 1 (CRITICAL)            â”‚      â”‚            â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚            â”‚
â”‚  â”‚  â”‚ Task 2 (HIGH)                â”‚      â”‚            â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚            â”‚
â”‚  â”‚  â”‚ Task 3 (NORMAL)              â”‚      â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â†“                                  â”‚
â”‚              è°ƒåº¦çº¿ç¨‹ä¸æ–­å–å‡º                            â”‚
â”‚              æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡                              â”‚
â”‚                      â†“                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              EventLoopManager                           â”‚
â”‚                      â†“                                  â”‚
â”‚          é€‰æ‹©è´Ÿè½½æœ€è½»çš„çº¿ç¨‹                              â”‚
â”‚                      â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Thread 1 â”‚  â”‚Thread 2 â”‚  â”‚Thread 3 â”‚  â”‚Thread 4 â”‚  â”‚
â”‚  â”‚ 5 tasks â”‚  â”‚ 3 tasks â”‚  â”‚ 7 tasks â”‚  â”‚ 2 tasks â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â†‘â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚        â”‚
â”‚                                          é€‰è¿™ä¸ªï¼       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 å®é™…ä½¿ç”¨ç¤ºä¾‹

```cpp
EventLoopManager loop_manager(4);
loop_manager.start();

TaskScheduler scheduler(loop_manager);

// 1. ç«‹å³æ‰§è¡Œçš„é«˜ä¼˜å…ˆçº§ä»»åŠ¡
scheduler.post_task(Priority::HIGH, []{ 
    std::cout << "DHT æŸ¥è¯¢\n"; 
});

// 2. ç«‹å³æ‰§è¡Œçš„ä½ä¼˜å…ˆçº§ä»»åŠ¡
scheduler.post_task(Priority::LOW, []{ 
    std::cout << "å†™æ—¥å¿—\n"; 
});

// 3. å»¶è¿Ÿ 5 ç§’æ‰§è¡Œ
auto delayed_id = scheduler.post_delayed_task(
    std::chrono::seconds(5),
    Priority::NORMAL,
    []{ std::cout << "5 ç§’åæ‰§è¡Œ\n"; }
);

// 4. æ¯ 10 ç§’æ‰§è¡Œä¸€æ¬¡
auto periodic_id = scheduler.post_periodic_task(
    std::chrono::seconds(10),
    Priority::LOW,
    []{ std::cout << "å®šæœŸæ¸…ç†\n"; }
);

// 5. å–æ¶ˆä»»åŠ¡
scheduler.cancel_task(delayed_id);

// ç¨‹åºç»“æŸ
loop_manager.stop();
```

---

## ğŸ¤ å››ã€ä¸¤è€…å¦‚ä½•åä½œï¼Ÿ

### 4.1 åä½œæµç¨‹

```
åº”ç”¨ä»£ç 
    â†“
scheduler.post_task(Priority::HIGH, task)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        TaskScheduler                â”‚
â”‚                                     â”‚
â”‚  1. å°†ä»»åŠ¡åŠ å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—             â”‚
â”‚  2. è°ƒåº¦çº¿ç¨‹å–å‡ºæœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡       â”‚
â”‚  3. è°ƒç”¨ EventLoopManager           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
loop_manager.post_to_least_loaded(task)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      EventLoopManager               â”‚
â”‚                                     â”‚
â”‚  1. é€‰æ‹©è´Ÿè½½æœ€è½»çš„çº¿ç¨‹               â”‚
â”‚  2. å°†ä»»åŠ¡æŠ•é€’åˆ°è¯¥çº¿ç¨‹çš„ io_context  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
asio::post(io_context, task)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Asio io_context               â”‚
â”‚                                     â”‚
â”‚  1. åœ¨äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œä»»åŠ¡             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å®Œæ•´ç¤ºä¾‹

```cpp
// åˆå§‹åŒ–
EventLoopManager loop_manager(4);  // 4 ä¸ªå·¥ä½œçº¿ç¨‹
TaskScheduler scheduler(loop_manager);

loop_manager.start();

// åœºæ™¯ï¼šåŒæ—¶æœ‰å¤šä¸ªä»»åŠ¡
scheduler.post_task(Priority::LOW, []{ 
    std::cout << "ä»»åŠ¡ Aï¼šå†™æ—¥å¿—\n"; 
});

scheduler.post_task(Priority::CRITICAL, []{ 
    std::cout << "ä»»åŠ¡ Bï¼šç”¨æˆ·ç‚¹å‡»æš‚åœ\n"; 
});

scheduler.post_task(Priority::HIGH, []{ 
    std::cout << "ä»»åŠ¡ Cï¼šDHT æŸ¥è¯¢\n"; 
});

scheduler.post_task(Priority::NORMAL, []{ 
    std::cout << "ä»»åŠ¡ Dï¼šä¸‹è½½åˆ†ç‰‡\n"; 
});

// æ‰§è¡Œé¡ºåºï¼ˆç”± TaskScheduler ä¿è¯ï¼‰ï¼š
// 1. ä»»åŠ¡ B (CRITICAL)
// 2. ä»»åŠ¡ C (HIGH)
// 3. ä»»åŠ¡ D (NORMAL)
// 4. ä»»åŠ¡ A (LOW)

// æ¯ä¸ªä»»åŠ¡åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼ˆç”± EventLoopManager å†³å®šï¼‰ï¼š
// - ä»»åŠ¡ B â†’ çº¿ç¨‹ 2ï¼ˆæœ€ç©ºé—²ï¼‰
// - ä»»åŠ¡ C â†’ çº¿ç¨‹ 4ï¼ˆæœ€ç©ºé—²ï¼‰
// - ä»»åŠ¡ D â†’ çº¿ç¨‹ 1ï¼ˆæœ€ç©ºé—²ï¼‰
// - ä»»åŠ¡ A â†’ çº¿ç¨‹ 3ï¼ˆæœ€ç©ºé—²ï¼‰
```

---

## ğŸ¯ äº”ã€æ€»ç»“

### EventLoopManager çš„ä½œç”¨

**ä¸€å¥è¯**ï¼šç®¡ç†å¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œè®©ä»»åŠ¡èƒ½å¹¶å‘æ‰§è¡Œï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
1. âœ… å¤šçº¿ç¨‹å¹¶å‘ï¼ˆ4 æ ¸ CPU = 4 å€æ€§èƒ½ï¼‰
2. âœ… è´Ÿè½½å‡è¡¡ï¼ˆä»»åŠ¡å‡åŒ€åˆ†é…ï¼‰
3. âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆç»Ÿä¸€å¯åŠ¨/åœæ­¢ï¼‰
4. âœ… ç®€åŒ–ä½¿ç”¨ï¼ˆå°è£…å¤æ‚ç»†èŠ‚ï¼‰

**ç±»æ¯”**ï¼š
- å°±åƒä¸€ä¸ª**åœè½¦åœºç®¡ç†å‘˜**
- æœ‰ 4 ä¸ªåœè½¦ä½ï¼ˆ4 ä¸ªçº¿ç¨‹ï¼‰
- è½¦æ¥äº†ï¼ˆä»»åŠ¡åˆ°è¾¾ï¼‰ï¼Œæ‰¾æœ€ç©ºçš„åœè½¦ä½
- ç»Ÿä¸€ç®¡ç†å¼€é—¨/å…³é—¨ï¼ˆå¯åŠ¨/åœæ­¢ï¼‰

### TaskScheduler çš„ä½œç”¨

**ä¸€å¥è¯**ï¼šæŒ‰ä¼˜å…ˆçº§è°ƒåº¦ä»»åŠ¡ï¼Œé‡è¦çš„å…ˆåšï¼Œæ”¯æŒå»¶è¿Ÿå’Œå‘¨æœŸæ€§ä»»åŠ¡ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
1. âœ… ä¼˜å…ˆçº§è°ƒåº¦ï¼ˆé‡è¦ä»»åŠ¡å…ˆæ‰§è¡Œï¼‰
2. âœ… å»¶è¿Ÿä»»åŠ¡ï¼ˆå®šæ—¶æ‰§è¡Œï¼‰
3. âœ… å‘¨æœŸæ€§ä»»åŠ¡ï¼ˆå®šæœŸæ‰§è¡Œï¼‰
4. âœ… ä»»åŠ¡å–æ¶ˆï¼ˆçµæ´»æ§åˆ¶ï¼‰

**ç±»æ¯”**ï¼š
- å°±åƒä¸€ä¸ª**äº¤é€šè­¦å¯Ÿ**
- æ•‘æŠ¤è½¦ï¼ˆCRITICALï¼‰ä¼˜å…ˆé€šè¿‡
- å…¬äº¤è½¦ï¼ˆHIGHï¼‰å…¶æ¬¡
- ç§å®¶è½¦ï¼ˆNORMALï¼‰å†æ¬¡
- è‡ªè¡Œè½¦ï¼ˆLOWï¼‰æœ€å

### ä¸¤è€…çš„å…³ç³»

```
TaskSchedulerï¼šå†³å®š"è°å…ˆæ‰§è¡Œ"ï¼ˆä¼˜å…ˆçº§ï¼‰
      â†“
EventLoopManagerï¼šå†³å®š"åœ¨å“ªæ‰§è¡Œ"ï¼ˆçº¿ç¨‹é€‰æ‹©ï¼‰
      â†“
Asio io_contextï¼šçœŸæ­£æ‰§è¡Œä»»åŠ¡
```

**å®Œæ•´æµç¨‹**ï¼š
1. ä½ æŠ•é€’ä»»åŠ¡ç»™ TaskScheduler
2. TaskScheduler æŒ‰ä¼˜å…ˆçº§æ’é˜Ÿ
3. TaskScheduler æŠŠä»»åŠ¡äº¤ç»™ EventLoopManager
4. EventLoopManager é€‰æ‹©æœ€ç©ºé—²çš„çº¿ç¨‹
5. ä»»åŠ¡åœ¨è¯¥çº¿ç¨‹çš„ io_context ä¸­æ‰§è¡Œ

---

**ç°åœ¨ä½ åº”è¯¥å®Œå…¨ç†è§£è¿™ä¸¤ä¸ªæ¨¡å—äº†ï¼** ğŸ‰
