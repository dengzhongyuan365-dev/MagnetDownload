# CEF å‰åç«¯é€šä¿¡æ–¹æ¡ˆè¯¦è§£

## ğŸ¤” æ ¸å¿ƒé—®é¢˜

**ä¸ºä»€ä¹ˆéœ€è¦å‰åç«¯é€šä¿¡ï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CEF æµè§ˆå™¨ï¼ˆå‰ç«¯ï¼‰                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Vue 3 ä»£ç ï¼ˆJavaScriptï¼‰             â”‚  â”‚
â”‚  â”‚  - æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨                       â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·ç‚¹å‡»"æ·»åŠ ä»»åŠ¡"æŒ‰é’®              â”‚  â”‚
â”‚  â”‚  - éœ€è¦è°ƒç”¨ C++ ä¸‹è½½é€»è¾‘ â“           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
              å¦‚ä½•é€šä¿¡ï¼Ÿ
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C++ åç«¯                                    â”‚
â”‚  - DownloadControllerï¼ˆä¸‹è½½é€»è¾‘ï¼‰            â”‚
â”‚  - PeerManagerï¼ˆPeer ç®¡ç†ï¼‰                  â”‚
â”‚  - DhtClientï¼ˆDHT ç½‘ç»œï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**ï¼šVue 3 è¿è¡Œåœ¨ CEF æµè§ˆå™¨ä¸­ï¼ˆJavaScriptï¼‰ï¼Œè€Œä¸‹è½½é€»è¾‘åœ¨ C++ ä¸­ï¼Œå®ƒä»¬å¦‚ä½•é€šä¿¡ï¼Ÿ

---

## ğŸ“Š ä¸‰ç§é€šä¿¡æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ 1ï¼šHTTP API + WebSocketï¼ˆéœ€è¦ HTTP åº“ï¼‰â­â­â­â­â­

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CEF æµè§ˆå™¨ï¼ˆJavaScriptï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Vue 3 å‰ç«¯                                  â”‚  â”‚
â”‚  â”‚  axios.post('/api/tasks', data)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ HTTP è¯·æ±‚
                    â†“
         http://localhost:8080/api/tasks
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C++ HTTP æœåŠ¡å™¨ï¼ˆéœ€è¦ HTTP åº“ï¼ï¼‰                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Crow / Beast / httplib                      â”‚  â”‚
â”‚  â”‚  app.post("/api/tasks", [](req, res) {       â”‚  â”‚
â”‚  â”‚      // è°ƒç”¨ DownloadManager                 â”‚  â”‚
â”‚  â”‚      download_manager->addTask(...);         â”‚  â”‚
â”‚  â”‚  });                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                     â”‚
â”‚  DownloadControllerï¼ˆä¸‹è½½é€»è¾‘ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸ºä»€ä¹ˆéœ€è¦ HTTP åº“ï¼Ÿ

å› ä¸ºä½ éœ€è¦åœ¨ C++ ä¸­**åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨**æ¥æ¥æ”¶å‰ç«¯çš„è¯·æ±‚ï¼

**ç±»æ¯”**ï¼š
- å‰ç«¯å°±åƒä¸€ä¸ª"å®¢æˆ·"ï¼ˆVue 3ï¼‰
- åç«¯å°±åƒä¸€ä¸ª"é¤å…"ï¼ˆC++ ä¸‹è½½å™¨ï¼‰
- HTTP åº“å°±æ˜¯"æœåŠ¡å‘˜"ï¼ˆCrow/Beast/httplibï¼‰
- æ²¡æœ‰æœåŠ¡å‘˜ï¼Œå®¢æˆ·æ— æ³•ç‚¹é¤ï¼

#### ä¼˜ç‚¹
âœ… **å‰åç«¯å®Œå…¨è§£è€¦**ï¼šå¯ä»¥åˆ†åˆ«å¼€å‘ã€æµ‹è¯•  
âœ… **å¼€å‘æ•ˆç‡é«˜**ï¼šå‰ç«¯ç”¨ axiosï¼Œåç«¯ç”¨ Crowï¼Œéƒ½æ˜¯æˆç†Ÿæ–¹æ¡ˆ  
âœ… **æ˜“äºè°ƒè¯•**ï¼šå¯ä»¥ç”¨ Postman/curl ç›´æ¥æµ‹è¯• API  
âœ… **æ”¯æŒè¿œç¨‹æ§åˆ¶**ï¼šæœªæ¥å¯ä»¥ä»æ‰‹æœºè®¿é—®ï¼ˆå¦‚ `http://192.168.1.100:8080`ï¼‰  
âœ… **å‰ç«¯çƒ­æ›´æ–°**ï¼šå¼€å‘æ—¶å‰ç«¯æ”¹åŠ¨ç«‹å³ç”Ÿæ•ˆ  

#### ç¼ºç‚¹
âŒ éœ€è¦å¼•å…¥ HTTP åº“ï¼ˆå¢åŠ ä¾èµ–ï¼‰  
âŒ å¤šäº†ä¸€å±‚ç½‘ç»œå¼€é”€ï¼ˆä½†å¯ä»¥å¿½ç•¥ï¼Œlocalhost å»¶è¿Ÿ < 1msï¼‰  

#### ä»£ç ç¤ºä¾‹

**å‰ç«¯ï¼ˆVue 3ï¼‰**ï¼š
```typescript
// æ·»åŠ ä»»åŠ¡
async function addTask(magnetUri: string) {
  const response = await axios.post('http://localhost:8080/api/tasks', {
    magnet_uri: magnetUri,
    save_path: 'E:\\Downloads'
  });
  console.log('Task created:', response.data.task_id);
}
```

**åç«¯ï¼ˆC++ + Crowï¼‰**ï¼š
```cpp
#include "crow.h"

int main() {
    crow::SimpleApp app;
    
    // å®šä¹‰ API è·¯ç”±
    CROW_ROUTE(app, "/api/tasks").methods("POST"_method)
    ([&](const crow::request& req) {
        auto body = crow::json::load(req.body);
        std::string magnet_uri = body["magnet_uri"].s();
        
        // è°ƒç”¨ä¸‹è½½ç®¡ç†å™¨
        std::string task_id = download_manager->addTask(magnet_uri, "E:\\Downloads");
        
        // è¿”å› JSON å“åº”
        crow::json::wvalue result;
        result["task_id"] = task_id;
        return crow::response(201, result);
    });
    
    // å¯åŠ¨æœåŠ¡å™¨
    app.port(8080).multithreaded().run();
}
```

---

### æ–¹æ¡ˆ 2ï¼šCEF JavaScript Bindingï¼ˆä¸éœ€è¦ HTTP åº“ï¼‰â­â­â­

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CEF æµè§ˆå™¨ï¼ˆJavaScriptï¼‰                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Vue 3 å‰ç«¯                                  â”‚  â”‚
â”‚  â”‚  window.addTask(magnetUri)  â† C++ æ³¨å†Œçš„å‡½æ•°â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C++ ä»£ç ï¼ˆCEF V8 Handlerï¼‰                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  class MyV8Handler : public CefV8Handler {   â”‚  â”‚
â”‚  â”‚    bool Execute(...) {                       â”‚  â”‚
â”‚  â”‚      // è°ƒç”¨ DownloadManager                 â”‚  â”‚
â”‚  â”‚      download_manager->addTask(...);         â”‚  â”‚
â”‚  â”‚    }                                         â”‚  â”‚
â”‚  â”‚  }                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                     â”‚
â”‚  DownloadControllerï¼ˆä¸‹è½½é€»è¾‘ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åŸç†

åœ¨ C++ ä¸­æ³¨å†Œ JavaScript å‡½æ•°ï¼Œå‰ç«¯å¯ä»¥ç›´æ¥è°ƒç”¨ï¼š

```cpp
// C++ ç«¯ï¼šæ³¨å†Œå‡½æ•°
CefRefPtr<CefV8Value> func = CefV8Value::CreateFunction("addTask", new MyV8Handler());
global->SetValue("addTask", func, V8_PROPERTY_ATTRIBUTE_NONE);

// JavaScript ç«¯ï¼šç›´æ¥è°ƒç”¨
window.addTask("magnet:?xt=...");  // ç›´æ¥è°ƒç”¨ C++ å‡½æ•°ï¼
```

#### ä¼˜ç‚¹
âœ… **ä¸éœ€è¦ HTTP åº“**ï¼šç›´æ¥ C++ â†” JavaScript é€šä¿¡  
âœ… **æ€§èƒ½æ›´å¥½**ï¼šæ— ç½‘ç»œå¼€é”€  
âœ… **æ›´"åŸç”Ÿ"**ï¼šCEF å®˜æ–¹æ¨èçš„æ–¹å¼  

#### ç¼ºç‚¹
âŒ **å®ç°å¤æ‚**ï¼šéœ€è¦å¤„ç† IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰  
âŒ **è°ƒè¯•å›°éš¾**ï¼šæ— æ³•ç”¨ Postman æµ‹è¯•  
âŒ **å‰åç«¯è€¦åˆ**ï¼šå‰ç«¯ä¾èµ– C++ æ¥å£å®šä¹‰  
âŒ **å¼‚æ­¥å¤„ç†éº»çƒ¦**ï¼šJavaScript å›è°ƒéœ€è¦è·¨è¿›ç¨‹ä¼ é€’  
âŒ **å¼€å‘ä½“éªŒå·®**ï¼šå‰ç«¯æ”¹åŠ¨éœ€è¦é‡æ–°ç¼–è¯‘ C++  

#### ä»£ç ç¤ºä¾‹ï¼ˆå¤æ‚ï¼ï¼‰

**C++ ç«¯ï¼ˆæ³¨å†Œå‡½æ•°ï¼‰**ï¼š
```cpp
// 1. å®šä¹‰ V8 Handler
class MyV8Handler : public CefV8Handler {
public:
    bool Execute(const CefString& name,
                 CefRefPtr<CefV8Value> object,
                 const CefV8ValueList& arguments,
                 CefRefPtr<CefV8Value>& retval,
                 CefString& exception) override {
        
        if (name == "addTask") {
            if (arguments.size() != 1 || !arguments[0]->IsString()) {
                exception = "Invalid arguments";
                return true;
            }
            
            std::string magnet_uri = arguments[0]->GetStringValue();
            
            // é—®é¢˜ï¼šè¿™é‡Œè¿è¡Œåœ¨æ¸²æŸ“è¿›ç¨‹ï¼Œéœ€è¦ IPC åˆ°ä¸»è¿›ç¨‹ï¼
            // éœ€è¦ä½¿ç”¨ CefProcessMessage å‘é€æ¶ˆæ¯
            CefRefPtr<CefBrowser> browser = CefV8Context::GetCurrentContext()->GetBrowser();
            CefRefPtr<CefProcessMessage> msg = CefProcessMessage::Create("add_task");
            msg->GetArgumentList()->SetString(0, magnet_uri);
            browser->GetMainFrame()->SendProcessMessage(PID_BROWSER, msg);
            
            return true;
        }
        return false;
    }
    
private:
    IMPLEMENT_REFCOUNTING(MyV8Handler);
};

// 2. åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­æ³¨å†Œ
class MyRenderProcessHandler : public CefRenderProcessHandler {
public:
    void OnContextCreated(CefRefPtr<CefBrowser> browser,
                         CefRefPtr<CefFrame> frame,
                         CefRefPtr<CefV8Context> context) override {
        CefRefPtr<CefV8Value> global = context->GetGlobal();
        
        // æ³¨å†Œå‡½æ•°
        CefRefPtr<CefV8Value> func = CefV8Value::CreateFunction("addTask", new MyV8Handler());
        global->SetValue("addTask", func, V8_PROPERTY_ATTRIBUTE_NONE);
    }
    
private:
    IMPLEMENT_REFCOUNTING(MyRenderProcessHandler);
};

// 3. åœ¨ä¸»è¿›ç¨‹ä¸­æ¥æ”¶æ¶ˆæ¯
class MyClient : public CefClient {
public:
    bool OnProcessMessageReceived(CefRefPtr<CefBrowser> browser,
                                 CefRefPtr<CefFrame> frame,
                                 CefProcessId source_process,
                                 CefRefPtr<CefProcessMessage> message) override {
        if (message->GetName() == "add_task") {
            std::string magnet_uri = message->GetArgumentList()->GetString(0);
            
            // ç»ˆäºå¯ä»¥è°ƒç”¨ä¸‹è½½ç®¡ç†å™¨äº†ï¼
            download_manager->addTask(magnet_uri, "E:\\Downloads");
            
            return true;
        }
        return false;
    }
};
```

**å‰ç«¯ï¼ˆVue 3ï¼‰**ï¼š
```typescript
// çœ‹èµ·æ¥ç®€å•ï¼Œä½†èƒŒåå¾ˆå¤æ‚
declare global {
  interface Window {
    addTask: (magnetUri: string) => void;
  }
}

function addTask(magnetUri: string) {
  window.addTask(magnetUri);  // è°ƒç”¨ C++ å‡½æ•°
}
```

**çœ‹åˆ°äº†å—ï¼Ÿä¸ºäº†é¿å… HTTP åº“ï¼Œéœ€è¦å†™å¤§é‡å¤æ‚çš„ IPC ä»£ç ï¼**

---

### æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ¡ˆï¼ˆç®€åŒ–ç‰ˆ Bindingï¼‰â­â­â­â­

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CEF æµè§ˆå™¨                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Vue 3 å‰ç«¯                                  â”‚  â”‚
â”‚  â”‚  è°ƒç”¨ window.cefQuery()                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ CefMessageRouterï¼ˆCEF æä¾›ï¼‰
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  C++ CefMessageRouterBrowserSide::Handler          â”‚
â”‚  OnQuery(request, callback)                        â”‚
â”‚  â†’ è§£æè¯·æ±‚ â†’ è°ƒç”¨ä¸‹è½½ç®¡ç†å™¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åŸç†

ä½¿ç”¨ CEF æä¾›çš„ `CefMessageRouter`ï¼Œç®€åŒ– IPCï¼š

**C++ ç«¯**ï¼š
```cpp
class MyQueryHandler : public CefMessageRouterBrowserSide::Handler {
public:
    bool OnQuery(CefRefPtr<CefBrowser> browser,
                 CefRefPtr<CefFrame> frame,
                 int64 query_id,
                 const CefString& request,
                 bool persistent,
                 CefRefPtr<Callback> callback) override {
        
        // è§£æè¯·æ±‚ï¼ˆå¯ä»¥ç”¨ JSONï¼‰
        std::string req = request.ToString();
        // {"action": "addTask", "magnet_uri": "..."}
        
        if (/* action == addTask */) {
            std::string task_id = download_manager->addTask(...);
            
            // è¿”å›ç»“æœ
            callback->Success(task_id);
            return true;
        }
        
        return false;
    }
};
```

**å‰ç«¯**ï¼š
```javascript
// CEF æä¾›çš„ window.cefQuery
window.cefQuery({
  request: JSON.stringify({
    action: 'addTask',
    magnet_uri: 'magnet:?xt=...'
  }),
  onSuccess: function(response) {
    console.log('Task ID:', response);
  },
  onFailure: function(error_code, error_message) {
    console.error('Error:', error_message);
  }
});
```

#### ä¼˜ç‚¹
âœ… ä¸éœ€è¦ HTTP åº“  
âœ… æ¯”æ–¹æ¡ˆ 2 ç®€å•ï¼ˆCEF å°è£…äº† IPCï¼‰  
âœ… æ€§èƒ½å¥½  

#### ç¼ºç‚¹
âŒ ä»ç„¶éœ€è¦å­¦ä¹  CEF ç‰¹å®š API  
âŒ è°ƒè¯•ä¸å¦‚ HTTP æ–¹ä¾¿  
âŒ å¼‚æ­¥å›è°ƒå¤„ç†éº»çƒ¦  

---

## ğŸ¯ æ–¹æ¡ˆé€‰æ‹©å»ºè®®

### æˆ‘å¼ºçƒˆæ¨èï¼š**æ–¹æ¡ˆ 1ï¼ˆHTTP APIï¼‰**

#### ç†ç”±å¯¹æ¯”è¡¨

| ç»´åº¦ | æ–¹æ¡ˆ 1ï¼ˆHTTPï¼‰ | æ–¹æ¡ˆ 2ï¼ˆV8 Bindingï¼‰ | æ–¹æ¡ˆ 3ï¼ˆMessageRouterï¼‰ |
|------|----------------|---------------------|------------------------|
| **å¼€å‘éš¾åº¦** | â­ ç®€å• | â­â­â­â­â­ éå¸¸å¤æ‚ | â­â­â­ ä¸­ç­‰ |
| **è°ƒè¯•ä½“éªŒ** | â­â­â­â­â­ å¯ç”¨ Postman | â­ å›°éš¾ | â­â­ ä¸€èˆ¬ |
| **å‰ç«¯å¼€å‘** | â­â­â­â­â­ æ ‡å‡† axios | â­â­ éœ€è¦å­¦ä¹  CEF API | â­â­ éœ€è¦å­¦ä¹  CEF API |
| **æ˜¯å¦éœ€è¦ HTTP åº“** | âŒ éœ€è¦ | âœ… ä¸éœ€è¦ | âœ… ä¸éœ€è¦ |
| **æ€§èƒ½** | â­â­â­â­ å¾ˆå¥½ | â­â­â­â­â­ æœ€å¥½ | â­â­â­â­â­ æœ€å¥½ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ å¯è¿œç¨‹æ§åˆ¶ | â­â­ ä»…æœ¬åœ° | â­â­ ä»…æœ¬åœ° |
| **ä»£ç é‡** | ~200 è¡Œ | ~500 è¡Œ | ~300 è¡Œ |

### ä¸ºä»€ä¹ˆ HTTP åº“å€¼å¾—å¼•å…¥ï¼Ÿ

#### 1. å¼€å‘æ•ˆç‡

```cpp
// ä½¿ç”¨ Crowï¼ˆHTTP åº“ï¼‰
CROW_ROUTE(app, "/api/tasks")
.methods("POST"_method)
([](const crow::request& req) {
    // ç›´æ¥å¤„ç†è¯·æ±‚
    auto json = crow::json::load(req.body);
    return crow::response(201, result);
});

// VS ä¸ç”¨ HTTP åº“ï¼ˆV8 Bindingï¼‰
// éœ€è¦å†™ 200 è¡Œ IPC ä»£ç ...
```

#### 2. è°ƒè¯•ä½“éªŒ

```bash
# ä½¿ç”¨ HTTP APIï¼šç”¨ curl æµ‹è¯•
curl -X POST http://localhost:8080/api/tasks \
  -d '{"magnet_uri": "..."}'

# ä¸ç”¨ HTTPï¼šåªèƒ½åœ¨ CEF ä¸­æµ‹è¯•ï¼Œæ— æ³•ç‹¬ç«‹éªŒè¯
```

#### 3. æœªæ¥æ‰©å±•

```
ä½¿ç”¨ HTTP APIï¼š
âœ… å¯ä»¥åš Web ç‰ˆï¼ˆæµè§ˆå™¨è®¿é—®ï¼‰
âœ… å¯ä»¥åšæ‰‹æœº Appï¼ˆè°ƒç”¨åŒæ ·çš„ APIï¼‰
âœ… å¯ä»¥è¿œç¨‹æ§åˆ¶ï¼ˆå±€åŸŸç½‘è®¿é—®ï¼‰

ä¸ç”¨ HTTPï¼š
âŒ åªèƒ½åœ¨ CEF ä¸­ä½¿ç”¨
âŒ æ— æ³•è¿œç¨‹æ§åˆ¶
```

#### 4. HTTP åº“å¾ˆè½»é‡

**Crow**ï¼ˆæ¨èï¼‰ï¼š
- **å¤§å°**ï¼šå•å¤´æ–‡ä»¶ï¼Œ~10KB
- **ä¾èµ–**ï¼šåªéœ€è¦ Boost.Asioï¼ˆä½ å·²ç»åœ¨ç”¨ï¼‰
- **æ€§èƒ½**ï¼šæ”¯æŒå¤šçº¿ç¨‹ï¼ŒQPS > 10000

**cpp-httplib**ï¼ˆæœ€ç®€å•ï¼‰ï¼š
- **å¤§å°**ï¼šå•å¤´æ–‡ä»¶ï¼Œ~8KB
- **ä¾èµ–**ï¼šé›¶ä¾èµ–ï¼
- **æ€§èƒ½**ï¼šå•çº¿ç¨‹ï¼ŒQPS ~5000ï¼ˆå¯¹ä½ çš„é¡¹ç›®è¶³å¤Ÿï¼‰

**ä½ çš„é¡¾è™‘å¯èƒ½æ˜¯ä»€ä¹ˆï¼Ÿ**
- â“ å¢åŠ ä¾èµ–ï¼Ÿâ†’ åªæ˜¯ä¸€ä¸ªå¤´æ–‡ä»¶
- â“ å­¦ä¹ æˆæœ¬ï¼Ÿâ†’ API éå¸¸ç®€å•ï¼ˆç±»ä¼¼ Flaskï¼‰
- â“ æ€§èƒ½å¼€é”€ï¼Ÿâ†’ localhost å»¶è¿Ÿ < 1msï¼Œå¯å¿½ç•¥

---

## ğŸš€ æœ€ç»ˆå»ºè®®

### æ¨èï¼šæ–¹æ¡ˆ 1ï¼ˆHTTP APIï¼‰+ cpp-httplib

**ç†ç”±**ï¼š
1. **é›¶ä¾èµ–**ï¼šcpp-httplib æ˜¯å•å¤´æ–‡ä»¶ï¼Œæ— éœ€å®‰è£…
2. **æç®€ API**ï¼š10 è¡Œä»£ç å¯åŠ¨æœåŠ¡å™¨
3. **æ€§èƒ½è¶³å¤Ÿ**ï¼šå¯¹æ¡Œé¢åº”ç”¨æ¥è¯´å®Œå…¨å¤Ÿç”¨
4. **æœªæ¥å¯æ‰©å±•**ï¼šè½»æ¾æ·»åŠ  Web æ§åˆ¶å°

### æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœä½ **åšå†³ä¸æƒ³ç”¨ HTTP åº“**ï¼Œé‚£ä¹ˆï¼š

**æ¨èæ–¹æ¡ˆ 3ï¼ˆCefMessageRouterï¼‰**
- æ¯” V8 Binding ç®€å•
- CEF å®˜æ–¹æä¾›
- ä¸éœ€è¦é¢å¤–ä¾èµ–

ä½†æ˜¯ï¼š
- âŒ å¼€å‘æ•ˆç‡ä½ï¼ˆæ¯” HTTP API å¤šèŠ± 2-3 å€æ—¶é—´ï¼‰
- âŒ è°ƒè¯•å›°éš¾
- âŒ æ— æ³•è¿œç¨‹æ§åˆ¶

---

## ğŸ“ ä»£ç é‡å¯¹æ¯”ï¼ˆå®é™…ä¾‹å­ï¼‰

### æ·»åŠ ä»»åŠ¡åŠŸèƒ½

#### ä½¿ç”¨ HTTP APIï¼ˆcpp-httplibï¼‰

```cpp
// C++ åç«¯ï¼ˆ20 è¡Œï¼‰
#include "httplib.h"

httplib::Server svr;

svr.Post("/api/tasks", [](const httplib::Request& req, httplib::Response& res) {
    auto json = nlohmann::json::parse(req.body);
    std::string magnet_uri = json["magnet_uri"];
    
    std::string task_id = download_manager->addTask(magnet_uri, "E:\\Downloads");
    
    res.set_content(R"({"task_id": ")" + task_id + R"("})", "application/json");
});

svr.listen("localhost", 8080);
```

```typescript
// Vue 3 å‰ç«¯ï¼ˆ10 è¡Œï¼‰
async function addTask(magnetUri: string) {
  const response = await axios.post('/api/tasks', {
    magnet_uri: magnetUri
  });
  return response.data.task_id;
}
```

**æ€»è®¡ï¼š30 è¡Œä»£ç **

---

#### ä¸ä½¿ç”¨ HTTP åº“ï¼ˆV8 Bindingï¼‰

```cpp
// C++ åç«¯ï¼ˆéœ€è¦ 3 ä¸ªæ–‡ä»¶ï¼Œ150+ è¡Œï¼‰

// 1. V8Handler.h + .cpp (~50 è¡Œ)
class MyV8Handler : public CefV8Handler { /* ... */ };

// 2. RenderProcessHandler.h + .cpp (~50 è¡Œ)
class MyRenderProcessHandler : public CefRenderProcessHandler { /* ... */ };

// 3. Client.cpp æ·»åŠ  OnProcessMessageReceived (~50 è¡Œ)
bool OnProcessMessageReceived(...) { /* ... */ }
```

```typescript
// Vue 3 å‰ç«¯ï¼ˆ20 è¡Œï¼Œéœ€è¦å°è£… Promiseï¼‰
function addTask(magnetUri: string): Promise<string> {
  return new Promise((resolve, reject) => {
    window.cefQuery({
      request: JSON.stringify({action: 'addTask', magnet_uri: magnetUri}),
      onSuccess: (response) => resolve(response),
      onFailure: (code, msg) => reject(msg)
    });
  });
}
```

**æ€»è®¡ï¼š200+ è¡Œä»£ç ï¼Œä¸”éš¾ä»¥è°ƒè¯•**

---

## ğŸ“ ç»“è®º

**ç­”æ¡ˆ**ï¼šéœ€è¦ HTTP åº“æ˜¯å› ä¸ºå®ƒè®©å‰åç«¯é€šä¿¡å˜å¾—**ç®€å•ã€å¯é ã€æ˜“è°ƒè¯•**ã€‚

è™½ç„¶æœ‰ä¸ç”¨ HTTP åº“çš„æ–¹æ¡ˆï¼Œä½†ä¼šè®©å¼€å‘å˜å¾—å¤æ‚ 3-5 å€ï¼Œä¸”å¤±å»å¾ˆå¤šå¥½å¤„ï¼ˆè°ƒè¯•ã€æ‰©å±•æ€§ï¼‰ã€‚

**æˆ‘çš„å»ºè®®**ï¼š
1. âœ… ä½¿ç”¨ **cpp-httplib**ï¼ˆå•å¤´æ–‡ä»¶ï¼Œé›¶ä¾èµ–ï¼‰
2. âœ… æˆ–è€… **Crow**ï¼ˆå¦‚æœä½ æƒ³è¦æ›´å¤šåŠŸèƒ½ï¼‰
3. âŒ ä¸æ¨è V8 Bindingï¼ˆé™¤éä½ æœ‰ç‰¹æ®Šæ€§èƒ½éœ€æ±‚ï¼‰

**ä½ ç°åœ¨çš„æƒ³æ³•æ˜¯ï¼Ÿ**
1. æ¥å—ä½¿ç”¨ HTTP åº“ï¼ˆcpp-httplib æˆ– Crowï¼‰
2. ä»ç„¶æƒ³å°è¯•ä¸ç”¨ HTTP åº“ï¼ˆæˆ‘å¯ä»¥å¸®ä½ å®ç° MessageRouter æ–¹æ¡ˆï¼‰
