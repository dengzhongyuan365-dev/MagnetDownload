# Google Test å’Œ Google Mock å•å…ƒæµ‹è¯•æŒ‡å—

> **ç›®æ ‡**ï¼šä¸º MagnetDownload é¡¹ç›®å»ºç«‹å®Œæ•´çš„å•å…ƒæµ‹è¯•ä½“ç³»
> 
> **æµ‹è¯•æ¡†æ¶**ï¼šGoogle Test (gtest) + Google Mock (gmock)
> 
> **æ›´æ–°æ—¶é—´**ï¼š2025-12-31




### 1.3 å¼€æºé¡¹ç›®å¦‚ä½•å¼•å…¥ gtest/gmock

#### æ–¹å¼ 1ï¼šFetchContentï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨ä¸‹è½½å’Œç¼–è¯‘
- âœ… ç‰ˆæœ¬æ§åˆ¶ç®€å•
- âœ… ä¸éœ€è¦æ‰‹åŠ¨å®‰è£…
- âœ… é€‚åˆ CI/CD ç¯å¢ƒ

**CMakeLists.txt é…ç½®**ï¼š

```cmake
include(FetchContent)

FetchContent_Declare(
  googletest
  GIT_REPOSITORY https://github.com/google/googletest.git
  GIT_TAG        v1.14.0  # ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬
)

set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)
```

#### æ–¹å¼ 3ï¼šGit Submodule

**ä¼˜åŠ¿**ï¼š
- âœ… å®Œå…¨æ§åˆ¶ç‰ˆæœ¬
- âœ… ç¦»çº¿å¼€å‘
- âœ… å¯ä»¥ä¿®æ”¹æºç 

**æ­¥éª¤**ï¼š

```bash
git submodule add https://github.com/google/googletest.git 3rd/googletest
git submodule update --init --recursive
```

**CMakeLists.txt é…ç½®**ï¼š

```cmake
add_subdirectory(3rd/googletest)
target_link_libraries(my_tests gtest gmock)
```

**ä½¿ç”¨æ¡ˆä¾‹**ï¼š
- éœ€è¦å®šåˆ¶ gtest çš„é¡¹ç›®
- ç¦»çº¿å¼€å‘ç¯å¢ƒ

---

## 2. æˆ‘ä»¬çš„é¡¹ç›®å¦‚ä½•å¼•å…¥

### 2.1 æ¨èæ–¹æ¡ˆï¼šFetchContent

**ç†ç”±**ï¼š
1. âœ… é¡¹ç›®å¤„äºå¼€å‘é˜¶æ®µï¼Œä¾èµ–ç®¡ç†ç®€å•
2. âœ… CI/CD å‹å¥½ï¼Œä¸éœ€è¦é¢„å®‰è£…
3. âœ… å›¢é˜Ÿæˆå‘˜ç¯å¢ƒç»Ÿä¸€
4. âœ… ç‰ˆæœ¬é”å®šï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜


### 2.2 é›†æˆæ­¥éª¤

#### æ­¥éª¤ 1ï¼šä¿®æ”¹æ ¹ç›®å½• CMakeLists.txt

åœ¨ `MagnetDownload/CMakeLists.txt` ä¸­æ·»åŠ ï¼š

```cmake
# é¡¹ç›®é€‰é¡¹
option(BUILD_TESTS "Build unit tests" ON)

# æ·»åŠ æµ‹è¯•
if(BUILD_TESTS)
    enable_testing()
    
    # ä½¿ç”¨ FetchContent è·å– Google Test
    include(FetchContent)
    FetchContent_Declare(
        googletest
        GIT_REPOSITORY https://github.com/google/googletest.git
        GIT_TAG v1.14.0
    )
    
    # å¯¹äº Windows: é˜²æ­¢è¦†ç›–çˆ¶é¡¹ç›®çš„ç¼–è¯‘å™¨/é“¾æ¥å™¨è®¾ç½®
    set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
    
    # ä½¿ Google Test å¯ç”¨
    FetchContent_MakeAvailable(googletest)
    
    # åŒ…å« Google Test çš„ CMake æ¨¡å—
    include(GoogleTest)
    
    add_subdirectory(tests)
endif()
```

#### æ­¥éª¤ 2ï¼šåˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„

```
MagnetDownload/
â””â”€â”€ tests/
    â”œâ”€â”€ CMakeLists.txt              # æµ‹è¯•çš„ CMake é…ç½®
    â”œâ”€â”€ test_main.cpp               # æµ‹è¯•ä¸»å…¥å£
    â”œâ”€â”€ protocols/                  # åè®®æ¨¡å—æµ‹è¯•
    â”‚   â”œâ”€â”€ test_bencode.cpp
    â”‚   â””â”€â”€ test_magnet_parser.cpp
    â”œâ”€â”€ network/                    # ç½‘ç»œæ¨¡å—æµ‹è¯•
    â”‚   â””â”€â”€ test_udp_client.cpp
    â””â”€â”€ mocks/                      # Mock å¯¹è±¡
        â”œâ”€â”€ mock_udp_client.h
        â””â”€â”€ mock_io_context.h
```

#### æ­¥éª¤ 3ï¼šé…ç½® tests/CMakeLists.txt

```cmake
# æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
add_executable(magnet_tests
    test_main.cpp
    protocols/test_bencode.cpp
    protocols/test_magnet_parser.cpp
    network/test_udp_client.cpp
)

# é“¾æ¥åº“
target_link_libraries(magnet_tests
    PRIVATE
        GTest::gtest
        GTest::gtest_main
        GTest::gmock
        GTest::gmock_main
        asio
        Threads::Threads
)

# åŒ…å«ç›®å½•
target_include_directories(magnet_tests
    PRIVATE
        ${CMAKE_SOURCE_DIR}/include
        ${CMAKE_SOURCE_DIR}/tests
)

# å‘ç°æµ‹è¯•ï¼ˆè‡ªåŠ¨æ³¨å†Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼‰
gtest_discover_tests(magnet_tests)
```

#### æ­¥éª¤ 4ï¼šåˆ›å»ºæµ‹è¯•ä¸»å…¥å£

`tests/test_main.cpp`ï¼š

```cpp
#include <gtest/gtest.h>

int main(int argc, char** argv) {
    ::testing::InitGoogleTest(&argc, argv);
    return RUN_ALL_TESTS();
}
```

### 2.3 ç¼–è¯‘é…ç½®

```bash
# é…ç½®é¡¹ç›®ï¼ˆå¯ç”¨æµ‹è¯•ï¼‰
cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON

# ç¼–è¯‘
cmake --build build

# è¿è¡Œæµ‹è¯•
cd build
ctest
```

---

## 3. å•å…ƒæµ‹è¯•é‡ç‚¹å’Œç”¨ä¾‹è®¾è®¡

### 3.1 æµ‹è¯•é‡‘å­—å¡”åŸåˆ™

```
        /\
       /  \  E2E Tests (å°‘é‡)
      /----\
     / Unit \ Integration Tests (é€‚é‡)
    /  Tests \ 
   /----------\  Unit Tests (å¤§é‡)
```

**æˆ‘ä»¬çš„é‡ç‚¹**ï¼š
- 70% å•å…ƒæµ‹è¯•ï¼ˆUnit Testsï¼‰
- 20% é›†æˆæµ‹è¯•ï¼ˆIntegration Testsï¼‰
- 10% ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆE2E Tests)


### 3.2 å“ªäº›éœ€è¦å•å…ƒæµ‹è¯•

#### âœ… å¿…é¡»æµ‹è¯•

1. **æ ¸å¿ƒç®—æ³•å’Œæ•°æ®ç»“æ„**
   - Bencode ç¼–è§£ç 
   - ç£åŠ›é“¾æ¥è§£æ
   - InfoHash è½¬æ¢

2. **è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†**
   - ç©ºè¾“å…¥
   - æ— æ•ˆè¾“å…¥
   - è¶…å¤§è¾“å…¥
   - æ ¼å¼é”™è¯¯

3. **å…¬å…± API æ¥å£**
   - æ‰€æœ‰ public æ–¹æ³•
   - è¿”å›å€¼éªŒè¯
   - å¼‚å¸¸å¤„ç†

4. **ä¸šåŠ¡é€»è¾‘**
   - DHT åè®®é€»è¾‘
   - Peer ç®¡ç†é€»è¾‘
   - ä¸‹è½½è°ƒåº¦é€»è¾‘

#### âŒ ä¸éœ€è¦æµ‹è¯•

1. **ç®€å•çš„ getter/setter**
   ```cpp
   uint16_t get_port() const { return port_; }  // ä¸éœ€è¦æµ‹è¯•
   ```

2. **ç¬¬ä¸‰æ–¹åº“çš„åŠŸèƒ½**
   - asio çš„ç½‘ç»œåŠŸèƒ½ï¼ˆå·²ç»æµ‹è¯•è¿‡ï¼‰
   - æ ‡å‡†åº“åŠŸèƒ½

3. **çº¯ç²¹çš„æ•°æ®ç±»**
   ```cpp
   struct Config {
       std::string name;
       int value;
   };  // ä¸éœ€è¦æµ‹è¯•
   ```


### 3.3 æµ‹è¯•ç”¨ä¾‹è®¾è®¡åŸåˆ™

#### FIRST åŸåˆ™

- **F**astï¼ˆå¿«é€Ÿï¼‰ï¼šæµ‹è¯•åº”è¯¥å¿«é€Ÿè¿è¡Œ
- **I**ndependentï¼ˆç‹¬ç«‹ï¼‰ï¼šæµ‹è¯•ä¹‹é—´ä¸åº”è¯¥æœ‰ä¾èµ–
- **R**epeatableï¼ˆå¯é‡å¤ï¼‰ï¼šæµ‹è¯•ç»“æœåº”è¯¥ä¸€è‡´
- **S**elf-Validatingï¼ˆè‡ªæˆ‘éªŒè¯ï¼‰ï¼šæµ‹è¯•åº”è¯¥è‡ªåŠ¨åˆ¤æ–­æˆåŠŸæˆ–å¤±è´¥
- **T**imelyï¼ˆåŠæ—¶ï¼‰ï¼šæµ‹è¯•åº”è¯¥åŠæ—¶ç¼–å†™

#### AAA æ¨¡å¼

```cpp
TEST(ExampleTest, TestCase) {
    // Arrangeï¼ˆå‡†å¤‡ï¼‰ï¼šè®¾ç½®æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
    BencodeValue value(42);
    
    // Actï¼ˆæ‰§è¡Œï¼‰ï¼šæ‰§è¡Œè¢«æµ‹è¯•çš„æ“ä½œ
    std::string encoded = Bencode::encode(value);
    
    // Assertï¼ˆæ–­è¨€ï¼‰ï¼šéªŒè¯ç»“æœ
    EXPECT_EQ(encoded, "i42e");
}
```

### 3.4 æµ‹è¯•ç”¨ä¾‹å‘½åè§„èŒƒ

**æ ¼å¼**ï¼š`TEST(TestSuiteName, TestName)`

**å‘½åå»ºè®®**ï¼š
- TestSuiteNameï¼šæ¨¡å—åæˆ–ç±»å
- TestNameï¼šæè¿°æµ‹è¯•çš„åŠŸèƒ½

**ç¤ºä¾‹**ï¼š

```cpp
// âœ… å¥½çš„å‘½å
TEST(BencodeTest, EncodePositiveInteger)
TEST(MagnetParserTest, ParseStandardMagnetUri)
TEST(UdpClientTest, SendAndReceive)

// âŒ å·®çš„å‘½å
TEST(test_bencode, test1)
TEST(parser, test)
TEST(TestCase, TestMethod)
```

### 3.5 è¯¦ç»†æµ‹è¯•ç”¨ä¾‹è®¾è®¡

è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹è®¾è®¡è¯·å‚è€ƒï¼š
- [å•å…ƒæµ‹è¯•ç”¨ä¾‹è®¾è®¡è¯¦è§£](./å•å…ƒæµ‹è¯•ç”¨ä¾‹è®¾è®¡.md)

åŒ…å«ï¼š
- MagnetUriParser æµ‹è¯•ç”¨ä¾‹ï¼ˆ17+ ä¸ªï¼‰
- Bencode æµ‹è¯•ç”¨ä¾‹ï¼ˆ30+ ä¸ªï¼‰
- UdpClient æµ‹è¯•ç”¨ä¾‹ï¼ˆ15+ ä¸ªï¼‰

---

## 4. è¿è¡Œæµ‹è¯•å’Œè¦†ç›–ç‡ç»Ÿè®¡

### 4.1 ç¼–è¯‘å’Œè¿è¡Œæµ‹è¯•

#### åŸºæœ¬å‘½ä»¤

```bash
# 1. é…ç½®é¡¹ç›®ï¼ˆå¯ç”¨æµ‹è¯•ï¼‰
cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON

# 2. ç¼–è¯‘
cmake --build build

# 3. è¿è¡Œæ‰€æœ‰æµ‹è¯•
cd build
ctest

# æˆ–è€…ç›´æ¥è¿è¡Œæµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
./tests/magnet_tests
```

#### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•å¥—ä»¶
./tests/magnet_tests --gtest_filter=BencodeTest.*

# è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
./tests/magnet_tests --gtest_filter=BencodeTest.EncodeInteger

# è¿è¡Œå¤šä¸ªæµ‹è¯•å¥—ä»¶
./tests/magnet_tests --gtest_filter=BencodeTest.*:MagnetParserTest.*

# æ’é™¤æŸäº›æµ‹è¯•
./tests/magnet_tests --gtest_filter=-BencodeTest.PerformanceTest
```

#### è¯¦ç»†è¾“å‡º

```bash
# è¯¦ç»†è¾“å‡º
./tests/magnet_tests --gtest_verbose

# æ˜¾ç¤ºæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
./tests/magnet_tests --gtest_list_tests

# é‡å¤è¿è¡Œï¼ˆç”¨äºæ£€æµ‹ä¸ç¨³å®šçš„æµ‹è¯•ï¼‰
./tests/magnet_tests --gtest_repeat=100

# éšæœºé¡ºåºè¿è¡Œï¼ˆæ£€æµ‹æµ‹è¯•ä¾èµ–ï¼‰
./tests/magnet_tests --gtest_shuffle
```

### 4.2 CTest å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
ctest

# è¯¦ç»†è¾“å‡º
ctest -V

# è¿è¡Œç‰¹å®šæµ‹è¯•
ctest -R Bencode

# å¹¶è¡Œè¿è¡Œï¼ˆ4 ä¸ªçº¿ç¨‹ï¼‰
ctest -j4

# å¤±è´¥æ—¶æ˜¾ç¤ºè¾“å‡º
ctest --output-on-failure

# é‡æ–°è¿è¡Œå¤±è´¥çš„æµ‹è¯•
ctest --rerun-failed

# æ˜¾ç¤ºæµ‹è¯•æ—¶é—´
ctest --verbose
```


### 4.3 æµ‹è¯•è¦†ç›–ç‡ç»Ÿè®¡

#### 4.3.1 ä½¿ç”¨ gcov/lcov

**æ­¥éª¤ 1ï¼šå¯ç”¨è¦†ç›–ç‡ç¼–è¯‘é€‰é¡¹**

åœ¨ `CMakeLists.txt` ä¸­æ·»åŠ ï¼š

```cmake
option(ENABLE_COVERAGE "Enable code coverage" OFF)

if(ENABLE_COVERAGE)
    if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" OR CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} --coverage")
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} --coverage")
    endif()
endif()
```

**æ­¥éª¤ 2ï¼šå®‰è£…å·¥å…·**

```bash
# Ubuntu/Debian
sudo apt-get install lcov

# macOS
brew install lcov
```

**æ­¥éª¤ 3ï¼šç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•**

```bash
# é…ç½®ï¼ˆå¯ç”¨è¦†ç›–ç‡ï¼‰
cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON -DENABLE_COVERAGE=ON

# ç¼–è¯‘
cmake --build build

# è¿è¡Œæµ‹è¯•
cd build
ctest

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
lcov --capture --directory . --output-file coverage.info

# è¿‡æ»¤ç³»ç»Ÿæ–‡ä»¶å’Œæµ‹è¯•æ–‡ä»¶
lcov --remove coverage.info '/usr/*' '*/tests/*' '*/3rd/*' --output-file coverage_filtered.info

# ç”Ÿæˆ HTML æŠ¥å‘Š
genhtml coverage_filtered.info --output-directory coverage_html

# æŸ¥çœ‹æŠ¥å‘Š
xdg-open coverage_html/index.html  # Linux
open coverage_html/index.html      # macOS
```

**æ­¥éª¤ 4ï¼šæŸ¥çœ‹è¦†ç›–ç‡æ‘˜è¦**

```bash
# æ˜¾ç¤ºè¦†ç›–ç‡æ‘˜è¦
lcov --summary coverage_filtered.info
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
Summary coverage rate:
  lines......: 85.3% (1234 of 1447 lines)
  functions..: 92.1% (123 of 134 functions)
  branches...: 78.5% (456 of 581 branches)
```

#### 4.3.2 ä½¿ç”¨ gcovrï¼ˆæ›´ç®€å•ï¼‰

**å®‰è£…**ï¼š

```bash
pip install gcovr
```

**ç”ŸæˆæŠ¥å‘Š**ï¼š

```bash
# é…ç½®å’Œç¼–è¯‘ï¼ˆåŒä¸Šï¼‰
cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON -DENABLE_COVERAGE=ON
cmake --build build
cd build
ctest

# ç”Ÿæˆ HTML æŠ¥å‘Š
gcovr --root .. --html --html-details -o coverage.html

# ç”Ÿæˆ XML æŠ¥å‘Šï¼ˆç”¨äº CIï¼‰
gcovr --root .. --xml -o coverage.xml

# ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š
gcovr --root ..
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
------------------------------------------------------------------------------
GCC Code Coverage Report
Directory: .
------------------------------------------------------------------------------
File                                       Lines    Exec  Cover   Missing
------------------------------------------------------------------------------
include/magnet/protocols/bencode.h           45      42   93%   12,34,56
src/protocols/bencode.cpp                   123     105   85%   45-52,78
include/magnet/protocols/magnet_parser.h     34      32   94%   23,45
src/protocols/magnet_parser.cpp              89      76   85%   12-18,67
------------------------------------------------------------------------------
TOTAL                                       291     255   87%
------------------------------------------------------------------------------
```

### 4.4 ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šç½‘é¡µ

#### 4.4.1 ä½¿ç”¨ Google Test çš„ XML è¾“å‡º

```bash
# ç”Ÿæˆ XML æŠ¥å‘Š
./tests/magnet_tests --gtest_output=xml:test_results.xml

# ç”Ÿæˆ JSON æŠ¥å‘Š
./tests/magnet_tests --gtest_output=json:test_results.json
```

**XML æŠ¥å‘Šç¤ºä¾‹**ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<testsuites tests="15" failures="0" disabled="0" errors="0" time="0.123" name="AllTests">
  <testsuite name="BencodeTest" tests="10" failures="0" disabled="0" errors="0" time="0.089">
    <testcase name="EncodeInteger" status="run" time="0.001" classname="BencodeTest" />
    <testcase name="DecodeInteger" status="run" time="0.002" classname="BencodeTest" />
    ...
  </testsuite>
  <testsuite name="MagnetParserTest" tests="5" failures="0" disabled="0" errors="0" time="0.034">
    <testcase name="ParseStandardUri" status="run" time="0.005" classname="MagnetParserTest" />
    ...
  </testsuite>
</testsuites>
```

#### 4.4.2 ä½¿ç”¨ gtest-html-reporter ç”Ÿæˆç½‘é¡µ

**å®‰è£…**ï¼š

```bash
npm install -g gtest-html-reporter
```

**ç”Ÿæˆç½‘é¡µ**ï¼š

```bash
# 1. ç”Ÿæˆ XML æŠ¥å‘Š
./tests/magnet_tests --gtest_output=xml:test_results.xml

# 2. è½¬æ¢ä¸º HTML
gtest-html-reporter test_results.xml -o test_report.html

# 3. æŸ¥çœ‹æŠ¥å‘Š
xdg-open test_report.html
```

#### 4.4.3 é›†æˆè¦†ç›–ç‡å’Œæµ‹è¯•æŠ¥å‘Š

**åˆ›å»ºè„šæœ¬** `scripts/run_tests_with_coverage.sh`ï¼š

```bash
#!/bin/bash

# é…ç½®å’Œç¼–è¯‘
cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON -DENABLE_COVERAGE=ON
cmake --build build

cd build

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆ XML æŠ¥å‘Š
./tests/magnet_tests --gtest_output=xml:test_results.xml

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
gcovr --root .. --html --html-details -o coverage.html

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šç½‘é¡µ
gtest-html-reporter test_results.xml -o test_report.html

echo "========================================="
echo "æµ‹è¯•å®Œæˆï¼"
echo "æµ‹è¯•æŠ¥å‘Š: build/test_report.html"
echo "è¦†ç›–ç‡æŠ¥å‘Š: build/coverage.html"
echo "========================================="

# è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Š
xdg-open test_report.html
xdg-open coverage.html
```

**ä½¿ç”¨**ï¼š

```bash
chmod +x scripts/run_tests_with_coverage.sh
./scripts/run_tests_with_coverage.sh
```

### 4.5 CI/CD é›†æˆ

#### 4.5.1 GitHub Actions é…ç½®

åˆ›å»º `.github/workflows/tests.yml`ï¼š

```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ lcov
    
    - name: Configure
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=ON -DENABLE_COVERAGE=ON
    
    - name: Build
      run: cmake --build build
    
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure
    
    - name: Generate coverage
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/3rd/*' --output-file coverage_filtered.info
        lcov --summary coverage_filtered.info
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: build/coverage_filtered.info
        fail_ci_if_error: true
```

#### 4.5.2 ä½¿ç”¨ Codecov æŸ¥çœ‹è¦†ç›–ç‡

1. è®¿é—® https://codecov.io/
2. ä½¿ç”¨ GitHub è´¦å·ç™»å½•
3. æ·»åŠ ä½ çš„ä»“åº“
4. æ¯æ¬¡ push åè‡ªåŠ¨ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
5. åœ¨ç½‘é¡µä¸ŠæŸ¥çœ‹è¯¦ç»†çš„è¦†ç›–ç‡ä¿¡æ¯

**Codecov æä¾›**ï¼š
- âœ… è¡Œè¦†ç›–ç‡
- âœ… åˆ†æ”¯è¦†ç›–ç‡
- âœ… å‡½æ•°è¦†ç›–ç‡
- âœ… è¦†ç›–ç‡è¶‹åŠ¿å›¾
- âœ… PR è¦†ç›–ç‡å¯¹æ¯”
- âœ… æœªè¦†ç›–ä»£ç é«˜äº®

### 4.6 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æ¨¡å— | è¡Œè¦†ç›–ç‡ | åˆ†æ”¯è¦†ç›–ç‡ | å‡½æ•°è¦†ç›–ç‡ | ä¼˜å…ˆçº§ |
|------|---------|-----------|-----------|--------|
| **åè®®æ¨¡å—** | 90%+ | 85%+ | 95%+ | ğŸ”´ é«˜ |
| Bencode | 95%+ | 90%+ | 100% | ğŸ”´ é«˜ |
| MagnetUriParser | 95%+ | 90%+ | 100% | ğŸ”´ é«˜ |
| **ç½‘ç»œæ¨¡å—** | 80%+ | 75%+ | 90%+ | ğŸŸ¡ ä¸­ |
| UdpClient | 85%+ | 80%+ | 95%+ | ğŸŸ¡ ä¸­ |
| **DHT æ¨¡å—** | 85%+ | 80%+ | 90%+ | ğŸ”´ é«˜ |
| DHTClient | 90%+ | 85%+ | 95%+ | ğŸ”´ é«˜ |
| **ä¸‹è½½æ¨¡å—** | 80%+ | 75%+ | 90%+ | ğŸŸ¡ ä¸­ |
| **æ•´ä½“é¡¹ç›®** | 85%+ | 80%+ | 90%+ | ğŸ”´ é«˜ |

### 4.7 æµ‹è¯•é€šè¿‡ç‡ç»Ÿè®¡

**æŸ¥çœ‹æµ‹è¯•é€šè¿‡ç‡**ï¼š

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç»Ÿè®¡
ctest --output-on-failure | tee test_output.txt

# ç»Ÿè®¡é€šè¿‡ç‡
echo "é€šè¿‡ç‡ç»Ÿè®¡ï¼š"
grep "tests passed" test_output.txt
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
100% tests passed, 0 tests failed out of 45

Total Test time (real) =   2.34 sec
```

**ç”Ÿæˆå¾½ç« **ï¼ˆç”¨äº READMEï¼‰ï¼š

åœ¨ README.md ä¸­æ·»åŠ ï¼š

```markdown
![Tests](https://github.com/username/MagnetDownload/workflows/Tests/badge.svg)
![Coverage](https://codecov.io/gh/username/MagnetDownload/branch/main/graph/badge.svg)
```

---

## 5. æœ€ä½³å®è·µæ€»ç»“

### 5.1 æµ‹è¯•ç¼–å†™å»ºè®®

1. **å…ˆå†™æµ‹è¯•ï¼Œåå†™å®ç°**ï¼ˆTDDï¼‰
2. **æ¯ä¸ªåŠŸèƒ½è‡³å°‘ 3 ä¸ªæµ‹è¯•**ï¼šæ­£å¸¸ã€è¾¹ç•Œã€é”™è¯¯
3. **ä½¿ç”¨ Mock éš”ç¦»ä¾èµ–**
4. **æµ‹è¯•åº”è¯¥å¿«é€Ÿè¿è¡Œ**ï¼ˆ< 1 ç§’ï¼‰
5. **æµ‹è¯•åº”è¯¥ç‹¬ç«‹**ï¼ˆä¸ä¾èµ–å…¶ä»–æµ‹è¯•ï¼‰

### 5.2 æŒç»­æ”¹è¿›

1. **å®šæœŸæ£€æŸ¥è¦†ç›–ç‡**
2. **è¡¥å……ç¼ºå¤±çš„æµ‹è¯•**
3. **é‡æ„æµ‹è¯•ä»£ç **ï¼ˆæ¶ˆé™¤é‡å¤ï¼‰
4. **æ›´æ–°æµ‹è¯•æ–‡æ¡£**

### 5.3 å›¢é˜Ÿåä½œ

1. **PR å¿…é¡»åŒ…å«æµ‹è¯•**
2. **æµ‹è¯•å¤±è´¥ä¸èƒ½åˆå¹¶**
3. **è¦†ç›–ç‡ä¸èƒ½ä¸‹é™**
4. **å®šæœŸ Code Review æµ‹è¯•ä»£ç **

---

## 6. å‚è€ƒèµ„æº

### 6.1 å®˜æ–¹æ–‡æ¡£

- [Google Test å®˜æ–¹æ–‡æ¡£](https://google.github.io/googletest/)
- [Google Mock å®˜æ–¹æ–‡æ¡£](https://google.github.io/googletest/gmock_for_dummies.html)
- [CMake æµ‹è¯•æ–‡æ¡£](https://cmake.org/cmake/help/latest/manual/ctest.1.html)

### 6.2 æ•™ç¨‹å’Œç¤ºä¾‹

- [Google Test Primer](https://google.github.io/googletest/primer.html)
- [Google Mock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [C++ Testing Best Practices](https://github.com/cpp-best-practices/cppbestpractices/blob/master/02-Use_the_Tools_Available.md#testing)

### 6.3 å·¥å…·

- [lcov](http://ltp.sourceforge.net/coverage/lcov.php) - è¦†ç›–ç‡å·¥å…·
- [gcovr](https://gcovr.com/) - è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå™¨
- [Codecov](https://codecov.io/) - åœ¨çº¿è¦†ç›–ç‡æœåŠ¡
- [gtest-html-reporter](https://www.npmjs.com/package/gtest-html-reporter) - æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå™¨

