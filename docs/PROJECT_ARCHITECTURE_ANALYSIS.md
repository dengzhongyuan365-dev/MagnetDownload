# MagnetDownload é¡¹ç›®æ¶æ„æ·±åº¦åˆ†æ

> **æ–‡æ¡£ç›®çš„**ï¼šåŸºäºç°æœ‰ä»£ç å’Œè®¾è®¡æ–‡æ¡£ï¼Œå…¨é¢åˆ†æé¡¹ç›®çš„æ¶æ„è®¾è®¡ã€å®ç°ç°çŠ¶ã€æŠ€æœ¯é€‰å‹å’Œæ¼”è¿›è·¯å¾„

**ç”Ÿæˆæ—¶é—´**ï¼š2024-12-26  
**åˆ†æèŒƒå›´**ï¼šæ¶æ„è®¾è®¡ã€ä»£ç å®ç°ã€æŠ€æœ¯å†³ç­–ã€æœªæ¥è§„åˆ’

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è§ˆ](#1-é¡¹ç›®æ¦‚è§ˆ)
2. [æ¶æ„è®¾è®¡åˆ†æ](#2-æ¶æ„è®¾è®¡åˆ†æ)
3. [æ ¸å¿ƒæ¨¡å—å®ç°ç°çŠ¶](#3-æ ¸å¿ƒæ¨¡å—å®ç°ç°çŠ¶)
4. [æŠ€æœ¯é€‰å‹åˆ†æ](#4-æŠ€æœ¯é€‰å‹åˆ†æ)
5. [è®¾è®¡æ¨¡å¼åº”ç”¨](#5-è®¾è®¡æ¨¡å¼åº”ç”¨)
6. [æ€§èƒ½ä¸æ‰©å±•æ€§](#6-æ€§èƒ½ä¸æ‰©å±•æ€§)
7. [å½“å‰é—®é¢˜ä¸æ”¹è¿›å»ºè®®](#7-å½“å‰é—®é¢˜ä¸æ”¹è¿›å»ºè®®)
8. [å®æ–½è·¯çº¿å›¾è¯„ä¼°](#8-å®æ–½è·¯çº¿å›¾è¯„ä¼°)

---

## 1. é¡¹ç›®æ¦‚è§ˆ

### 1.1 é¡¹ç›®å®šä½

**MagnetDownload** æ˜¯ä¸€ä¸ªåŸºäºç°ä»£ C++ çš„é«˜æ€§èƒ½ç£åŠ›é“¾æ¥ä¸‹è½½å™¨ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- ğŸ¯ **å­¦ä¹ å¯¼å‘**ï¼šä½œä¸ºå­¦ä¹ ç°ä»£ C++ å’Œç½‘ç»œç¼–ç¨‹çš„å®è·µé¡¹ç›®
- ğŸš€ **é«˜æ€§èƒ½**ï¼šå¤šçº¿ç¨‹äº‹ä»¶å¾ªç¯ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
- ğŸ”§ **å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒåè®®æ’ä»¶
- ğŸ“š **ç°ä»£åŒ–**ï¼šåº”ç”¨ C++17/20 ç‰¹æ€§ï¼Œé¢„ç•™åç¨‹æ‰©å±•

### 1.2 æ ¸å¿ƒç›®æ ‡

```
çŸ­æœŸç›®æ ‡ï¼ˆMVPï¼‰ï¼šå®ç°åŸºæœ¬çš„ç£åŠ›é“¾æ¥ä¸‹è½½åŠŸèƒ½
ä¸­æœŸç›®æ ‡ï¼šæ”¯æŒå¤šåè®®ã€æ€§èƒ½ä¼˜åŒ–
é•¿æœŸç›®æ ‡ï¼šç”Ÿäº§çº§ä¸‹è½½å™¨ï¼Œæ”¯æŒ GUI
```

### 1.3 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|---------|------|------|
| è¯­è¨€ | C++ | 17/20 | ä½¿ç”¨ç°ä»£ç‰¹æ€§ |
| ç½‘ç»œåº“ | Asio | Standalone | ç‹¬ç«‹ç‰ˆï¼Œæ—  Boost ä¾èµ– |
| æ„å»ºç³»ç»Ÿ | CMake | 3.16+ | è·¨å¹³å°æ„å»º |
| æµ‹è¯•æ¡†æ¶ | è‡ªå®šä¹‰ | - | åæœŸå¯æ‰©å±• |

---

## 2. æ¶æ„è®¾è®¡åˆ†æ

### 2.1 æ•´ä½“æ¶æ„æ¨¡å¼

é¡¹ç›®é‡‡ç”¨**åˆ†å±‚ + äº‹ä»¶é©±åŠ¨**æ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application)                  â”‚
â”‚              CLI / GUI / ä¸‹è½½ç®¡ç†å™¨                       â”‚
â”‚  - ç”¨æˆ·äº¤äº’  - ä»»åŠ¡ç®¡ç†  - è¿›åº¦å±•ç¤º                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡å±‚ (Business)                     â”‚
â”‚           åè®®å¤„ç† + ä»»åŠ¡è°ƒåº¦ + çŠ¶æ€ç®¡ç†                  â”‚
â”‚  - MagnetParser  - DHTClient  - PeerManager              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç½‘ç»œå±‚ (Network)                      â”‚
â”‚            è¿æ¥ç®¡ç† + æ•°æ®ä¼ è¾“ + DHT ç½‘ç»œ                 â”‚
â”‚  - TCP/UDP Socket  - æ¶ˆæ¯åºåˆ—åŒ–  - åè®®å®ç°              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŸºç¡€å±‚ (Foundation)                   â”‚
â”‚          äº‹ä»¶å¾ªç¯ + ä»»åŠ¡è°ƒåº¦ + æ—¥å¿— + é…ç½®                â”‚
â”‚  - EventLoopManager  - TaskScheduler  - Logger           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Asio äº‹ä»¶å¾ªç¯æ ¸å¿ƒ                        â”‚
â”‚              io_context + å¼‚æ­¥ I/O                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒè®¾è®¡ç†å¿µ

#### 2.2.1 äº‹ä»¶é©±åŠ¨ (Event-Driven)

**è®¾è®¡æ€æƒ³**ï¼š
- åŸºäº Asio çš„ Reactor æ¨¡å¼
- å¼‚æ­¥éé˜»å¡ I/O
- å›è°ƒé©±åŠ¨çš„æ‰§è¡Œæµç¨‹

**ä¼˜åŠ¿**ï¼š
- âœ… é«˜å¹¶å‘å¤„ç†èƒ½åŠ›ï¼ˆ100-300 ä¸ªè¿æ¥ï¼‰
- âœ… èµ„æºåˆ©ç”¨ç‡é«˜
- âœ… é€‚åˆ I/O å¯†é›†å‹åº”ç”¨

**æŒ‘æˆ˜**ï¼š
- âš ï¸ å›è°ƒåœ°ç‹±ï¼ˆå·²é€šè¿‡æ¨¡å—åŒ–ç¼“è§£ï¼‰
- âš ï¸ è°ƒè¯•å¤æ‚åº¦ï¼ˆéœ€è¦è‰¯å¥½çš„æ—¥å¿—ç³»ç»Ÿï¼‰

#### 2.2.2 å¤šçº¿ç¨‹äº‹ä»¶å¾ªç¯æ± 

**è®¾è®¡æ€æƒ³**ï¼š
```cpp
// åˆ›å»º N ä¸ª io_contextï¼ŒN = CPU æ ¸å¿ƒæ•°
std::vector<io_context> contexts(hardware_concurrency());

// æ¯ä¸ª io_context è¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹
for (auto& ctx : contexts) {
    threads.emplace_back([&ctx]() { ctx.run(); });
}
```

**è´Ÿè½½å‡è¡¡ç­–ç•¥**ï¼š
1. **è½®è¯¢åˆ†é…**ï¼ˆRound-Robinï¼‰ï¼šç®€å•å‡åŒ€
2. **æœ€å°è´Ÿè½½**ï¼ˆLeast-Loadedï¼‰ï¼šåŠ¨æ€ä¼˜åŒ–

**å½“å‰å®ç°**ï¼šä¸¤ç§ç­–ç•¥éƒ½æ”¯æŒ

#### 2.2.3 åˆ†å±‚è§£è€¦

**å±‚æ¬¡èŒè´£**ï¼š

| å±‚æ¬¡ | èŒè´£ | ä¾èµ–æ–¹å‘ |
|------|------|---------|
| åº”ç”¨å±‚ | ç”¨æˆ·äº¤äº’ã€ä¸šåŠ¡ç¼–æ’ | â†’ ä¸šåŠ¡å±‚ |
| ä¸šåŠ¡å±‚ | åè®®å®ç°ã€çŠ¶æ€ç®¡ç† | â†’ ç½‘ç»œå±‚ |
| ç½‘ç»œå±‚ | è¿æ¥ç®¡ç†ã€æ•°æ®ä¼ è¾“ | â†’ åŸºç¡€å±‚ |
| åŸºç¡€å±‚ | äº‹ä»¶å¾ªç¯ã€é€šç”¨å·¥å…· | â†’ Asio |

**è§£è€¦æœºåˆ¶**ï¼š
- æ¥å£æŠ½è±¡ï¼ˆIProtocolHandlerï¼‰
- ä¾èµ–æ³¨å…¥ï¼ˆæ„é€ å‡½æ•°æ³¨å…¥ï¼‰
- äº‹ä»¶é€šçŸ¥ï¼ˆObserver æ¨¡å¼ï¼‰

### 2.3 å…³é”®æ¶æ„å†³ç­–

#### å†³ç­– 1ï¼šEventLoopManager çš„å®šä½

**é—®é¢˜**ï¼šEventLoopManager åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ
- é€‰é¡¹ Aï¼šç®€å•çš„ io_context æ± ç®¡ç†å™¨
- é€‰é¡¹ Bï¼šå¸¦ä¼˜å…ˆçº§çš„äº‹ä»¶å¾ªç¯æ¡†æ¶

**å½“å‰é€‰æ‹©**ï¼šé€‰é¡¹ Aï¼ˆç®€å•ç®¡ç†å™¨ï¼‰

**ç†ç”±**ï¼š
1. Asio å·²ç»æ˜¯æˆç†Ÿçš„äº‹ä»¶å¾ªç¯æ¡†æ¶
2. èŒè´£å•ä¸€ï¼šç®¡ç†çº¿ç¨‹æ± å’Œè´Ÿè½½å‡è¡¡
3. ä¼˜å…ˆçº§ç”± TaskScheduler è´Ÿè´£ï¼ˆåˆ†å±‚æ¸…æ™°ï¼‰

**ä»£ç ä½“ç°**ï¼š
```cpp
class EventLoopManager {
    // åªè´Ÿè´£ç®¡ç† io_context æ± 
    std::vector<std::unique_ptr<ThreadContext>> thread_contexts_;
    
    // æä¾›è´Ÿè½½å‡è¡¡æ¥å£
    asio::io_context& get_least_loaded_context();
};
```

#### å†³ç­– 2ï¼šTaskScheduler ä¸ EventLoopManager çš„åä½œ

**è®¾è®¡æ¨¡å¼**ï¼šåˆ†å±‚åä½œ

```
TaskSchedulerï¼ˆä¼˜å…ˆçº§è°ƒåº¦ï¼‰
    â†“ è°ƒç”¨
EventLoopManagerï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
    â†“ æŠ•é€’
io_contextï¼ˆäº‹ä»¶å¾ªç¯ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… èŒè´£æ¸…æ™°ï¼šè°ƒåº¦ vs æ‰§è¡Œ
- âœ… æ˜“äºæµ‹è¯•ï¼šå¯ç‹¬ç«‹æµ‹è¯•
- âœ… çµæ´»æ‰©å±•ï¼šå¯æ›¿æ¢è°ƒåº¦ç­–ç•¥

**ä»£ç ä½“ç°**ï¼š
```cpp
void TaskScheduler::scheduler_thread_func() {
    // ä»ä¼˜å…ˆçº§é˜Ÿåˆ—å–ä»»åŠ¡
    auto task = task_queue_.top();
    
    // æäº¤ç»™ EventLoopManager æ‰§è¡Œ
    loop_manager_.post_to_least_loaded([task]() {
        task->execute();
    });
}
```

#### å†³ç­– 3ï¼šæ˜¯å¦éœ€è¦äº‹ä»¶å‘å¸ƒ-è®¢é˜…ç³»ç»Ÿ

**å½“å‰çŠ¶æ€**ï¼šæœªå®ç°

**åˆ†æ**ï¼š
- **é˜¶æ®µ 1-3ï¼ˆMVPï¼‰**ï¼šä¸éœ€è¦ï¼Œç›´æ¥å›è°ƒå³å¯
- **é˜¶æ®µ 4+ï¼ˆä¼˜åŒ–ï¼‰**ï¼šå¯é€‰ï¼Œç”¨äºæ¨¡å—è§£è€¦

**å¦‚æœå®ç°ï¼Œæ¶æ„ä¼šå˜æˆ**ï¼š
```
æ¨¡å— A â†’ EventBus.publish(Event)
                â†“
æ¨¡å— B â† EventBus.subscribe<Event>()
```

**å»ºè®®**ï¼šæš‚ä¸å®ç°ï¼Œä¿æŒç®€å•

---

## 3. æ ¸å¿ƒæ¨¡å—å®ç°ç°çŠ¶

### 3.1 å·²å®ç°æ¨¡å—

#### 3.1.1 EventLoopManager âœ…

**å®ç°å®Œæˆåº¦**ï¼š100%

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… å¤šçº¿ç¨‹ io_context æ± ç®¡ç†
- âœ… è½®è¯¢å’Œæœ€å°è´Ÿè½½ä¸¤ç§åˆ†é…ç­–ç•¥
- âœ… ä¼˜é›…å¯åŠ¨å’Œåœæ­¢
- âœ… å®æ—¶ç»Ÿè®¡ä¿¡æ¯

**ä»£ç è´¨é‡**ï¼š
- âœ… RAII èµ„æºç®¡ç†
- âœ… çº¿ç¨‹å®‰å…¨ï¼ˆåŸå­æ“ä½œï¼‰
- âœ… å¼‚å¸¸å®‰å…¨
- âœ… è¯¦ç»†æ³¨é‡Š

**å…³é”®å®ç°ç»†èŠ‚**ï¼š
```cpp
// ThreadContext çš„ RAII è®¾è®¡
struct ThreadContext {
    std::unique_ptr<asio::io_context> io_context;
    std::unique_ptr<work_guard> work_guard;  // é˜²æ­¢ io_context é€€å‡º
    std::unique_ptr<std::thread> thread;
    
    ~ThreadContext() {
        // æ­£ç¡®çš„é”€æ¯é¡ºåºï¼šwork_guard â†’ thread â†’ io_context
        work_guard.reset();
        if (thread && thread->joinable()) thread->join();
    }
};
```

**æ€§èƒ½ç‰¹æ€§**ï¼š
- è´Ÿè½½å‡è¡¡ï¼šO(N) æŸ¥æ‰¾æœ€å°è´Ÿè½½
- ä»»åŠ¡æŠ•é€’ï¼šO(1) åŸå­æ“ä½œ
- å†…å­˜å ç”¨ï¼šæ¯çº¿ç¨‹çº¦ 1MB

#### 3.1.2 TaskScheduler âš ï¸

**å®ç°å®Œæˆåº¦**ï¼š80%ï¼ˆå¤´æ–‡ä»¶å®Œæ•´ï¼Œcpp å¾…å®ç°ï¼‰

**è®¾è®¡äº®ç‚¹**ï¼š
- âœ… å››çº§ä¼˜å…ˆçº§ï¼ˆCRITICAL > HIGH > NORMAL > LOWï¼‰
- âœ… å»¶è¿Ÿä»»åŠ¡ï¼ˆåŸºäº asio::steady_timerï¼‰
- âœ… å‘¨æœŸæ€§ä»»åŠ¡
- âœ… ä»»åŠ¡å–æ¶ˆæœºåˆ¶

**å¾…å®ç°éƒ¨åˆ†**ï¼š
- â³ task_scheduler.cpp å®ç°
- â³ è€åŒ–æœºåˆ¶ï¼ˆé˜²æ­¢é¥¥é¥¿ï¼‰
- â³ ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

**è®¾è®¡æ¨¡å¼åº”ç”¨**ï¼š
```cpp
// ä¼˜å…ˆçº§é˜Ÿåˆ— + æ¯”è¾ƒå™¨
std::priority_queue<
    std::shared_ptr<Task>,
    std::vector<std::shared_ptr<Task>>,
    TaskComparator  // é«˜ä¼˜å…ˆçº§åœ¨å‰
> task_queue_;
```

#### 3.1.3 Logger âš ï¸

**å®ç°å®Œæˆåº¦**ï¼š60%ï¼ˆå¤´æ–‡ä»¶å®Œæ•´ï¼Œcpp å¾…å®ç°ï¼‰

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- âœ… å¼‚æ­¥æ—¥å¿—é˜Ÿåˆ—
- âœ… å¤šçº§åˆ«æ—¥å¿—
- âœ… æ–‡ä»¶è½®è½¬æ”¯æŒ
- âœ… æ ¼å¼åŒ–è¾“å‡ºï¼ˆæ¨¡æ¿å®ç°ï¼‰

**å¾…å®ç°éƒ¨åˆ†**ï¼š
- â³ logger.cpp å®ç°
- â³ æ–‡ä»¶è½®è½¬é€»è¾‘
- â³ æ‰¹é‡å†™å…¥ä¼˜åŒ–

**æ€§èƒ½è®¾è®¡**ï¼š
```cpp
// å¼‚æ­¥é˜Ÿåˆ— + ä¸“ç”¨å†™å…¥çº¿ç¨‹
std::queue<LogEntry> log_queue_;
std::thread writer_thread_;

// æ‰¹é‡å†™å…¥ä¼˜åŒ–
static constexpr size_t BATCH_SIZE = 100;
```

### 3.2 æœªå®ç°æ¨¡å—

#### 3.2.1 Config ç³»ç»Ÿ âŒ

**ä¼˜å…ˆçº§**ï¼šé«˜ï¼ˆé˜¶æ®µ 1 éœ€è¦ï¼‰

**è®¾è®¡å»ºè®®**ï¼š
```cpp
class Config {
    // ä½¿ç”¨ std::variant æ”¯æŒå¤šç±»å‹
    using ConfigValue = std::variant<std::string, int, double, bool>;
    
    // è¯»å†™é”æ”¯æŒå¹¶å‘
    mutable std::shared_mutex config_mutex_;
    std::unordered_map<std::string, ConfigValue> config_data_;
};
```

#### 3.2.2 MagnetUriParser âŒ

**ä¼˜å…ˆçº§**ï¼šé«˜ï¼ˆé˜¶æ®µ 2 éœ€è¦ï¼‰

**å®ç°è¦ç‚¹**ï¼š
- URL è§£ç 
- å‚æ•°æå–ï¼ˆxt, dn, tr, xlï¼‰
- é”™è¯¯å¤„ç†

#### 3.2.3 DHT å®¢æˆ·ç«¯ âŒ

**ä¼˜å…ˆçº§**ï¼šä¸­ï¼ˆé˜¶æ®µ 3-4ï¼‰

**å¤æ‚åº¦**ï¼šé«˜

**å…³é”®ç®—æ³•**ï¼š
- Kademlia è·¯ç”±è¡¨
- XOR è·ç¦»è®¡ç®—
- K-bucket ç®¡ç†

---

## 4. æŠ€æœ¯é€‰å‹åˆ†æ

### 4.1 ä¸ºä»€ä¹ˆé€‰æ‹© Asio Standaloneï¼Ÿ

**å¯¹æ¯”åˆ†æ**ï¼š

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **Asio Standalone** | âœ… æ—  Boost ä¾èµ–<br>âœ… è½»é‡çº§<br>âœ… ç°ä»£ C++ | âš ï¸ åŠŸèƒ½ç›¸å¯¹å°‘ | å­¦ä¹ é¡¹ç›®ã€è½»é‡åº”ç”¨ |
| Boost.Asio | âœ… åŠŸèƒ½å…¨é¢<br>âœ… ç”Ÿæ€ä¸°å¯Œ | âŒ ä¾èµ–åºå¤§<br>âŒ ç¼–è¯‘æ…¢ | ä¼ä¸šé¡¹ç›® |
| libuv | âœ… è·¨å¹³å°<br>âœ… C æ¥å£ | âŒ é C++ é£æ ¼ | Node.js é£æ ¼é¡¹ç›® |

**å½“å‰é€‰æ‹©**ï¼šAsio Standalone âœ…

**ç†ç”±**ï¼š
1. å­¦ä¹ é¡¹ç›®ï¼Œé¿å… Boost ä¾èµ–
2. Header-onlyï¼Œé›†æˆç®€å•
3. ç°ä»£ C++ é£æ ¼
4. åŠŸèƒ½è¶³å¤Ÿï¼ˆTCP/UDP/Timerï¼‰

### 4.2 C++17 vs C++20

**å½“å‰é€‰æ‹©**ï¼šC++17ï¼ˆé¢„ç•™ C++20 æ‰©å±•ï¼‰

**C++17 ç‰¹æ€§åº”ç”¨**ï¼š
- âœ… `std::optional` - å¯é€‰å€¼
- âœ… `std::variant` - ç±»å‹å®‰å…¨è”åˆä½“
- âœ… `std::string_view` - é›¶æ‹·è´å­—ç¬¦ä¸²
- âœ… Structured bindings - è§£æ„èµ‹å€¼
- âœ… `std::filesystem` - æ–‡ä»¶æ“ä½œ

**C++20 é¢„ç•™**ï¼š
- ğŸ”® Coroutines - ç®€åŒ–å¼‚æ­¥ä»£ç 
- ğŸ”® Concepts - ç±»å‹çº¦æŸ
- ğŸ”® Ranges - å‡½æ•°å¼ç¼–ç¨‹

**åç¨‹æ‰©å±•ç¤ºä¾‹**ï¼š
```cpp
// æœªæ¥å¯ä»¥è¿™æ ·å†™
Task<std::vector<Peer>> findPeers(InfoHash hash) {
    auto nodes = co_await queryDHT(hash);
    co_return extractPeers(nodes);
}
```

### 4.3 æ„å»ºç³»ç»Ÿï¼šCMake

**é…ç½®ç‰¹ç‚¹**ï¼š
```cmake
# æ¨¡å—åŒ–æ„å»º
option(BUILD_EXPERIMENTS "Build Asio experiments" ON)
option(BUILD_MAIN_PROJECT "Build main project" ON)
option(BUILD_TESTS "Build tests" ON)

# Asio é›†æˆ
add_library(asio INTERFACE)
target_compile_definitions(asio INTERFACE ASIO_STANDALONE)
```

**ä¼˜åŠ¿**ï¼š
- âœ… è·¨å¹³å°
- âœ… æ¨¡å—åŒ–
- âœ… æ˜“äºæ‰©å±•

---

## 5. è®¾è®¡æ¨¡å¼åº”ç”¨

### 5.1 åˆ›å»ºå‹æ¨¡å¼

#### Singletonï¼ˆå•ä¾‹ï¼‰

**åº”ç”¨åœºæ™¯**ï¼šLogger, Config

```cpp
class Logger {
public:
    static Logger& instance() {
        static Logger instance;  // C++11 çº¿ç¨‹å®‰å…¨
        return instance;
    }
private:
    Logger() = default;
};
```

**ä¼˜åŠ¿**ï¼šå…¨å±€è®¿é—®ç‚¹  
**é£é™©**ï¼šå…¨å±€çŠ¶æ€ï¼Œæµ‹è¯•å›°éš¾  
**ç¼“è§£**ï¼šæä¾›ä¾èµ–æ³¨å…¥æ¥å£

#### Factoryï¼ˆå·¥å‚ï¼‰

**æœªæ¥åº”ç”¨**ï¼šåè®®å¤„ç†å™¨åˆ›å»º

```cpp
class ProtocolHandlerFactory {
public:
    static std::unique_ptr<IProtocolHandler> 
    create(const std::string& uri) {
        if (uri.starts_with("magnet:"))
            return std::make_unique<MagnetHandler>();
        // ...
    }
};
```

### 5.2 ç»“æ„å‹æ¨¡å¼

#### Adapterï¼ˆé€‚é…å™¨ï¼‰

**æœªæ¥åº”ç”¨**ï¼šç»Ÿä¸€ä¸åŒåè®®æ¥å£

```cpp
class IProtocolHandler {
public:
    virtual void start_download(const std::string& uri) = 0;
    virtual DownloadStatus get_status() const = 0;
};

class MagnetAdapter : public IProtocolHandler { /*...*/ };
class TorrentAdapter : public IProtocolHandler { /*...*/ };
```

### 5.3 è¡Œä¸ºå‹æ¨¡å¼

#### Observerï¼ˆè§‚å¯Ÿè€…ï¼‰

**æœªæ¥åº”ç”¨**ï¼šä¸‹è½½è¿›åº¦é€šçŸ¥

```cpp
class DownloadObserver {
public:
    virtual void onProgress(float percentage) = 0;
    virtual void onComplete() = 0;
    virtual void onError(const std::string& msg) = 0;
};
```

#### Strategyï¼ˆç­–ç•¥ï¼‰

**åº”ç”¨åœºæ™¯**ï¼šåˆ†ç‰‡é€‰æ‹©ç­–ç•¥

```cpp
class PieceSelectionStrategy {
public:
    virtual size_t selectPiece(const Bitfield& available) = 0;
};

class SequentialStrategy : public PieceSelectionStrategy { /*...*/ };
class RarestFirstStrategy : public PieceSelectionStrategy { /*...*/ };
```

#### Stateï¼ˆçŠ¶æ€æœºï¼‰

**åº”ç”¨åœºæ™¯**ï¼šPeer è¿æ¥çŠ¶æ€

```cpp
enum class PeerState {
    DISCONNECTED,
    CONNECTING,
    HANDSHAKING,
    CONNECTED,
    DOWNLOADING
};

// ä½¿ç”¨ std::variant å®ç°ç±»å‹å®‰å…¨çš„çŠ¶æ€æœº
using PeerStateVariant = std::variant<
    Disconnected, Connecting, Handshaking, 
    Connected, Downloading
>;
```

---

## 6. æ€§èƒ½ä¸æ‰©å±•æ€§

### 6.1 æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰çŠ¶æ€ |
|------|--------|---------|
| å¹¶å‘è¿æ¥æ•° | 100-300 | æœªæµ‹è¯• |
| å†…å­˜å ç”¨ | < 1MB/è¿æ¥ | æœªæµ‹è¯• |
| CPU åˆ©ç”¨ç‡ | < 80%/æ ¸ | æœªæµ‹è¯• |
| ç½‘ç»œåå | æ¥è¿‘å¸¦å®½ | æœªæµ‹è¯• |
| å“åº”æ—¶é—´ | < 100ms | æœªæµ‹è¯• |

### 6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 6.2.1 é›¶æ‹·è´

**åº”ç”¨åœºæ™¯**ï¼š
- `std::string_view` - å­—ç¬¦ä¸²è§£æ
- `std::span` - å†…å­˜è§†å›¾
- ç§»åŠ¨è¯­ä¹‰ - é¿å…æ‹·è´

```cpp
// é›¶æ‹·è´å­—ç¬¦ä¸²å¤„ç†
void parseMagnet(std::string_view uri) {
    // ä¸æ‹·è´åŸå§‹å­—ç¬¦ä¸²
}
```

#### 6.2.2 å†…å­˜æ± 

**æœªæ¥ä¼˜åŒ–**ï¼š
```cpp
class MemoryPool {
    // é¢„åˆ†é…å›ºå®šå¤§å°çš„å†…å­˜å—
    // å‡å°‘é¢‘ç¹çš„ new/delete
};
```

#### 6.2.3 æ‰¹é‡æ“ä½œ

**åº”ç”¨åœºæ™¯**ï¼š
- æ—¥å¿—æ‰¹é‡å†™å…¥
- ç½‘ç»œæ‰¹é‡å‘é€
- ç£ç›˜æ‰¹é‡åˆ·æ–°

```cpp
// Logger æ‰¹é‡å†™å…¥
static constexpr size_t BATCH_SIZE = 100;
std::vector<LogEntry> batch;
batch.reserve(BATCH_SIZE);
```

### 6.3 æ‰©å±•æ€§è®¾è®¡

#### 6.3.1 åè®®æ‰©å±•

**æ’ä»¶æœºåˆ¶**ï¼š
```cpp
// æ³¨å†Œæ–°åè®®
ProtocolRegistry::register("http", 
    std::make_unique<HttpProtocolHandler>());

// è‡ªåŠ¨é€‰æ‹©åè®®
auto handler = ProtocolRegistry::create(uri);
handler->start_download(uri);
```

#### 6.3.2 å­˜å‚¨åç«¯æ‰©å±•

**æŠ½è±¡æ¥å£**ï¼š
```cpp
class IStorageBackend {
public:
    virtual void writePiece(size_t index, std::span<byte> data) = 0;
    virtual std::vector<byte> readPiece(size_t index) = 0;
};

class LocalFileStorage : public IStorageBackend { /*...*/ };
class CloudStorage : public IStorageBackend { /*...*/ };
```

---

## 7. å½“å‰é—®é¢˜ä¸æ”¹è¿›å»ºè®®

### 7.1 ä»£ç å®ç°é—®é¢˜

#### é—®é¢˜ 1ï¼šç¼ºå°‘ types.h

**ç°è±¡**ï¼štask_scheduler.h å¼•ç”¨äº†ä¸å­˜åœ¨çš„ types.h

**å½±å“**ï¼šç¼–è¯‘å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```cpp
// åˆ›å»º include/magnet/async/types.h
namespace magnet::async {
    using TaskFunction = std::function<void()>;
    using TaskId = uint64_t;
    
    enum class TaskPriority {
        LOW = 0,
        NORMAL = 1,
        HIGH = 2,
        CRITICAL = 3
    };
}
```

#### é—®é¢˜ 2ï¼šLogger å’Œ TaskScheduler çš„ cpp æœªå®ç°

**ä¼˜å…ˆçº§**ï¼šé«˜

**å»ºè®®**ï¼šæŒ‰ç…§ PHASE1_IMPLEMENTATION_GUIDE.md çš„æŒ‡å¯¼å®ç°

#### é—®é¢˜ 3ï¼šç¼ºå°‘é›†æˆæµ‹è¯•

**å»ºè®®**ï¼šå®ç° hello_magnet_downloader.cpp

### 7.2 æ¶æ„è®¾è®¡é—®é¢˜

#### é—®é¢˜ 1ï¼šæ˜¯å¦éœ€è¦äº‹ä»¶ç³»ç»Ÿï¼Ÿ

**å½“å‰çŠ¶æ€**ï¼šæœªå®ç°

**åˆ†æ**ï¼š
- **çŸ­æœŸ**ï¼šä¸éœ€è¦ï¼Œä¿æŒç®€å•
- **é•¿æœŸ**ï¼šå¯é€‰ï¼Œç”¨äºæ¨¡å—è§£è€¦

**å»ºè®®**ï¼šé˜¶æ®µ 5+ å†è€ƒè™‘

#### é—®é¢˜ 2ï¼šé”™è¯¯å¤„ç†ç­–ç•¥ä¸å¤Ÿæ˜ç¡®

**å½“å‰çŠ¶æ€**ï¼šä½¿ç”¨å¼‚å¸¸ + std::optional

**å»ºè®®**ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
```cpp
// ä½¿ç”¨ Result ç±»å‹
template<typename T, typename E = std::error_code>
class Result {
    std::variant<T, E> value_;
public:
    bool isOk() const;
    T& value();
    E& error();
};
```

### 7.3 æ–‡æ¡£é—®é¢˜

#### é—®é¢˜ 1ï¼šæ–‡æ¡£è¿‡äºè¯¦ç»†ï¼Œå¯èƒ½è¿‡åº¦è®¾è®¡

**å»ºè®®**ï¼š
- ä¿ç•™é«˜å±‚è®¾è®¡æ–‡æ¡£
- ç®€åŒ–å®ç°ç»†èŠ‚æ–‡æ¡£
- å¼ºè°ƒ MVP åŸåˆ™

#### é—®é¢˜ 2ï¼šç¼ºå°‘å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

**å»ºè®®**ï¼šåˆ›å»º QUICKSTART.md

---

## 8. å®æ–½è·¯çº¿å›¾è¯„ä¼°

### 8.1 é˜¶æ®µåˆ’åˆ†åˆç†æ€§

**è¯„ä¼°**ï¼šâœ… åˆç†

**ç†ç”±**ï¼š
1. æ¸è¿›å¼å¼€å‘ï¼Œæ¯é˜¶æ®µæœ‰äº§å‡º
2. ä»ç®€å•åˆ°å¤æ‚ï¼Œç¬¦åˆå­¦ä¹ æ›²çº¿
3. å…³é”®é‡Œç¨‹ç¢‘æ¸…æ™°

### 8.2 æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | è®¡åˆ’æ—¶é—´ | è¯„ä¼° | å»ºè®® |
|------|---------|------|------|
| é˜¶æ®µ 0 | 1-2 å¤© | âœ… åˆç† | å·²å®Œæˆ |
| é˜¶æ®µ 1 | 3-5 å¤© | âš ï¸ åç´§ | å»ºè®® 5-7 å¤© |
| é˜¶æ®µ 2 | 2-3 å¤© | âœ… åˆç† | - |
| é˜¶æ®µ 3 | 4-6 å¤© | âš ï¸ åç´§ | å»ºè®® 6-8 å¤© |
| é˜¶æ®µ 4 | 5-7 å¤© | âš ï¸ åç´§ | å»ºè®® 7-10 å¤© |

**æ€»ä½“è¯„ä¼°**ï¼šæ—¶é—´ä¼°ç®—ç•¥æ˜¾ä¹è§‚ï¼Œå»ºè®®å¢åŠ  20-30% ç¼“å†²

### 8.3 é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| DHT åè®®å¤æ‚ | é«˜ | é«˜ | ç®€åŒ–å®ç°ï¼Œå‚è€ƒå¼€æºé¡¹ç›® |
| æ€§èƒ½ä¸è¾¾æ ‡ | ä¸­ | ä¸­ | åˆ†é˜¶æ®µä¼˜åŒ–ï¼Œå…ˆåŠŸèƒ½åæ€§èƒ½ |
| æ—¶é—´è¶…æœŸ | é«˜ | ä½ | MVP åŸåˆ™ï¼Œç æ‰éæ ¸å¿ƒåŠŸèƒ½ |
| è°ƒè¯•å›°éš¾ | ä¸­ | ä¸­ | å®Œå–„æ—¥å¿—ç³»ç»Ÿï¼Œä½¿ç”¨ Wireshark |

---

## 9. æ€»ç»“ä¸å»ºè®®

### 9.1 æ¶æ„ä¼˜åŠ¿

âœ… **è®¾è®¡æ¸…æ™°**ï¼šåˆ†å±‚æ˜ç¡®ï¼ŒèŒè´£å•ä¸€  
âœ… **æŠ€æœ¯é€‰å‹åˆç†**ï¼šAsio + C++17ï¼Œé€‚åˆå­¦ä¹   
âœ… **æ‰©å±•æ€§å¥½**ï¼šæ’ä»¶æœºåˆ¶ï¼Œæ˜“äºæ·»åŠ æ–°åè®®  
âœ… **æ–‡æ¡£å®Œå–„**ï¼šè®¾è®¡æ–‡æ¡£ã€å®ç°æŒ‡å—é½å…¨  

### 9.2 å½“å‰çŸ­æ¿

âš ï¸ **å®ç°è¿›åº¦**ï¼šæ ¸å¿ƒæ¨¡å—æœªå®Œæˆï¼ˆLogger, TaskSchedulerï¼‰  
âš ï¸ **æµ‹è¯•ç¼ºå¤±**ï¼šæ²¡æœ‰å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•  
âš ï¸ **æ€§èƒ½æœªéªŒè¯**ï¼šæ€§èƒ½ç›®æ ‡æœªç»æµ‹è¯•  

### 9.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³è¡ŒåŠ¨**ï¼ˆæœ¬å‘¨ï¼‰ï¼š
1. âœ… åˆ›å»º types.h
2. âœ… å®ç° Logger.cpp
3. âœ… å®ç° TaskScheduler.cpp
4. âœ… å®ç° Config ç³»ç»Ÿ
5. âœ… ç¼–å†™é›†æˆæµ‹è¯•

**çŸ­æœŸç›®æ ‡**ï¼ˆ2 å‘¨å†…ï¼‰ï¼š
1. å®Œæˆé˜¶æ®µ 1 æ‰€æœ‰æ¨¡å—
2. é€šè¿‡é›†æˆæµ‹è¯•
3. å¼€å§‹é˜¶æ®µ 2ï¼ˆç£åŠ›é“¾æ¥è§£æï¼‰

**ä¸­æœŸç›®æ ‡**ï¼ˆ1 ä¸ªæœˆå†…ï¼‰ï¼š
1. å®Œæˆé˜¶æ®µ 2-3
2. å®ç°åŸºæœ¬çš„ DHT æŸ¥è¯¢
3. èƒ½å¤Ÿå‘ç° Peer

**é•¿æœŸç›®æ ‡**ï¼ˆ2-3 ä¸ªæœˆï¼‰ï¼š
1. å®Œæˆå®Œæ•´ä¸‹è½½åŠŸèƒ½
2. æ€§èƒ½ä¼˜åŒ–
3. è€ƒè™‘ GUI

### 9.4 å…³é”®å»ºè®®

1. **ä¿æŒç®€å•**ï¼šä¸è¦è¿‡åº¦è®¾è®¡ï¼Œå…ˆå®ç° MVP
2. **æµ‹è¯•é©±åŠ¨**ï¼šæ¯ä¸ªæ¨¡å—éƒ½è¦æœ‰æµ‹è¯•
3. **æ¸è¿›ä¼˜åŒ–**ï¼šå…ˆåŠŸèƒ½æ­£ç¡®ï¼Œå†è€ƒè™‘æ€§èƒ½
4. **æ–‡æ¡£åŒæ­¥**ï¼šä»£ç å’Œæ–‡æ¡£ä¿æŒä¸€è‡´
5. **å®šæœŸå›é¡¾**ï¼šæ¯ä¸ªé˜¶æ®µç»“æŸåæ€»ç»“ç»éªŒ

---

## é™„å½•

### A. å…³é”®ä»£ç ç‰‡æ®µ

#### EventLoopManager æ ¸å¿ƒé€»è¾‘
```cpp
void EventLoopManager::post_to_least_loaded(Handler&& handler) {
    size_t index = select_least_loaded_context();
    auto& context = thread_contexts_[index];
    
    context->task_count.fetch_add(1);
    asio::post(*context->io_context, [handler, &context]() {
        handler();
        context->task_count.fetch_sub(1);
        context->total_handled.fetch_add(1);
    });
}
```

#### TaskScheduler ä¼˜å…ˆçº§é˜Ÿåˆ—
```cpp
struct TaskComparator {
    bool operator()(const Task& a, const Task& b) const {
        return a.priority() < b.priority();  // é«˜ä¼˜å…ˆçº§åœ¨å‰
    }
};

std::priority_queue<Task, std::vector<Task>, TaskComparator> queue_;
```

### B. å‚è€ƒèµ„æº

- [Asio å®˜æ–¹æ–‡æ¡£](https://think-async.com/Asio/)
- [BitTorrent åè®®è§„èŒƒ](http://www.bittorrent.org/beps/bep_0003.html)
- [Kademlia DHT è®ºæ–‡](https://pdos.csail.mit.edu/~petar/papers/maymounkov-kademlia-lncs.pdf)
- [ç°ä»£ C++ æœ€ä½³å®è·µ](https://github.com/cpp-best-practices/cppbestpractices)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024-12-26  
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
