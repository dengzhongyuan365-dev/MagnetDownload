# MagnetDownload 项目架构设计文档

## 1. 项目概述

### 1.1 项目目标
MagnetDownload 是一个基于 C++17/20 开发的高性能、可扩展的磁力链接下载器。项目采用独立版 Asio 库进行网络编程，注重架构的扩展性、健壮性和高性能，作为学习现代 C++ 设计模式和高性能网络编程的实践项目。

### 1.2 核心特性
- **高性能**: 多线程事件循环池，充分利用多核CPU
- **健壮性**: 分层错误处理，资源自动管理，异常安全
- **扩展性**: 模块化设计，协议插件机制，便于添加新协议支持
- **现代化**: 应用C++17/20特性，设计模式，预留协程扩展

## 2. 总体架构设计

### 2.1 架构理念
```
事件驱动 + 多线程 + 模块化 + 分层设计
```

### 2.2 架构模式选择
- **Reactor模式**: 基于Asio的事件循环，处理I/O多路复用
- **Producer-Consumer模式**: 任务调度和优先级管理
- **Observer模式**: 事件通知和状态传播
- **Strategy模式**: 协议处理和算法策略
- **Factory模式**: 组件创建和协议适配器

### 2.3 分层架构
```
┌─────────────────────────────────────────┐
│              应用层 (Application)         │
│           用户接口 + 下载管理             │
├─────────────────────────────────────────┤
│              业务层 (Business)           │
│        协议处理 + 任务调度 + 状态管理      │
├─────────────────────────────────────────┤
│              网络层 (Network)            │
│        连接管理 + 数据传输 + DHT网络       │
├─────────────────────────────────────────┤
│              基础层 (Foundation)          │
│        事件循环 + 内存管理 + 日志系统      │
└─────────────────────────────────────────┘
```

## 3. 核心模块设计

### 3.1 事件循环管理器 (EventLoopManager)

#### 3.1.1 设计思路
- **多线程事件循环池**: 创建N个io_context，N = std::thread::hardware_concurrency()
- **负载均衡**: 轮询分配连接到不同的io_context
- **生命周期管理**: 统一管理所有事件循环的启动、停止和资源清理

#### 3.1.2 核心功能
- io_context池管理
- 工作线程生命周期控制
- 任务分发和负载均衡
- 优雅关闭机制

#### 3.1.3 设计要点
```cpp
class EventLoopManager {
    // 事件循环池
    std::vector<std::unique_ptr<asio::io_context>> contexts_;
    // 工作线程池
    std::vector<std::thread> threads_;
    // 工作守护对象
    std::vector<asio::executor_work_guard<asio::io_context::executor_type>> work_guards_;
    // 负载均衡计数器
    std::atomic<size_t> next_context_index_{0};
};
```

### 3.2 任务调度器 (TaskScheduler)

#### 3.2.1 设计思路
- **四级优先队列**: CRITICAL(0) > HIGH(1) > NORMAL(2) > LOW(3)
- **老化机制**: 防止低优先级任务饥饿
- **线程安全**: 无锁队列或适当的同步机制
- **集成Asio**: 与io_context的post机制结合

#### 3.2.2 优先级定义
```cpp
enum class Priority : int {
    CRITICAL = 0,    // 用户交互、紧急错误处理
    HIGH     = 1,    // DHT查询、Peer连接建立
    NORMAL   = 2,    // 数据传输、文件写入
    LOW      = 3     // 统计收集、日志记录、清理任务
};
```

#### 3.2.3 核心功能
- 优先级任务队列管理
- 任务老化时间跟踪
- 调度策略实现
- 与事件循环集成

### 3.3 磁力链接解析器 (MagnetUriParser)

#### 3.3.1 设计思路
- **URI标准解析**: 支持标准magnet URI格式
- **参数提取**: info_hash、dn、tr、xl等关键参数
- **错误处理**: 优雅处理格式错误的URI
- **扩展性**: 易于添加新的参数支持

#### 3.3.2 核心功能
- 磁力链接格式验证
- 参数解析和提取
- 哈希值处理和验证
- Tracker列表解析

#### 3.3.3 数据结构
```cpp
struct MagnetInfo {
    std::array<uint8_t, 20> info_hash;    // SHA-1哈希
    std::string display_name;             // 显示名称
    std::vector<std::string> trackers;    // Tracker列表
    std::optional<uint64_t> length;       // 文件大小
    std::map<std::string, std::string> additional_params;
};
```

### 3.4 DHT客户端 (DHTClient)

#### 3.4.1 设计思路
- **Kademlia协议**: 实现标准的DHT网络协议
- **路由表管理**: K-bucket算法维护节点路由表
- **Peer发现**: 通过DHT网络查找资源节点
- **自适应网络**: 动态适应网络变化

#### 3.4.2 核心功能
- DHT网络引导
- 节点路由表维护
- Peer查找和发现
- 网络状态监控

#### 3.4.3 关键算法
- 节点距离计算 (XOR距离)
- K-bucket分割和合并
- 查询优化和并发控制
- 超时重试机制

### 3.5 Peer连接管理器 (PeerManager)

#### 3.5.1 设计思路
- **连接池管理**: 维护活跃连接的生命周期
- **BitTorrent协议**: 实现标准的peer wire protocol
- **并发下载**: 支持多peer并发数据传输
- **连接质量评估**: 根据速度和稳定性评估连接质量

#### 3.5.2 核心功能
- Peer连接建立和维护
- BitTorrent协议消息处理
- 数据块请求和接收
- 连接状态监控

#### 3.5.3 状态机设计
```cpp



enum class PeerState {
    CONNECTING,     // 正在连接
    HANDSHAKING,    // 握手中
    CONNECTED,      // 已连接
    DOWNLOADING,    // 下载中
    DISCONNECTED    // 已断开
};
```

### 3.6 数据管理器 (DataManager)

#### 3.6.1 设计思路
- **分片管理**: 按torrent协议管理文件分片
- **数据验证**: SHA-1哈希验证数据完整性
- **存储优化**: 高效的文件读写和缓存策略
- **断点续传**: 支持下载任务的暂停和恢复

#### 3.6.2 核心功能
- 文件分片映射
- 数据块哈希验证
- 文件系统操作
- 下载进度跟踪

#### 3.6.3 数据结构
```cpp
struct PieceInfo {
    uint32_t index;                       // 分片索引
    uint32_t length;                      // 分片长度
    std::array<uint8_t, 20> hash;        // SHA-1哈希
    std::vector<bool> blocks_received;    // 块接收状态
    bool is_complete;                     // 是否完整
};
```

### 3.7 协议适配器 (ProtocolAdapter)

#### 3.7.1 设计思路
- **统一接口**: 为不同协议提供统一的下载接口
- **插件机制**: 支持动态加载新的协议处理器
- **状态抽象**: 抽象不同协议的状态和操作
- **扩展预留**: 为.torrent、HTTP等协议预留接口

#### 3.7.2 核心接口
```cpp
class IProtocolHandler {
public:
    virtual ~IProtocolHandler() = default;
    virtual void start_download(const std::string& uri) = 0;
    virtual void pause_download() = 0;
    virtual void resume_download() = 0;
    virtual void stop_download() = 0;
    virtual DownloadStatus get_status() const = 0;
    virtual void set_progress_callback(ProgressCallback callback) = 0;
};
```

## 4. 横切关注点设计

### 4.1 错误处理策略

#### 4.1.1 分层错误处理
```
应用层错误 <- 业务层错误 <- 网络层错误 <- 系统层错误
```

#### 4.1.2 错误分类
- **网络错误**: 连接超时、连接断开、DNS解析失败
- **协议错误**: 消息格式错误、协议违规、握手失败
- **数据错误**: 哈希校验失败、文件损坏、磁盘空间不足
- **系统错误**: 内存分配失败、文件权限错误

#### 4.1.3 错误恢复机制
- **重试策略**: 指数退避算法
- **降级处理**: 优雅降级到基本功能
- **错误上报**: 统一错误日志和监控

### 4.2 内存管理策略

#### 4.2.1 智能指针使用
- **shared_ptr**: 管理跨模块共享的对象
- **unique_ptr**: 管理独占所有权的对象
- **weak_ptr**: 打破循环引用
- **enable_shared_from_this**: 在回调中安全传递this

#### 4.2.2 资源管理
- **RAII**: 所有资源都通过RAII管理
- **自定义删除器**: 特殊资源的自定义清理
- **异常安全**: 确保异常情况下资源正确释放

### 4.3 日志系统设计

#### 4.3.1 日志级别
```cpp
enum class LogLevel {
    TRACE,    // 详细跟踪信息
    DEBUG,    // 调试信息
    INFO,     // 一般信息
    WARN,     // 警告信息
    ERROR,    // 错误信息
    FATAL     // 致命错误
};
```

#### 4.3.2 日志特性
- **线程安全**: 支持多线程并发写入
- **高性能**: 异步写入，最小化性能影响
- **灵活配置**: 支持运行时配置调整
- **结构化日志**: 支持JSON格式的结构化日志

### 4.4 配置管理系统

#### 4.4.1 配置层次
```
命令行参数 > 环境变量 > 配置文件 > 默认值
```

#### 4.4.2 配置项设计
- **网络配置**: 端口、连接数、超时时间
- **性能配置**: 线程数、缓存大小、并发度
- **功能配置**: 日志级别、下载路径、协议开关

## 5. 设计模式应用

### 5.1 创建型模式
- **Factory Pattern**: 协议处理器创建
- **Builder Pattern**: 复杂配置对象构建
- **Singleton Pattern**: 全局管理器（谨慎使用）

### 5.2 结构型模式
- **Adapter Pattern**: 协议适配和接口统一
- **Facade Pattern**: 简化复杂子系统接口
- **Proxy Pattern**: 连接代理和资源管理

### 5.3 行为型模式
- **Observer Pattern**: 事件通知和状态更新
- **Strategy Pattern**: 算法策略和协议处理
- **State Pattern**: 连接状态和下载状态管理
- **Command Pattern**: 操作封装和撤销

## 6. 性能设计指标

### 6.1 性能目标
- **并发连接数**: 100-300个Peer连接
- **内存使用**: 每连接 < 1MB
- **CPU利用率**: 充分利用多核，单核占用 < 80%
- **网络吞吐**: 接近带宽限制
- **响应时间**: 用户操作响应 < 100ms

### 6.2 性能优化策略
- **零拷贝**: 尽量减少数据拷贝操作
- **内存池**: 复用频繁分配的对象
- **批量操作**: 减少系统调用次数
- **缓存策略**: 智能缓存热点数据

## 7. 扩展性设计

### 7.1 协议扩展
- **插件接口**: 标准化的协议插件接口
- **动态加载**: 支持运行时加载新协议
- **配置驱动**: 通过配置启用/禁用协议

### 7.2 功能扩展
- **用户界面**: CLI、GUI、Web界面
- **存储后端**: 本地文件、云存储、数据库
- **网络协议**: IPv6、代理、加密传输

### 7.3 平台扩展
- **操作系统**: Linux、Windows、macOS
- **编译器**: GCC、Clang、MSVC
- **架构**: x86、ARM、其他

## 8. 安全性考虑

### 8.1 网络安全
- **输入验证**: 严格验证所有网络输入
- **资源限制**: 防止DoS攻击
- **协议安全**: 实现安全的协议处理

### 8.2 文件系统安全
- **路径验证**: 防止目录遍历攻击
- **权限检查**: 确保适当的文件权限
- **磁盘空间**: 防止磁盘空间耗尽

## 9. 测试策略

### 9.1 测试层次
- **单元测试**: 每个模块的单独测试
- **集成测试**: 模块间协作测试
- **系统测试**: 端到端功能测试
- **性能测试**: 负载和压力测试

### 9.2 测试覆盖
- **代码覆盖率**: 目标 > 80%
- **分支覆盖率**: 目标 > 70%
- **异常路径**: 覆盖所有错误情况

## 10. 部署和运维

### 10.1 构建系统
- **CMake**: 跨平台构建配置
- **依赖管理**: 清晰的依赖声明
- **持续集成**: 自动化构建和测试

### 10.2 监控和诊断
- **性能监控**: 关键指标监控
- **健康检查**: 系统健康状态检查
- **故障诊断**: 详细的错误信息和调试支持

## 11. 实施计划

### 11.1 开发阶段
1. **基础框架**: 事件循环、任务调度、日志系统
2. **网络层**: DHT客户端、Peer连接管理
3. **协议层**: 磁力链接解析、BitTorrent协议
4. **应用层**: 下载管理、用户接口
5. **优化阶段**: 性能调优、错误处理完善

### 11.2 里程碑
- **M1**: 基础框架完成，可运行基本事件循环
- **M2**: DHT网络发现完成，可查找Peer
- **M3**: 基本下载功能完成，可下载简单文件
- **M4**: 完整功能实现，支持复杂下载场景
- **M5**: 性能优化完成，达到设计指标

## 12. 技术风险和应对

### 12.1 技术风险
- **网络复杂性**: DHT和BitTorrent协议复杂
- **并发复杂性**: 多线程和异步编程的复杂性
- **性能挑战**: 高并发和高吞吐的性能要求

### 12.2 应对策略
- **分阶段实现**: 逐步实现复杂功能
- **充分测试**: 全面的测试覆盖
- **性能监控**: 持续的性能监控和优化

---

本架构文档为MagnetDownload项目提供了全面的设计指导，确保项目能够实现高性能、高可扩展性和高健壮性的目标，同时为学习现代C++设计模式和架构技巧提供了良好的实践平台。
