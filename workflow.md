### 2025.3.15
1. 搭建一个大致的技术框架
2. 明确什么是磁力链接下载 p2p
3. 使用的网络库框架 使用boost.aiso作为下载的网络库

4. 使用vcpkg来进行第三方库的包管理

5. 使用cmake来实现工程化组织


6. 先实现命令行的方式，后续考虑接入图形化界面，主要是前期的框架搭建

### 2025.3.17
##### 磁力链接协议熟悉

###### 一. 主要组成部分
1. 协议头： magnet:?标识这是一个磁力链接
2. 主要参数
* xt(Exact Topic):必须参数，使用URN标识资源的哈希值 通常为urn:bith:HASH，其中bith标识BitTorrent info  Hash, HASH是一个40字符的十六进制的SHA-1
* dn(Display Name):可选参数，文件的显示名
* tr (Tracker)：可选参数，Tracker服务器的URL，可以有多个
* xs (Exact Source): 可选参数，指向.torrent文件的直接下载链接
* as (Acceptable Source): 可选参数，代替下载链接
* kt (key word topic)可选参数，关键字列表
* mt (Manifest Topic): 可选参数，指向资源清单的链接
* xl （ExactLength） 可选参数，文件大小

###### 二. 实现磁力链接下载器的关键组件

1. 磁力链接解析器
负责解析磁力链接的字符串，提取infoHash, Tracker URL等

2. Tracker通信
联系Tracker服务器，获取拥有该资源的Peer列表

3. DHT网络查询
除了通过Tracker获取peer，现代客户端还会使用DHT(分布式哈希表)查找peer。需要实现kademlia,这是可选的，但是会提高资源的发现率

4. peer连接管理
一旦有了peer列表，就需要建立链接并交换数据

5. 文件管理
负责管理下载的文件片段，并写入磁盘

6. 下载管理器

整个系统的核心，负责协调其他组件的工作
* 初始化下载任务
* 管理多个peer的链接
* 调度下载策略（先下载那些片段）
* 处理各种bt的协议消息
* 监控下载进度并提供状态更新

###### 三. 下载流程和协调工作
一个完整的磁力链接下载流程如下：
1. 解析磁力链接：提取InfoHash和Tracker URL
2. 发现节点：
   * 通过Tracker获取Peer列表
   * (可选)通过DHT网络查询Peer
3. 连接Peer：
 * 建立TCP连接
 * 进行BitTorrent握手
 * 交换位图(Bitfield)，了解彼此拥有的片段
4. 下载策略：
 * 决定先请求哪些片段（通常使用"最稀有优先"策略）
 * 向多个Peer并行请求不同片段
5. 数据交换：
 * 发送REQUEST消息请求块数据
 * 接收PIECE消息获取数据
 * 验证数据完整性（SHA-1校验）
6. 文件管理：
 * 保存下载的片段数据
 * 将完整片段写入磁盘
7. 下载完成：
 * 验证所有片段完整性
 * 组装最终文件
 * (可选)继续做种，上传给其他Peer


#### 添加了仓库的管理权限，代码审查以及合并规则

#### 测试仓库提交权限

#### 结构化绑定

#### 工程实践

从软件工程管理以及项目推进的角度来看，下载器的实现应该遵循从内到外，从底层到上层的圆测，同时考虑风险管理和价值交付

1. 核心基础设施
这是所有其他组建的基础，提早定义接口有助于后续组建的独立开发和测试

定义所有的核心接口
实现事件系统，日志系统

建立错误处理框架

定义公共数据结构

2. 网络通信层
实现基于asio的网络抽象曾
tcp链接和udp通信封装
网路消息序列化和反序列化框架
核心BitTorrent协议


3。文件存储管理

存储是相对独立的模块，提前完成可以独立测试，并且验证其他模块的输出的必要组件
实现文件的读写，分片管理

sha-1哈希验证

多文件管理

4. bitytorrent wire protocol
协议的和兴，完成之后可以与现有的客户端交互，验证整个系统的关键节点

握手协议的实现
消息编码、解码
对等体链接状态管理
基本消息处理（interested， choke,unchoke, have,bitfile）


##### 第三阶段

5. 片段调度器
下载效率的关键

实现rarest-first算法

片段请求和分配逻辑

性能优化策略

6. 元数据交换（BEP 9）
extension protocol支持
ut_metadata消息处理
元数据的组装和验证

第四阶段： 高级发现功能
7. tracker通信
原因：这是传统的对等体发现机制，实现难度适中，有清洗的协议规范
http Tracker实现
udp tracker实现
tracker响应处理和错误恢复

8. DHT网络实现
Kademlia协议实现
节点发现和维护
DHT查询和响应处理

第五阶段

9. 下载管理器
这是所有组件的控制器，只有在其他组件都可以用的实现才能完全实现

组件协调和生命周期管理
下载状态跟踪和报告
用户命令处理

10. 性能优化和高级特性
带宽管理
快速恢复机制
统计和分析
实时策略的核心原则
垂直切片：每一个夹断都确保实现一个完整的功能切片
例如先实现一个可以连接的那个对等体下载单个文件的简单版本

持续集成和测试
为每个组件建立独立的测试套件
使用mock对象测试组件间的交互
风险前置

在项目的早期就解决网络和协议兼容

迭代开发，每个组件先实现最小可执行功能，然后逐步增强


实现的要求 1. 遵循设计模式以及面向对象开发的一些基本原则

2. 迭代开发，每个组件先实现最小可执行功能，然后逐步增强
3. 垂直切片：每一个阶段都确保实现一个完整的功能切片

┌─────────────────────────────────────────────────────────────────┐
│                          应用层 (UI)                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  命令行界面 (CLI) │  │  控制台UI展示   │  │   进度显示      │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                        下载管理层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   下载管理器    │  │   种子管理器    │  │   对等体管理器  │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                      协议与发现层                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ BitTorrent协议  │  │  Tracker客户端  │  │    DHT客户端    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                        存储层                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   文件管理器    │  │    分片管理器   │  │   数据块管理器  │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                        网络层                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   网络管理器    │  │    TCP连接      │  │    UDP套接字    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                       基础设施层                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   字节缓冲区    │  │    Bencode解析  │  │     SHA1哈希    │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐                       │
│  │    日志系统     │  │    事件系统     │                       │
│  └─────────────────┘  └─────────────────┘                       │
└─────────────────────────────────────────────────────────────────┘

┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  MagnetParser │◄─────┤ DownloadManager│─────►│ TorrentManager│
└───────┬───────┘      └───────┬───────┘      └───────┬───────┘
        │                      │                      │
        │                      │                      │
        │                      ▼                      ▼
┌───────▼───────┐      ┌───────────────┐      ┌───────────────┐
│   InfoHash    │◄─────┤    Torrent    │─────►│  PeerManager  │
└───────────────┘      └───────┬───────┘      └───────┬───────┘
                               │                      │
                               │                      │
                               ▼                      ▼
                       ┌───────────────┐      ┌───────────────┐
                       │ PieceManager  │◄─────┤ PeerConnection│
                       └───────┬───────┘      └───────┬───────┘
                               │                      │
                               │                      │
                               ▼                      ▼
                       ┌───────────────┐      ┌───────────────┐
                       │ FileManager   │      │ MessageHandler│
                       └───────────────┘      └───────────────┘

┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│ TrackerManager│      │  DHTClient    │      │ NetworkManager│
└───────┬───────┘      └───────┬───────┘      └───────┬───────┘
        │                      │                      │
        ▼                      ▼                      │
┌───────────────┐      ┌───────────────┐              │
│ TrackerClient │      │ RoutingTable  │              │
└───────────────┘      └───────────────┘              │
                                                      │
                                                      ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  ByteBuffer   │      │  BencodeParser│      │TCPConnection  │
└───────────────┘      └───────────────┘      └───────────────┘

